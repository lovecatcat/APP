<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<link href="css/form.css" rel="stylesheet" />
		<script src="js/config.js" type="text/javascript"></script>
	</head>
	<body class="BL-bg-f2f">
		<div id="Js-main">
			<header id="Js-header" class="BL-bg-fff">
				<div class="BL-mod-headbar">
					<div class="BL-ub BL-ub-ac headbar-search">
						<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
						<div class="search search-pro BL-ub BL-ub-ac BL-ub-f1">
							<input type="search" placeholder="请输入品牌型号（如：吉利美日）" class="BL-ub BL-ub-f1" v-model="keyword" @keyup.enter="queryBrand" />
							<div class="button" @click="queryBrand">
								<span class="BL-bimg-contain">&nbsp;</span>
							</div>
						</div>
					</div>
				</div>
			</header>
		
			<div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY" :class="{'BL-bg-fff': brands }">
				<div v-show="brands">
					<div class="mui-content mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view BL-pad-lr-1_25">
								<li class="mui-table-view-cell BL-pad-tb-1" @click="selectBrand(item)" v-for="item in brands">
									<div class="BL-ftz-48">{{item.standardName}} {{item.engineDesc}} {{item.parentVehName}} {{item.familyName}} {{item.seat}}座</div>
									<div class="BL-mar-t-2 BL-ftz-48">市场参考价：<span class="BL-col-red">￥{{item.purchasePrice}}元</span></div>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div v-show="!brands">
					<div class="form-notice BL-col-999">示例：</div>
					<div class="BL-pad-lr-1_5 BL-pad-tb-1">
						<img src="images/icon/pic-auto-examples.png" />
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script src="js/mui.pullToRefresh.js"></script>
	<script src="js/mui.pullToRefresh.material.js"></script>
	<script src="js/vue.min.js" type="text/javascript"></script>
	<script type="text/javascript">
        mui.init();
        var auto = new Vue({
            el: '#Js-main',
			data: {
                car: null,   // 车辆信息
                keyword: "",    // 关键字
                brands: null,   // 品牌列表
				page: 0,
				row: 10,
                cityCode: ""
			},
			methods: {
                toblur:function(){
                    document.activeElement.blur();
                },
                queryBrand: function () {
                    this.toblur();
                    this.page = 0;
                    if (!this.keyword) {
                        mui.toast('关键词不能为空', {duration: 'short', type: 'div'});
                        return
					}
					// 模糊匹配品牌型号信息
                    loadBrandList()
                },
                selectBrand: function (obj) {
                    var biBeginDate = '', ciBeginDate =''
                    // 获取保险起期
                    luckyAjax({
                        data: {
                            server: 'carIns.effectiveDate',
                            view: true,
                            data: JSON.stringify({
                              responseNo: this.car.responseNo,
                              licenseNo: this.car.licenseNo,
                              frameNo: this.car.frameNo,
                              engineNo: this.car.engineNo,
                              firstRegisterDate: this.car.registerDate,
                              isTrans: this.car.isTrans? 1:0,
                              transDate: this.car.transDate,
                              brandCode: obj.brandCode,
                              cityCode: this.cityCode
                            })
                        },
                        success: function (res) {
                            if (res.code == 1) {
                                biBeginDate = res.data.biLastEffectiveDate
								ciBeginDate = res.data.ciLastEffectiveDate
                            }
                        }
                    })

                    mui.fire(plus.webview.getWebviewById('auto2c_supplement'),'selectBrand',{
                        brand: obj,
                        biBeginDate: biBeginDate,
                        ciBeginDate: ciBeginDate
                    });
                    setTimeout(function () {
                        plus.webview.currentWebview().close();
                    },200)
                }
			}
		});
        (function($){
            //阻尼系数
            var deceleration = mui.os.ios ? 0.003 : 0.0009;
            $('#Js-content .mui-scroll-wrapper').scroll({
                bounce: true,
                indicators: false, //是否显示滚动条
                deceleration: deceleration
            });

            $.plusReady(function() {
                // 设置内容区域
                statusbar();
                var winH = window.innerHeight;
                var titHeight = document.querySelector('#Js-header').offsetHeight;
                document.querySelector('#Js-content').style.height = (winH - titHeight) +'px';

                // 获取车辆信息、是否过户及过户日期
                auto.car = plus.webview.currentWebview().car;
                auto.cityCode = plus.webview.currentWebview().cityCode;

                var i = 0;
                $('#Js-content .mui-scroll').pullToRefresh({
                    up: { // 上拉加载更多
                        auto: false, // 自动上拉一次
                        contentrefresh: '正在加载...',
                        contentnomore:'没有更多数据了',// 可选，请求完毕若没有更多数据时显示的提醒内容；
                        callback: function() {
                            loadBrandList(1)
                        }
                    }
                });
            });
        }(mui));
        //加载品牌列表
        var loadBrandList = function (type,e) {
            auto.page++;
            luckyAjax({
                data: {
                    server: 'carIns.modelMistiness',
                    view: true,
                    data: JSON.stringify({
                        brandName: auto.keyword,
                        page: auto.page,
                        row: auto.row
                    })
                },
                success:function(res){
                    if (res.code == 1) {
                        auto.$nextTick(function () {
                            if (res.data == null) {
                                mui.toast("没有找到车型信息", {duration: 'short', type: 'div'});
                            } else {
								if(auto.page == 1) {
                                    auto.brands = res.data
                                    mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(false)
                                } else {
                                    auto.brands = auto.brands.concat(res.data)
                                    mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(false)
                                }
							}
                        })
                    } else {
                        mui.toast(res.msg, {duration: 'short', type: 'div'});
                    }
                }
            });
        };
	</script>
</html>
