<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <link href="css/member.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <script src="js/auto2.js"></script>
    <link href="css/auto.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/mui.picker.min.css"/>
</head>

<body class="BL-bg-f2f">
    <header id="Js-header" class="BL-bg-fff">
        <div class="BL-mod-headbar BL-mod-headbar-pos">
            <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
            <h1 class="BL-title">申请核保</h1>
        </div>
    </header>
    <div id="Js-content" class="mui-content BL-overFlow-autoY BL-bg-fff" v-cloak>
        <div class="BL-bg-fff">
            <ul class="mui-table-view mui-table-view-chevron warranty-mui-table-view">
                <li class="mui-table-view-cell member-warranty-detail-item" v-if="quote && insList">
                    <div class="form-button-group">
                        <a type="button" class="form-btn BL-col-3b9cf5 BL-mar-t-1 BL-bg-f2f" id="saveImg">保存报价信息为图片</a>
                    </div>
                    <div class="form-list-thumb BL-ub BL-ub-ac" style="padding: 1rem 1.7rem 0rem 1.7rem">
                        <img :src="'images/auto/'+quote.insurerCode+'.png'" :alt="quote.insurerCode">
                        <div class="form-list-title">
                            {{ getICName(quote.insurerCode) }}
                        </div>
                        <div class="BL-ub-f1 BL-txt-r">
                            合计：<i class="BL-col-ff8201">￥{{(Number(quote.biPremium)+Number(quote.ciPremium) + Number(quote.carshipTax)).toFixed(2)}}</i>
                        </div>
                    </div>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron" style="padding-top: 1rem">
                        <table>
                            <thead>
                                <tr>
                                    <td class="BL-bg-f2f">险种</td>
                                    <td class="BL-bg-f2f">保费（元）</td>
                                    <td class="BL-bg-f2f">起保日期</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>商业险</td>
                                    <td>{{ quote.biPremium }}</td>
                                    <td>{{ insList.biBeginDate }}</td>
                                </tr>
                                <tr v-if="quote.ciPremium > 0">
                                    <td>交强险</td>
                                    <td>{{ quote.ciPremium }}</td>
                                    <td>{{ insList.ciBeginDate }}</td>
                                </tr>
                                <tr v-if="quote.carshipTax > 0">
                                    <td>车船税</td>
                                    <td>{{ quote.carshipTax }}</td>
                                    <td>{{ insList.ciBeginDate }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </li>
                <li class="mui-table-view-cell member-warranty-detail-item BL-mar-tb-1">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l">
                        <span class="BL-col-3b9cf5">配送信息</span>
                    </a>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron">
                        <div class="BL-ub BL-rel BL-mar-t-07 input-item">
                            <label>收件人姓名</label>
                            <div class="input-wrap">
                                <input v-model.trim.lazy="address.name" type="text" placeholder="请输入真实姓名" @change="checkName('收件人',address.name)">
                                <div class="form-clear-icon" v-show="address.name!=''">
                                    <span class="mui-icon mui-icon-clear" @click="address.name =''"></span>
                                </div>
                            </div>
                        </div>
                        <div class="BL-ub BL-rel BL-mar-t-07 input-item">
                            <label>收件人电话</label>
                            <div class="input-wrap">
                                <input v-model.trim.lazy="address.mobile" type="text" placeholder="请输入" @change="checkPhone('收件人',address.mobile)">
                                <div class="form-clear-icon" v-show="address.mobile!=''">
                                    <span class="mui-icon mui-icon-clear" @click="address.mobile =''"></span>
                                </div>
                            </div>
                        </div>
                        <div class="BL-ub BL-rel BL-mar-t-07 input-item">
                            <label>收件人地址</label>
                            <div class="input-wrap box-f-1">
                                <div class="input" id="address-select">
                                    {{ address.location }}
                                </div>
                                <div class="ins-down-icon"></div>
                            </div>
                        </div>
                        <div class="BL-ub BL-rel BL-mar-t-07 input-item">
                            <label>地址详情</label>
                            <div class="input-wrap">
                                <input v-model.trim.lazy="address.detail" type="text" placeholder="请输入">
                                <div class="form-clear-icon" v-show="address.detail!=''">
                                    <span class="mui-icon mui-icon-clear" @click="address.detail =''"></span>
                                </div>
                            </div>
                        </div>
                        <div class="BL-ub BL-rel BL-mar-t-07 input-item">
                            <label>电子邮箱</label>
                            <div class="input-wrap">
                                <input v-model.trim.lazy="address.email" type="text" placeholder="请输入" @change="checkEmail('收件人',address.email)">
                                <div class="form-clear-icon" v-show="address.email!=''">
                                    <span class="mui-icon mui-icon-clear" @click="address.email =''"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="mui-table-view-cell mui-collapse member-warranty-detail-item BL-mar-tb-1"  v-if="quote && quote.coverageList">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l mui-navigate-right">
                        <span class="BL-col-3b9cf5">商业险险种详情</span>
                    </a>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron" style="padding-top: 1rem">
                        <table>
                            <thead>
                                <tr>
                                    <td class="BL-bg-f2f">险种</td>
                                    <td class="BL-bg-f2f">保额（元）</td>
                                    <td class="BL-bg-f2f">保费（元）</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in quote.coverageList" v-if="quote.coverageList.length > 1 && item.coverageCode != 'FORCEPREMIUM'">
                                    <td>{{item.coverageName}}</td>
                                    <td>{{item.amount ? (/\./.test(item.amount) ? Number((+item.amount).toFixed(2)) : Number(item.amount) / 10000 + '万') : '投保'}}</td>
                                    <td>{{Number(item.insuredPremium)}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </li>
                <li class="mui-table-view-cell mui-collapse member-warranty-detail-item BL-mar-tb-1" v-if="car && brand">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l mui-navigate-right">
                        <span class="BL-col-3b9cf5">车辆信息</span>
                    </a>
                    <div class=" BL-pad-lr-1_5 mui-table-view mui-table-view-chevron"  style="overflow: hidden;padding-top: 1rem">
                        <ul style="width: 40%;float: left;" class="BL-bg-f2f">
                            <li>车牌号</li>
                            <li>车架号</li>
                            <li>发动机号</li>
                            <li>品牌型号</li>
                            <li>初登日期</li>
                            <li>是否过户车</li>
                        </ul>
                        <ul style="width: 60%;float: left;border-left: none;">
                            <li>{{ car.licenseNo }}</li>
                            <li>{{ car.frameNo }}</li>
                            <li>{{ car.engineNo }}</li>
                            <li>{{ ([brand.brandName,brand.vehicleFgwName,brand.parentVehName].join(' ')).trim() }}</li>
                            <li>{{ car.registerDate }}</li>
                            <li>{{ car.isTrans? "是": "否" }}</li>
                        </ul>
                    </div>
                </li>
                <li class="mui-table-view-cell mui-collapse member-warranty-detail-item BL-mar-tb-1" v-if="owner">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l mui-navigate-right">
                        <span class="BL-col-3b9cf5">车主信息</span>
                    </a>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron"  style="overflow: hidden;padding-top: 1rem">
                        <ul style="width: 40%;float: left;" class="BL-bg-f2f">
                            <li>姓名</li>
                            <li>手机号码</li>
                            <li>证件号码</li>
                        </ul>
                        <ul style="width: 60%;float: left;border-left: none;">
                            <li>{{ owner.name }}</li>
                            <li>{{ owner.mobile }}</li>
                            <li>{{ owner.Idno }}</li>
                        </ul>
                    </div>
                </li>
                <li class="mui-table-view-cell mui-collapse member-warranty-detail-item BL-mar-tb-1" v-if="applicant">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l mui-navigate-right">
                        <span class="BL-col-3b9cf5">投保人信息</span>
                    </a>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron"  style="overflow: hidden;padding-top: 1rem">
                        <ul style="width: 40%;float: left;" class="BL-bg-f2f">
                            <li>姓名</li>
                            <li>手机号码</li>
                            <li>证件号码</li>
                        </ul>
                        <ul style="width: 60%;float: left;border-left: none;">
                            <li>{{ applicant.name }}</li>
                            <li>{{ applicant.mobile }}</li>
                            <li>{{ applicant.Idno }}</li>
                        </ul>
                    </div>
                </li>
                <li class="mui-table-view-cell mui-collapse member-warranty-detail-item BL-mar-tb-1" v-if="assured">
                    <a class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-52 BL-txt-l mui-navigate-right">
                        <span class="BL-col-3b9cf5">被保人信息</span>
                    </a>
                    <div class="BL-pad-lr-1_5 mui-table-view mui-table-view-chevron"  style="overflow: hidden;padding-top: 1rem">
                        <ul style="width: 40%;float: left;" class="BL-bg-f2f">
                            <li>姓名</li>
                            <li>手机号码</li>
                            <li>证件号码</li>
                        </ul>
                        <ul style="width: 60%;float: left;border-left: none;">
                            <li>{{ assured.name }}</li>
                            <li>{{ assured.mobile }}</li>
                            <li>{{ assured.Idno }}</li>
                        </ul>
                    </div>
                </li>
            </ul>
            <div class="mui-input-row mui-checkbox mui-left BL-mar-t-1 BL-ftz-48">
                <label>本人已阅读并了解</label><a class="a-link BL-col-3b9cf5" id="protocol">《投保协议》</a>和<a
                    class="a-link BL-col-3b9cf5" id="contract">《特约信息》</a>
                <input name="checkbox" value="Item 1" type="checkbox" v-model="promise">
            </div>
            <div style="height: 10rem"></div>
        </div>
    </div>
    <footer id="Js-footer" class="BL-footer BL-bg-fff">
        <div class="BL-ub BL-ub-ac BL-ub-f1">
            <div class="BL-ub BL-ub-f1 BL-ub-ae BL-foot-integ BL-ftz-52">
                总保费：
                <div class="BL-col-ff8201 BL-bold" id="sum"></div>
            </div>
            <div class="BL-foot-btn-sign" id="ins-save">
                申请核保
            </div>
        </div>
    </footer>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/vue.min.js"></script>
<script src="js/mui.picker.js"></script>
<script src="js/mui.poppicker.js"></script>
<script src="js/mui.dtpicker.js"></script>
<script src="js/city.data-3.js"></script>
<script src="js/Date.js"></script>
<script src="js/IDValidator.min.js"></script>
<script type="text/javascript">
    mui.init();
    mui.plusReady(function() {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;
        document.querySelector('#Js-content').style.height = (winH - titHeight) +'px';


        var auto = new Vue({
            el: '#Js-content',
            data: {
                loading: false,
                car: null, // 车辆信息
                brand: null, // 车型信息
                owner: null,  // 车主信息
                applicant: null,// 投保人信息
                assured: null, //被保人信息
                quote: null,
                // 收件人信息
                address: {
                    name: "",
                    mobile: "",
                    location: "请选择",  // 省市区
                    detail: "",   // 地址详情
                    email: "",  // 电子邮箱
                    province: "", // 省级代码
                    city: "",     // 市级代码
                    county: ""    // 区级代码
                },
                promise: false
            },
            methods: {
                getICName: function(index) {
                    return ICName[index]
                },
                checkForm: function () {
                    if (!checkName('收件人',auto.address.name)) {
                        return false
                    } else if (!checkPhone('收件人',auto.address.mobile)) {
                        return false
                    } else if (auto.address.location == '请选择') {
                        mui.toast('请选择收件人省市区地址信息', {duration: 'short', type: 'div'});
                        return false
                    }else if (!auto.address.detail) {
                        mui.toast('请填写收件人地址详情', {duration: 'short', type: 'div'});
                        return false
                    } else if (!checkEmail('收件人',auto.address.email)) {
                        return false
                    }
                    return true
                }
            }
        });

        // 获取本地车辆信息
        auto.car = JSON.parse(plus.storage.getItem('car'))
        // 获取本地车型信息
        auto.brand = JSON.parse(plus.storage.getItem('brand'))
        // 获取本地车主信息
        auto.owner = JSON.parse(plus.storage.getItem('owner'))
        // 投保人同车主
        auto.applicant = JSON.parse(plus.storage.getItem('applicant'))
        // 被保人同车主
        auto.assured = JSON.parse(plus.storage.getItem('assured'))
        // 保单险种信息
        auto.insList = JSON.parse(plus.storage.getItem('insList'))

        auto.quote = plus.webview.currentWebview().quote;
        document.getElementById('sum').innerHTML = (Number(auto.quote.biPremium)+Number(auto.quote.ciPremium)+Number(auto.quote.carshipTax)).toFixed(2)

        //投保地区
        auto.$nextTick(function () {
            var _getParam = function (obj, param) {
                return obj[param] || '';
            };
            var cityPicker3 = new mui.PopPicker({
                layer: 3
            });
            cityPicker3.setData(cityData3);

            document.querySelector('#address-select').addEventListener('tap', function () {
                document.activeElement.blur();
                cityPicker3.show(function (items) {
                    // 北京1、天津2 、上海3 、重庆4直辖市特殊处理
                    auto.address.province = items[0].value
                    if (auto.address.province == 1 || auto.address.province == 2 || auto.address.province == 3 || auto.address.province == 4) {
                        auto.address.city = ""
                        auto.address.county = items[1].value
                    } else {
                        auto.address.city = items[1].value
                        auto.address.county = items[2].value
                    }
                    auto.address.location = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(items[2], 'text') ;
                });
            }, false);
        })

        // 申请核保
        document.querySelector('#ins-save').addEventListener('click', function () {
            if (auto.loading) {
                console.log('again')
                return false;
            }
            setTimeout(function () {
                plus.nativeUI.closeWaiting();
                auto.loading = false;
            }, 15000)
            if (!auto.checkForm()) {
                return false
            }
            if (!auto.promise) {
                mui.toast('请确认阅读并了解《投保协议》和《特约信息》', {duration: 'long', type: 'div'});
                return false;
            }
            // 本地保存收件人信息
            plus.storage.setItem('address',JSON.stringify(auto.address));
            auto.loading = true;
            // 保存保单
            var data = setCarinsData(auto.quote.insurerCode)
            luckyAjax({
                data: {
                    server: 'carIns.setCarIns',
                    view: true,
                    data: JSON.stringify(data)
                },
                success: function (res) {
                    if (res.code == 1) {
                        // 开始申请核保
                        online_ins()
                    } else {
                        mui.toast(res.msg, {duration: 'long', type: 'div'});
                        return false;
                    }
                }
            })
        });
        // 获取投保协议
        document.querySelector('#protocol').addEventListener('click', function () {
            luckyAjax({
                data: {
                    server: 'carIns.statement',
                    view: true,
                    data: JSON.stringify({
                        companyCode: auto.quote.insurerCode
                    })
                },
                success: function (res) {
                    if (res.code == 1) {
                        mui.openWindow({
                            url: 'auto2c-statement.html',
                            id: 'auto2c_statement',
                            show: animateObj.aniDetal,
                            extras: {
                                statement: res.data
                            }
                        });
                    } else {
                        mui.toast("该公司没有投保协议", {duration: 'long', type: 'div'});
                        return false;
                    }
                }
            })
        });

        // 查看特约信息
        document.querySelector('#contract').addEventListener('click', function () {
            mui.openWindow({
                url: 'auto2c-contract.html',
                id: 'auto2c_contract',
                show: animateObj.aniDetal
            });
        });

        // 申请核保
        function online_ins() {
            var data= {
                insurerCode: auto.quote.insurerCode,
                bizID: auto.quote.bizID,
                channelCode: auto.quote.channelCode,
                applicantName: auto.applicant.name,
                applicantIdNo: auto.applicant.Idno,
                applicantMobile: auto.applicant.mobile,
                addresseeName: auto.address.name,
                addresseeDetails: auto.address.detail,
                addresseeCounty: auto.address.county,
                addresseeCity: auto.address.city,
                addresseeProvince: auto.address.province,
                addresseeMobile: auto.address.mobile,
                policyEmail: auto.address.email
            }
            console.log(JSON.stringify(data))
            luckyAjax({
                data: {
                    server: 'carIns.applyUnderwrite',
                    view: true,
                    data: JSON.stringify(data)
                },
                success: function (res) {
                    // 同步核保状态

                    if (res.code == 1) {
                        if (res.data.synchFlag == '1') {
                            // 转入人工核保
                            console.log('转入人工核保')
                            return
                        }
                        // 核保成功，跳转到付款页面
                        mui.openWindow({
                            url: 'auto2c-pay.html',
                            id: 'auto2c_pay',
                            show: animateObj.aniDetal,
                            extras: {
                                payLink: res.data.payLink
                            }
                        });

                    } else {
                        mui.toast(res.msg, {duration: 'long', type: 'div'});
                        return false
                    }
                }
            })
        }
    })
</script>
</html>
