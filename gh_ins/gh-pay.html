<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/common.css" rel="stylesheet" />
		<link href="../css/module.css" rel="stylesheet" />
		<link href="../css/insurance.css" rel="stylesheet" />
		<script src="../js/config.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
	</head>

	<body class="BL-bg-f2f">
		<header id="Js-header" class="BL-bg-fff">
			<div class="BL-mod-headbar BL-mod-headbar-pos">
				<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
				<h1 class="BL-title">国华在线投保</h1>
			</div>
		</header>
		<div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY">
			<div class="form-content" v-cloak>
				<div class="form-wrap">
					<div class="border-b-e7e7e7">
						<div class="item-title orange">银行账户不支持信用卡</div>
					</div>
					<div class="input-item">
						<label class="">户名</label>
						<div class="input-wrap box-f-1">
							<input type="text" placeholder="请输入" v-model.lazy="bank_holder">
						</div>
					</div>
					<div class="input-item">
						<label class="">银行卡号</label>
						<div class="input-wrap box-f-1">
							<input type="number" placeholder="请输入" v-model.trim.lazy="bank_no">
							<div class="form-clear-icon" v-show="bank_no!=''" @click="bank_no=''">
								<span class="mui-icon mui-icon-clear"></span>
							</div>
						</div>
					</div>
					<div class="input-item">
						<label class="">账户类型</label>
						<div class="input-wrap box-f-1">
							<div class="input" id="bank_type" :data-value="bank_type">{{temp_bank_type}}</div>
							<div class="ins-down-icon"></div>
						</div>
					</div>
					<div class="input-item">
						<label class="">开户行</label>
						<div class="input-wrap box-f-1">
							<div class="input" id="bank_name" :data-value="bank_name">{{temp_bank_name}}</div>
							<div class="ins-down-icon"></div>
						</div>
					</div>
				</div>
				<div class="BL-pad-lr-1">
					<div class="mui-input-row mui-checkbox mui-left BL-pad-t-1">
						<label style="padding-left: 3rem;">
                        本人已阅读并同意银行<a type="button" id="statement">《银行自动转账授权事项》</a>
                        <input name="checkbox" value="Item1" type="checkbox" v-model="agree" style="top: 20px; left: 0px;">
                    </label>
					</div>
				</div>
				<div class="BL-mar-t-3 BL-pad-lr-1_5">
					<a type="button" id="saveBank" class="form-btn blue">支付</a>
				</div>
			</div>
		</div>
		</div>
	</body>
	<script src="../js/mui.min.js" type="text/javascript"></script>
	<script src="../js/vue.min.js" type="text/javascript"></script>
	<script src="method.js"></script>
	<script src="../js/mui.picker.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script type="text/javascript">
		mui.init();
		var pid;
		var bank = new Vue({
			el: '#Js-content',
			data: {
				init: {},
				agree: false,
				bank_holder: '', //户名
				bank_name: '', //开户行
				temp_bank_name: '请选择', //开户行名称
				bank_type: '',
				temp_bank_type: '请选择', //账户类型
				bank_no: '' //卡号
			},
			methods: {
				checkFrom: function() {
					var toast_text = null;
					if(!this.bank_holder) {
						toast_text = '请填写户名';
					} else if(!this.bank_no) {
						toast_text = '请填写银行卡号';
					} else if(isNaN(this.bank_no)) {
						toast_text = '银行卡号必须是数字'
					} else if(!this.bank_name) {
						toast_text = '请选择开户行';
					} else if(!this.bank_type) {
						toast_text = '请选择账户类型';
					} else if(!this.agree) {
						toast_text = '请确认并同意自动转账授权声明';
					}
					if(toast_text) {
						mui.toast(toast_text, {
							duration: 'short',
							type: 'div'
						});
						return false;
					}
					return true;
				}
			}
		});

		mui.plusReady(function() {
			statusbar();
			var winH = window.innerHeight;
			var titHeight = document.querySelector('#Js-header').offsetHeight;
			document.querySelector('#Js-content').style.height = winH - titHeight + 'px';
			pid = plus.webview.currentWebview().policy_id;
			var user_id = JSON.parse(plus.storage.getItem("userinfo")).id
			var bankType = new mui.PopPicker();
			var bankType2 = new mui.PopPicker();
			if(pid) {
				luckyAjax({
					data: {
						data: JSON.stringify({
							policy_id: pid
						}),
						server: 'PolicyIns.policyDetails',
						device: 'mobile'
					},
					success: function(res) {
						console.log(JSON.stringify(res))
						if(res.code) {
							if(res.data.policyInfo.progress <= 1) {
								getWarranty(pid);
							} else if(res.data.policyInfo.progress === 2) {
								mui.toast('此单已承保，不能再次编辑', {
									duration: 'long',
									type: 'div'
								})
								return false
							}
						} else {
							mui.toast('保单不存在', {
								duration: 'short',
								type: 'div'
							})
							return false
						}
					}
				})
			}
			//获取保单数据
			function getWarranty(pid) {
				console.log('getWarranty')
				const vm = this
				var bank_data = {}
				luckyAjax({
					data: {
						data: JSON.stringify({
							'policy_id': pid
						}),
						server: 'PolicyIns.edit'
					},
					success: function(res) {
						if(res.code) {
							console.log('44444')
							var da = res.data
							//银行信息
							bank.agree = false
							bank.bank_holder = da.insData.holder_name //户名
							bank.bank_name = da.insData.bank_name //开户行
							bank.temp_bank_name = da.insData.bank_name_text //开户行名称
							bank.temp_bank_type = da.insData.bank_type_text //账户类型
							bank.bank_type = da.insData.bank_type //账户类型
							bank.bank_no = da.insData.bank_no //卡号
						}
					}
				})
			}
			//整理下拉框需要的数据
			function dataToselect(data, type) {
				var arr = [];
				mui.each(data, function(ind, ite) {
					arr.push({
						text: type ? ite.name : ite.enum_name,
						value: ite.id
					});
				});
				return arr;
			}

			//初始化下拉数据获取
			luckyAjax({
				data: {
					data: JSON.stringify({
						'supplier_id': 2
					}),
					server: 'PolicyIns.initPolicyField'
				},
				success: function(data) {

					if(data.code) {
						var res = {}
						var data = data.data;
						mui.each(data, function(index, item) {
							var itemdata = item.child;
							if(item.cate === 'AV') {
								res.bank_code = dataToselect(item.child); //银行代码
							} else if(item.cate === 'AU') {
								res.bank_type = dataToselect(item.child); //银行卡类型
							}
						});
						bank.init = res;
						//开户行选择
						bankType.setData(bank.init.bank_code);
						//账户类型选择
						bankType2.setData(bank.init.bank_type);
					}
				}
			});
			//开户行选择
			document.querySelector('#bank_name').addEventListener('tap', function() {
				document.activeElement.blur();
				bankType.show(function(items) {
					bank.bank_name = items[0].value;
					bank.temp_bank_name = items[0].text;
				})
			});
			//账户类型选择
			document.querySelector('#bank_type').addEventListener('tap', function() {
				document.activeElement.blur();
				bankType2.show(function(items) {
					bank.bank_type = items[0].value;
					bank.temp_bank_type = items[0].text;
				})
			});
			//支付
			var pushdata = {};
			document.querySelector('#saveBank').addEventListener('tap', function() {
				document.activeElement.blur();
				if(!bank.checkFrom()) {
					return false
				}
				
				pushdata.id = pid
				pushdata.supplier_id = 2
				pushdata.ins_area = '323' //深圳
				pushdata.sales_channel = '2'
				pushdata.is_first = '1'
				pushdata.user_id = user_id

				//银行信息
				pushdata.bank_holder = bank.bank_holder
                pushdata.bank_name = bank.bank_name
                pushdata.temp_bank_name = bank.temp_bank_name
                pushdata.bank_type = bank.bank_type
                pushdata.temp_bank_type = bank.temp_bank_type
                pushdata.bank_no = bank.bank_no
                console.log(JSON.stringify(pushdata))
				console.log('saving---')
					luckyAjax({
						data: {
							data: JSON.stringify(pushdata),
							server: 'PolicyIns.save'
						},
						closeWaiting: true,
						timeout: 10000,
						success: function(res) {
							if(res.code) {
								pay()
							} else {
								plus.nativeUI.closeWaiting();
								index.loading = false;
								mui.toast(res.msg, {
									duration: 'short',
									type: 'div'
								})
							}
						}
					});
			})
			function pay() {
				  luckyAjax({
			            data: {
			                server: 'PolicyIns.onlineInsured',
			                data: JSON.stringify({
			                	msg: { policy_id: pid},
			                	company_code: 'GuoHua',
			                	method: 'pay'
			                })
			            },
			            success: function(res){
			                if(res.code == 1) {
			                   mui.toast(res.msg, {duration: 'long', type: 'div'})
			                   setTimeout(function() {
									mui.openWindow({
										url: '../member-warranty-manageLife.html',
										id: 'member_warranty_manageLife',
										show: animateObj.aniDetal
									})
								}, 3000)
			                } else {
			                   mui.toast(res.msg, {duration: 'long', type: 'div'})
			                   var wobj1 = plus.webview.getWebviewById("member_life_order");
								if(wobj1){
									wobj1.reload(true);
								}
			                   if(res.data.Response.Payment.PayStatus === '1') {
			                   		setTimeout(function() {
										mui.openWindow({
											url: '../member-life-order.html',
											id: 'member_life_order',
											show: animateObj.aniDetal
										})
									}, 3000)
			                   }
			                }
			            }
			        });
			}
		});
	</script>

</html>