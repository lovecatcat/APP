<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body>

<div id="Js-content" class="mui-content BL-rel" v-cloak>
    <!--弹窗 begin-->
    <div class="ins-dialog lg">
        <div class="dialog-header">
            <div class="mui-icon mui-icon-closeempty" id="close-ins-pop"></div>
            <p class="ins-font-md box-f-1">受益人信息</p>
            <div class="header-btn-save">
                <button class="ins-btn sm-btn blue" id="saveBenef">保存</button>
            </div>
        </div>
        <div class="form-content margin-t-6_125 BL-pad-b-2">
            <div class="form-wrap">
                <div class="input-item box-f-1">
                    <div class="box-f-3 ins-font-sm">是否法定？</div>
                    <div class="input-switch">
                        <input type="checkbox" class="switch" v-model="is_legal_benefic"/>
                        <label></label>
                    </div>
                </div>
            </div>
            <div v-show="!is_legal_benefic">
                <bene ref="beneficiary"
                      :init="init"
                      v-for="(value,k) in beneficiariesIndex"
                      :index="k"
                      :val="value"
                      :key="value"
                      :count="beneficiariesIndex.length"
                      :data="beneficiaries[k]">
                </bene>
                <div class="BL-mar-tb-1 BL-pad-lr-1">
                    <a type="button" class="form-btn" @click="addBeneficiary">+添加受益人</a>
                </div>
            </div>
        </div>
    </div>
    <!--弹窗 end-->
</div>
<template id="bene">
    <div>
        <div class="form-wrap margin-t_875 border-b-e7e7e7">
            <div class="input-item box-f-1 box-align-center input-item-title">
                <div class="box-f-1 ins-font-sm BL-col-3b9cf5"><span v-if="count>1">第{{ index+1 }}个</span>受益人</div>
                <div class="box-f-2" v-if="count > 1">
                    <button class="ins-btn xs-btn" @click="$parent.delBeneficiary(val)">删除</button>
                    <span class="bene-up-icon mui-icon mui-icon-arrowup" @click="unfold(index)"
                          :class="{'bene-up-icon-rotate':show}"></span>
                </div>
            </div>
        </div>
        <div class="form-wrap" v-show="show">
            <div class="input-item">
                <label class="">姓名</label>
                <div class="BL-ub BL-ub-pj BL-ub-f1">
                    <div class="input-wrap BL-ub-f1">
                        <input type="text" v-model.trim.lazy="beneficiary.fullname" placeholder="请输入">
                        <div class="form-clear-icon" v-show="beneficiary.fullname!=''"
                             @click="beneficiary.fullname=''">
                            <span class="mui-icon mui-icon-clear"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-item">
                <label class="">证件类型</label>
                <div class="input-wrap box-f-1">
                    <div class="input" :id="'ID_type'+index">
                        {{beneficiary.ID_type_name}}
                    </div>
                    <div class="ins-down-icon"></div>
                </div>
            </div>
            <div class="input-item">
                <label class="">证件号码</label>
                <div class="input-wrap box-f-1">
                    <input type="text" v-model.trim.lazy="beneficiary.ID_no" placeholder="请输入">
                    <div class="form-clear-icon" v-show="beneficiary.ID_no!=''" @click="beneficiary.ID_no=''">
                        <span class="mui-icon mui-icon-clear"></span>
                    </div>
                </div>
            </div>
            <div class="input-item">
                <label class="">性别</label>
                <div class="input-wrap box-f-1">
                    <button class="ins-btn sm-btn"
                        :class="{'blue':beneficiary.gender===item.value}"
                        v-for="(item,index) in init.gender"
                        @tap="beneficiary.gender=item.value,toblur()"
                        :disabled="IDNO.indexOf(beneficiary.ID_type)>-1">{{item.text}}
                    </button>
                </div>
            </div>
            <div class="input-item">
                <label class="">出生日期</label>
                <div class="input-wrap box-f-1" :class="'searchDate'+index" data-options='{"type":"date","beginYear":1910}'>
                    <input type="text"
                           v-model.lazy="beneficiary.birthday"
                           :disabled="IDNO.indexOf(beneficiary.ID_type)>-1"
                           placeholder="请选择" readonly>
                    <button class="ins-date-icon" :disabled="IDNO.indexOf(beneficiary.ID_type)>-1"></button>
                </div>
            </div>
            <div class="input-item" v-if="init&&init.relation_beneficiary">
                <label class="">是被保人的</label>
                <div class="input-wrap box-f-1 multi-btn">
                    <button class="ins-btn xs-btn"
                            :class="{'blue':item.value===beneficiary.beneficiary_is_insured}"
                            :disabled="item.value===beneficiary.beneficiary_is_insured"
                            v-for="(item,index) in init.relation_beneficiary"
                            @tap="beneficiary.beneficiary_is_insured=item.value,toblur()">
                        {{item.text}}
                    </button>
                </div>
            </div>
            <div class="input-item">
                <label class="">受益顺序</label>
                <div class="input-wrap box-f-1 multi-btn">
                    <button class="ins-btn xs-btn"
                            v-for="(item,ind) in count"
                            v-show="ind<2"
                            :class="{'blue':ind+1===beneficiary.sort_order}"
                            :disabled="ind+1===beneficiary.sort_order"
                            @tap="beneficiary.sort_order=ind+1,toblur()">
                        {{ind+1}}
                    </button>
                </div>
            </div>
            <div class="input-item">
                <label class="">受益比例(%)</label>
                <div class="input-wrap box-f-1">
                    <input type="number" v-model.number="beneficiary.rate" placeholder="请输入">
                    <div class="form-clear-icon" v-show="beneficiary.rate!=''" @click="beneficiary.rate=''">
                        <span class="mui-icon mui-icon-clear"></span>
                    </div>
                </div>
            </div>
            <div class="input-item ins-font-xs BL-col-999">同一受益顺序的受益人受益份额之和为<span
                    class="BL-col-ff8201">100%</span>
            </div>
          
        </div>
    </div>
</template>
</body>
<script src="../js/mui.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="../js/mui.picker.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script src="../js/mui.dtpicker.js"></script>
<script src="../js/city.data-3.js"></script>
<script src="../js/IDValidator.min.js"></script>
<script src="method.js"></script>
<script type="text/javascript">
    mui.init();

    var idtype = [];
    var cityPicker = [];

    mui.plusReady(function () {
        console.log('ready')
        var popu = new ClosePopu(); // 实例化关闭窗口对象

        for (var i = 0; i < 4; i++) {
            idtype.push(new mui.PopPicker());
            cityPicker.push(new mui.PopPicker({layer: 3}));
        }
        mui('body').on('tap', '#close-ins-pop', function () {
            // 关闭遮罩层，弹框
            popu.closepop();
        });

        //
        var bene = new Vue({
            el: '#Js-content',
            data: function() {
                return {
                    init: {},
                    applicant: {},
                    assured: {},
                    is_legal_benefic: true,
                    benefited: null, //所有受益人份额
                    beneficiariesIndex: [1], //受益人索引
                    nenesum: 4, // 受益人数量
                    beneficiaries: ''
                }
            },
            created:function() {
                console.log('parent-created')
                var beneficiary = plus.storage.getItem('guohua_beneficiary') ? JSON.parse(plus.storage.getItem('guohua_beneficiary')) : ''
                console.log(JSON.stringify(beneficiary))
                if(beneficiary){
                    if(beneficiary !== 1){
                        this.beneficiariesIndex = []
                        for (var j in beneficiary) {
                            this.beneficiariesIndex.push(j + 1)
                        }
                        console.log(JSON.stringify(this.beneficiariesIndex))
                        var length = this.beneficiariesIndex.length
                        if (length < 1) {
                            this.beneficiariesIndex = [1]
                        }
                        this.is_legal_benefic = false
                    } else {
                        this.is_legal_benefic = true //法定
                    }
                    this.beneficiaries = beneficiary
                }
            },
            methods: {
                initpicker:function(index){
                    idtype[index].setData(this.init.ID_type);
                    cityPicker[index].setData(cityData3);
                },
                // 添加受益人
                addBeneficiary:function() {
                    const vm = this
                    if (vm.beneficiariesIndex.length === vm.nenesum) {
                        mui.toast('受益人合计不得指定超过' + vm.nenesum + '位', {duration: 'short', type: 'div'})
                        return false
                    }
                    var max = vm.beneficiariesIndex.length > 0 ? Math.max.apply(null,vm.beneficiariesIndex) : 0;
                    if (!vm.checkAllBens()) return false
                    vm.beneficiariesIndex.push(max + 1)
                    vm.$nextTick(function(){
                        idtype[max].setData(vm.init.ID_type);
                        cityPicker[max].setData(cityData3);
                        vm.updateBeneficiaryRatio();
                        vm.par_unfold(vm.beneficiariesIndex.length - 1, 0);
                    });
                },
                // 删除受益人
                delBeneficiary:function(val) {
                    var vm = this
                    mui.confirm('确认删除受益人吗？', '提示', ['确定', '取消'], function (e) {
                        if (e.index == 0) {
                            var index = vm.beneficiariesIndex.indexOf(val)
                            vm.beneficiariesIndex.splice(index, 1)
                            bene.$nextTick(function(){
                                vm.updateBeneficiaryRatio()
                                if (vm.beneficiariesIndex.length == 1) {
                                    vm.par_unfold(vm.beneficiariesIndex.length - 1, 0)
                                }
                            })
                        } else {
                            mui.toast('取消删除', {duration: 'short', type: 'div'})
                        }
                    })
                },
                // 校验受益人
                checkAllBens:function() {
                    console.log('checkAllBens')
                    var vm = this
                    if (vm.is_legal_benefic) return true //法定受益人
                    var benefited = {}
                    for (var i = 1; i <= vm.nenesum; i++) {
                        benefited[i] = []
                    }
                    var levels = []
                    for (var j in vm.$refs.beneficiary) {
                        var item = vm.$refs.beneficiary[j]
                        benefited[item.beneficiary.sort_order].push(Number(item.beneficiary.rate))
                        var toastText = null
                        var owner = '第' + (1 + Number(j)) + '个受益人'
                        var type = item.beneficiary.ID_type
                        console.log(type)
                        var age = getAge(item.beneficiary.birthday)
                        if (!checkName(owner, item.beneficiary.fullname)) {
                            return false
                        } else if (!type) {
                            toastText = '请选择' + owner + '证件类型'
                        } else if (!IDValidate(type, item.beneficiary.ID_no, owner, item.beneficiary)) {
                            return false
                        } else if (!item.beneficiary.birthday) {
                            toastText = owner + '出生日期不能为空'
                        } else if (age < 0) {
                            toastText = '请输入' + owner + '正确的出生日期'
                        } else if (!item.beneficiary.beneficiary_is_insured) {
                            toastText = '请选择' + owner + '与被保人关系'
                        } else if (item.beneficiary.beneficiary_is_insured === BCOUPLE && this.assured.insured_gender === item.beneficiary.gender) {
                            toastText = owner + '与被保人性别与关系不符'
                        } else if (!item.beneficiary.sort_order) {
                            toastText = '请选择' + owner + '受益顺序'
                        } else if (!item.beneficiary.rate) {
                            toastText = owner + '受益份额不能为空'
                        }
                        if (toastText) {
                            mui.toast(toastText, {duration: 'short', type: 'div'})
                            return false
                        }
                        levels.push(item.beneficiary.sort_order)
                    }
                    var len = levels.length
                    if (len > 0) {
                        levels.sort(function(a, b) {
                            return a > b
                        });
                        for (var m = 0; m < len; m++) {
                            if (levels[m + 1] && (levels[m + 1] - levels[m] > 1)) {
                                mui.toast('受益顺序必须从1开始且连续', {duration: 'short', type: 'div'})
                                return false
                            }
                        }
                    }
                    vm.benefited = benefited
                    return true
                },
                checkRatio:function() {
                    console.log('checkRatio');
                    if (this.is_legal_benefic) return true //法定受益人
                    var benefited = this.benefited
//                    console.log(JSON.stringify(benefited));
                    for (var j = 1; j <= 4; j++) {
                        var sum = 0
                        for (var k = 0; k < benefited[j].length; k++) {
                            sum += benefited[j][k]
                        }
                        if (sum !== 100 && benefited[j].length > 0) {
                            mui.toast('受益顺序为' + j + '的受益人的受益比例和需为100%', {duration: 'short', type: 'div'})
                            return false
                        }
                    }
                    return true
                },
                // 更新收益份额
                updateBeneficiaryRatio:function() {
                    var countOne = 0
                    for (var j in this.$refs.beneficiary) {
                        var item = this.$refs.beneficiary[j]
                        if (item.beneficiary.sort_order == 1) {
                            countOne++
                        }
                    }
                    for (var k in this.$refs.beneficiary) {
                        var jitem = this.$refs.beneficiary[k]
                        if (jitem.beneficiary.sort_order === 1) return
                        var ratio = parseInt(100 / countOne)
                        if (k > 0 && Number(k) === this.$refs.beneficiary.length - 1) {
                            jitem.beneficiary.rate = 100 - ratio * (countOne - 1)
                        } else {
                            jitem.beneficiary.rate = ratio
                        }
                    }
                },
                // index：第几个， flag: 0 非操作(添加or删除)， 1 操作(展开or收起)
                par_unfold:function(index, flag) {
                    for (var i in this.$refs.beneficiary) {
                        var item = this.$refs.beneficiary[i]
                        if (i == index && flag == 1) {
                            item.show = !item.show
                        } else if (i == index && flag == 0) {
                            item.show = true
                        } else {
                            item.show = false
                        }
                    }
                }
            }
        });
        Vue.component('bene', {
            template: '#bene',
            props: {
                init: {
                    type: Object,
                    required: true
                },
                index: {
                    type: Number,
                    required: true
                },
                val: {
                    type: Number,
                    required: true
                },
                count: {
                    type: Number,
                    required: true
                },
                data: Object
            },
            data: function() {
                return{
                    show: true,
                    longTerm: false,//长期有效
                    beneficiary: {
                        beneficiary_is_insured: '',//与被保人关系
                        fullname: '',//姓名
                        ID_type: '',//证件类型
                        ID_no: '',//证件号码
                        ID_expire_end: '',//证件有效期
                        gender: '',//性别
                        birthday: '',//出生日期
                        sort_order: 1,//受益顺序
                        rate: '',//受益比例
                        type: '',//受益类型：身故
                        ID_type_name: '请选择',//证件类型名称
                        address_select: '请选择'
                    }
                }
            },
            created:function() {
                console.log('child-created')
                var vm = this
                vm.beneficiary.gender = MALE
                //
                if (vm.data) {
                    vm.longTerm = vm.data.ID_expire_end === '9999-12-31' ? true : false
                    vm.beneficiary = deepClone(vm.data)
                }
                //
                vm.$watch('longTerm', function(val) {
                    vm.beneficiary.ID_expire_end = val ? '9999-12-31' : ''
                });
                vm.$watch('beneficiary.ID_no', function() {
                    var type = vm.beneficiary.ID_type
                    var id = vm.beneficiary.ID_no
                    if (!type || !id) return
                    IDValidate(type, id, '第' + (vm.index + 1) + '个受益人',vm.beneficiary)
                });
                vm.$nextTick(function() {
                    vm.$parent.initpicker(vm.index)
                    idtype[vm.index].pickers[0].setSelectedIndex(1);
                //证件类型选择
                document.querySelector('#ID_type' + vm.index).addEventListener('tap', function () {
                    document.activeElement.blur();
                    idtype[vm.index].show(function (items) {
                        vm.beneficiary.ID_no = ''
                        vm.beneficiary.ID_type = items[0].value;
                        vm.beneficiary.ID_type_name = items[0].text;
                    })
                })
                //日期选择
                mui('.searchDate' + vm.index).each(function (i, d) {
                    d.addEventListener('tap', function () {
                        document.activeElement.blur();
                        var optionsJson = this.getAttribute('data-options') || '{}';
                        var options = JSON.parse(optionsJson);
                        var _this = this
                        var picker = new mui.DtPicker(options);
                        picker.show(function (rs) {
                            if (i === 0) {
                                vm.beneficiary.ID_expire_end = rs.text;
                            } else if (i === 1) {
                                vm.beneficiary.birthday = rs.text;
                            }
                            _this.querySelector('input').value = rs.text;
                            picker.dispose();
                        });
                    }, false);
                });
               
            })
            },
            methods: {
                toblur:function(){
                    document.activeElement.blur();
                },
                // 展开收起
                unfold:function(index) {
                    this.$parent.par_unfold(index, 1)
                },
            }
        });
        //
        var init = plus.webview.currentWebview().data;
        bene.init = init;
        idtype[0].setData(init.ID_type);
        cityPicker[0].setData(cityData3);
        var applicant = JSON.parse(plus.storage.getItem('guohua_applicant'))
        var assured = JSON.parse(plus.storage.getItem('guohua_assured'))
        bene.applicant = applicant
        bene.assured = assured
        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            popu.closepop();
        });
        //保存
        document.querySelector('#saveBenef').addEventListener('tap', function () {
            document.activeElement.blur();
            if (bene.is_legal_benefic) {
                //法定
                plus.storage.setItem('guohua_beneficiary', '1');
            } else {
                if (!bene.checkAllBens()) return false
                if (!bene.checkRatio()) return false
                var data = []
                for (var j in bene.$refs.beneficiary) {
                    data.push(bene.$refs.beneficiary[j].beneficiary)
                }
                console.log(JSON.stringify(data))
                plus.storage.setItem('guohua_beneficiary', JSON.stringify(data));
            }
            mui.fire(plus.webview.getWebviewById('gh_insurance-index'), 'saveFlag', {
                item: 'guohua_beneficiary',
                data: 'beneficiary'
            });
            popu.closepop();
            mui.back();
        })
        //
    });
</script>
</html>