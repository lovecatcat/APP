<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <script src="../js/browser.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body>

<div id="Js-content" class="mui-content BL-rel">
    <!--弹窗 begin-->
    <div class="ins-dialog lg">
        <div class="dialog-header">
            <div class="mui-icon mui-icon-closeempty" id="close-ins-pop"></div>
            <p class="ins-font-md box-f-1">健康告知信息</p>
            <div class="header-btn-save">
                <button class="ins-btn sm-btn blue" id="saveHealthinfo">保存</button>
            </div>
        </div>
        <div class="form-content margin-t-6_125 BL-pad-b-2" v-cloak>
            <div class="form-wrap">
            	<!--投保人-->
                <div class="table-wrap" v-if="showAppl&&matters">
                    <div class="item">
                        <ul class="flex table-title">
                            <li class="flex-1" style="line-height:3.125rem;">投保人健康告知</li>
                            <li class="item-operate" @tap="appfolder=!appfolder"><span class="bene-up-icon mui-icon mui-icon-arrowup" :class="{'bene-up-icon-rotate':appfolder}"></span></li>
                        </ul>
                    </div>
                   <div v-for="(item,index) in matters" v-if="isShow(item.entry,2)"  v-show="!appfolder">
                        <ul class="flex">
                            <li class="flex-1">{{item.entry}}.&nbsp;{{item.content}}</li>
                            <li class="item-operate BL-mar-t-1">
                                <button class="ins-btn sm-btn BL-mar-b_5" :class="{'blue':clientvalue.app_amswer[item.id]}" :disabled="clientvalue.app_amswer[item.id]" @tap="appChange(item.id,true),toblur()">是</button>
                                <button class="ins-btn sm-btn" :class="{'blue':!clientvalue.app_amswer[item.id]}" :disabled="!clientvalue.app_amswer[item.id]" @tap="appChange(item.id,false),toblur()">否</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <!--投保人-->
                <!--被保人-->
                <div class="table-wrap" v-if="matters">
                    <div class="item">
                        <ul class="flex table-title">
                            <li class="flex-1" style="line-height:3.125rem;">被保人健康告知</li>
                            <li class="item-operate" @tap="assfolder=!assfolder"><span class="bene-up-icon mui-icon mui-icon-arrowup" :class="{'bene-up-icon-rotate':assfolder}"></span></li>
                        </ul>
                    </div>
                    <div v-for="(item,index) in matters" v-if="isShow(item.entry,1)"  v-show="!assfolder">
                        <ul class="flex">
                            <li class="flex-1">{{item.entry}}.&nbsp;{{item.content}}</li>
                            <li class="item-operate BL-mar-t-1">
                                <button class="ins-btn sm-btn BL-mar-b_5" :class="{'blue':clientvalue.ass_amswer[item.id]}" :disabled="clientvalue.ass_amswer[item.id]" @tap="assChange(item.id,true),toblur()">是</button>
                                <button class="ins-btn sm-btn" :class="{'blue':!clientvalue.ass_amswer[item.id]}" :disabled="!clientvalue.ass_amswer[item.id]" @tap="assChange(item.id,false),toblur()">否</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <!--被保人-->
                <div class="mui-input-row mui-checkbox mui-left">
                    <label>1. 本人承诺上述内容与客户告知事实一致，并无虚假和重大遗漏。<br>2. 本人愿意承担因不实告知带来的所有责任</label>
                    <input name="checkbox" value="Item 1" type="checkbox" v-model="promise">
                </div>
            </div>
        </div>
    </div>
    <!--弹窗 end-->

</div>
</body>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="method.js"></script>
<script type="text/babel">
    mui.init();


    var health = new Vue({
        el: '#Js-content',
        data: function() {
            return {
            	appfolder: false,
                assfolder: false,
                isAssuWm: false, //被保人是否为女性
                isApplWm: false, //投保人是否为女性
                matters: {},
                promise: false,
                showAppl: false,
                assuAge: '',//被保人年龄
                clientvalue: {
                    ass_amswer: {}, //被保险人勾选
                     app_amswer: {}, //投保人勾选
                    fields: {}, //被保人用户字段
                }
            }
        },
        methods:{
            toblur:function(){
                document.activeElement.blur();
            },
            assChange:function(id,state){
                this.clientvalue.ass_amswer[id] = state;
                this.$forceUpdate();
            },
            appChange:function(id,state){
                this.clientvalue.app_amswer[id] = state;
                this.$forceUpdate();
            },
//          getIndex:function(id, chief) {
//              for (var i in this.matters) {
//                  var item = this.matters[i]
//                  if (item.id === id && !chief) {
//                      return i
//                  }
//                  if (item.id === chief) {
//                      for (var j = 0; j < item.child.length; j++) {
//                          if (item.child[j].id === id) {
//                              return i + item.child[j].entry
//                          }
//                      }
//                  }
//              }
//              return -1
//          },
            isShow:function(i, type) {
            	i = i.trim()
                if (i == 'E013' && type === 2 && !this.isApplWm ) {
                    return false
                }
                if (i == 'E013' && type === 1 && !this.isAssuWm) {
                    return false
                }
                if (i === 'E014' && (type === 1 || (i === 'E014' && type === 2 && this.assuAge < 2))) {
                    return false
                }
                return true
            },
            checkForm:function() {
                var toast_text = null
                if (!this.promise) {
                    mui.toast('请阅读用户承诺并确认', {duration: 'short', type: 'div'});
                    return false
                }
                return true
            }
        }
    });
    mui.plusReady(function () {
        var popu = new ClosePopu(); // 实例化关闭窗口对象

        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            popu.closepop();
        });
        //
        var assured = plus.storage.getItem('guohua_assured') ? JSON.parse(plus.storage.getItem('guohua_assured')) : '';
        var applicant = plus.storage.getItem('guohua_applicant') ? JSON.parse(plus.storage.getItem('guohua_applicant')) : '';
        var hinfo = plus.storage.getItem('guohua_healthinfo') ? JSON.parse(plus.storage.getItem('guohua_healthinfo')) : ''
        var safegoods = plus.storage.getItem('guohua_safegoods') ? JSON.parse(plus.storage.getItem('guohua_safegoods')) : ''
        
        health.assuAge = getAge(assured.insured_birthday)
		health.isApplWm = applicant.holder_gender === FEMALE ? true : false
        health.isAssuWm = assured.insured_gender === FEMALE ? true : false
        mui.each(safegoods, function (index, item) {
        	if(item.code === '1165V1') {
        		 health.showAppl = true
        		 health.appfolder = false
        	}
        })
        //赋值
        console.log(plus.storage.getItem('guohua_healthinfo'));
        hinfo && setHealth(hinfo)
		 function setHealth(data) {
            console.log('赋值健康告知')
            mui.each(data, function (index, item) {
                if (item.insured_answer === '1') {
                    health.clientvalue.ass_amswer[item.mv_id] = true
                }

                if (health.showAppl && item.holder_answer === '1') {
                    health.clientvalue.app_amswer[item.mv_id] = true
                }
            })
        }
        //保存
        document.querySelector('#saveHealthinfo').addEventListener('tap', function () {
            if (!health.checkForm()) {
                return false
            }
            //
            var appitems = []
            mui.each(health.matters, function (index, item) {
                var insured_answer = health.clientvalue.ass_amswer[item.id] ? '1' : '0'
                 var holder_answer = health.clientvalue.app_amswer[item.id] ? '1' : '0'
//              var insured_fields = health.clientvalue.fields[item.id] ? health.clientvalue.fields[item.id] : ''
//            	 var holder_fields = health.clientvalue.app_fields[item.id] ? health.clientvalue.app_fields[item.id] : ''
              appitems.push({
                    mv_id: item.id,
                        insured_answer: insured_answer,
                        holder_answer: holder_answer,
                        insured_fields: '',
                        holder_fields: ''
                })
            })
            //
            plus.storage.setItem('guohua_healthinfo', JSON.stringify(appitems));
            mui.fire(plus.webview.getWebviewById('gh_insurance-index'), 'saveFlag', {
                item: 'guohua_healthinfo',
                data: 'healthinfo'
            });
            
            popu.closepop();
            mui.back();
        })
        //
        mui('body').on('tap', '#close-ins-pop', function () {
            // 关闭遮罩层，弹框
            popu.closepop();
        });
        health.$nextTick(function () {
            plus.nativeUI.closeWaiting();
        })
        //获取健康告知题目
        luckyAjax({
            data: {data: JSON.stringify({'supplier_id': SCID, 'version': '1'}), server: 'PolicyIns.getMatterList'},
            success: function (res) {
                if (res.code) {
                    health.matters = res.data;
                } else {

                }
            }
        });
    });
</script>
</html>
