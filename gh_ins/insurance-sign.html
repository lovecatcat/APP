<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/form.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
    <link href="../css/signature.css" rel="stylesheet"/>
</head>

<body>

<div id="Js-content" class="mui-content BL-rel" v-cloak="">
    <!--弹窗 begin-->
    <div class="ins-dialog xs">
        <div class="dialog-header">
            <div class="mui-icon mui-icon-closeempty" id="close-ins-pop"></div>
            <p class="ins-font-md box-f-1">信息确认</p>
            <div class="header-btn-save">
                <button class="ins-btn sm-btn blue" id="saveSign">核保</button>
            </div>
        </div>
        <div class="form-content margin-t-6_125 BL-pad-b-1">
            <div class="form-wrap margin-t_875">
                <div class="border-b-e7e7e7">
                    <div class="item-title">信息确认</div>
                </div>
                <div class="BL-pad-a1">
                    <div v-if="newproduct">
                        <div class="mui-input-row mui-checkbox mui-left BL-mar-t-1" >
                            <label style="padding-left: 3rem;line-height: 2rem;">本人已阅读保险条款、产品说明书和投保提示书，了解本产品的特点和保单利益的不确定性。
                                <input name="checkbox" v-model="agree" type="checkbox" style="top: 20px; left: 0px;"></label>
                        </div>
                        <div class="mui-input-row BL-ftz-42 BL-pad-lr-1_25" style="line-height: 2rem;">
                            <a class="BL-col-3b9cf5" type="button" disabled @tap="showStatement(item.safe_id,item.name)" v-for="(item,index) in safegoods" v-show="item.name"><strong>《{{item.name}}保险条款》</strong></a>
                            、<a type="button" @tap="cjbdesc" class="BL-col-3b9cf5"><strong>《恒大传家宝年金保险（万能型）产品说明书 》</strong></a>、
                            <a type="button" id="safenotice" class="BL-col-3b9cf5"><strong>《人身保险投保提示书》</strong></a>、
                            <a type="button" id="mustknow" class="BL-col-3b9cf5"><strong>《投保须知》</strong></a>、
                            <a type="button" id="statement" class="BL-col-3b9cf5"><strong>《银行自动转账授权事项》</strong></a>、
                            <a type="button" id="signstatement" class="BL-col-3b9cf5"><strong>《声明授权与签名》</strong></a>
                        </div>
                    </div>
                    <div class="mui-input-row mui-checkbox mui-left BL-mar-t-1" v-else>
                        <label style="padding-left: 3rem;line-height: 2rem;">本人已阅读
                            <a class="BL-col-3b9cf5" type="button" disabled @tap="showStatement(item.safe_id,item.name)" v-for="(item,index) in safegoods" v-show="item.name"><strong>《{{item.name}}保险条款》</strong></a>
                            、和<a type="button" id="safenotice" class="BL-col-3b9cf5"><strong>《人身保险投保提示书》</strong></a>、
                            <a type="button" id="mustknow" class="BL-col-3b9cf5"><strong>《投保须知》</strong></a>、
                            <a type="button" id="statement" class="BL-col-3b9cf5"><strong>《银行自动转账授权事项》</strong></a>、
                            <a type="button" id="signstatement" class="BL-col-3b9cf5"><strong>《声明授权与签名》</strong></a>
                            ，并确认无误
                            <input name="checkbox" v-model="agree" type="checkbox" style="top: 20px; left: 0px;">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    
    </div>
</div>

</body>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="../js/signature/signature_pad.js" type="text/javascript"></script>
<script src="../js/copy.js" type="text/javascript"></script>
<script src="../js/pdf.js" type="text/javascript"></script>
<script src="method.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var popu;
    mui('body').on('tap', '#statement', function () {
        mui.openWindow({
            url: 'pay-statement.html',
            id: 'pay_statement',
            show: animateObj.aniDetal
        })
        return false
    })
    mui('body').on('tap', '#safenotice', function () {
        mui.openWindow({
            url: 'safe-notice.html',
            id: 'safe_notice',
            show: animateObj.aniDetal
        })
        return false
    })
    mui('body').on('tap', '#mustknow', function () {
        mui.openWindow({
            url: 'mustknow.html',
            id: 'mustknow',
            show: animateObj.aniDetal
        })
        return false
    })
    mui('body').on('tap', '#signstatement', function () {
        mui.openWindow({
            url: 'sign-statement.html',
            id: 'sign_statement',
            show: animateObj.aniDetal
        })
        return false
    })
    mui.plusReady(function () {
        popu = new ClosePopu(); // 实例化关闭窗口对象

        var war_id = plus.webview.currentWebview().data;
        if (war_id) {
            img.war_id = war_id
        } else {
            mui.toast("保单不存在", {duration: 'long', type: 'div'})
            return false;
        }

        var itemName = ['hengda_applicant','hengda_assured','hengda_beneficiary','hengda_safegoods','hengda_healthinfo','hengda_bank','hengda_upload','hengda_ids'];
        var assured = plus.storage.getItem('hengda_assured') ? JSON.parse(plus.storage.getItem('hengda_assured')): ''
        var safegoods = plus.storage.getItem('hengda_safegoods') ? JSON.parse(plus.storage.getItem('hengda_safegoods')): ''
        img.safegoods = safegoods
        console.log(JSON.stringify(safegoods))
        mui.each(safegoods, function (index, item) {
            if (item.code === cjb || item.code === fxjs) {
                img.newproduct = true
            }
        })
        img.assured = assured
        //赋值
        img.getSignature(1,true);
        img.getSignature(2,true);
        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            popu.closepop();
            mui.fire(plus.webview.getWebviewById('hd_insurance-index'), 'resetLoading');
        });
        //保存
        document.querySelector('#saveSign').addEventListener('tap', function () {
            if (!img.agree) {
                mui.toast("请确认阅读相关条款声明并同意转账授权与声明", {duration: 'short', type: 'div'})
                return false;
            }
            if (!img.checkForm()) {
                return false
            }
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {insured_ID_no: assured.insured_ID_no},
                        company_code: 'HengDa',
                        method: 'getLastInsured'
                    }),
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 10000,
                success: function (res) {
                    if (res.code) {
                        mui.toast('核保中...', {duration: 'long', type: 'div'})
                        online_ins()
                    } else {
                        mui.toast("该被保人有正在处理的保单，请稍后再次尝试。", {duration: 'long', type: 'div'})
                        return false;
                    }
                }
            });
        })
        //
        mui('body').on('tap', '#close-ins-pop', function () {
            // 关闭遮罩层，弹框
            popu.closepop();
            mui.fire(plus.webview.getWebviewById('hd_insurance-index'), 'resetLoading');
        });

        mui('body').on('tap', '.btn-copy', function (e) {
            var copy_url = this.getAttribute('data-url')
            if (Clipbord(copy_url)) {
                mui.toast("复制成功", {duration: 'short', type: 'div'})
            }
        });

        //核保
        function online_ins() {
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {policy_id: img.war_id},
                        company_code: 'HengDa',
                        method: 'insure'
                    }),
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 30000,
                success: function (res) {
                    if (res.code) {
                        if (res.data.resultCode === '00') {
                            mui.toast('自核通过，影像上传中', {duration: 'long', type: 'div'})
                            //清除本地缓存
                            for (var i = 0; i < itemName.length; i++) {
                                plus.storage.removeItem(itemName[i])
                            }
                            upload_img(img.war_id)
                        } else if (res.data.resultCode === '02') {
                            mui.toast('进入人工核保，影像上传中', {duration: 'long', type: 'div'})
                            //清除本地缓存
                            for (var i = 0; i < itemName.length; i++) {
                                plus.storage.removeItem(itemName[i])
                            }
                            upload_img(img.war_id)
                        } else {
                            mui.toast(res.data && res.data.resultMsg ? res.data.resultMsg : '网络出错，请稍后再试', {
                                duration: 'long',
                                type: 'div'
                            })
                            return false
                        }
                    } else {
                        mui.toast(res.data.resultMsg, {duration: 'long', type: 'div'})
                        return false
                    }
                }
            });
        };

        //上传影像
        function upload_img(id) {
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {policy_id: id},
                        company_code: 'HengDa',
                        method: 'update_img'
                    }),
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 10000,
                success: function (res) {
                    for (var i = 0; i < 8; i++) {
                        console.log(itemName[i])
                        plus.storage.removeItem(itemName[i])
                    }
                    if (res.code) {
                        if (res.data.resultCode === '00') {
                            mui.toast('上传成功，承保中', {duration: 'short', type: 'div'})
                            ins_pay(id)
                            return false
                        } else {
                            mui.toast(res.data && res.data.resultMsg ? res.data.resultMsg : '网络出错，请稍后再试', {duration: 'long', type: 'div'})
                            return false
                        }
                    } else {
                        mui.toast(res.data.resultMsg, {duration: 'long', type: 'div'})
                        return false
                    }
                }
            });
        };
        //承保接口调完后
        function afterPay(clear) {
            if (clear) {
                //清除本地缓存
                for (var i = 0; i < itemName.length; i++) {
                    plus.storage.removeItem(itemName[i])
                }
            }
            setTimeout(function () {
                mui.openWindow({
                    url: '../member-life-order.html',
                    id: 'member_life_order',
                    show: animateObj.aniDetal
                })
                setTimeout(function () {
                    plus.webview.close('hd-insurance-sign');
                    plus.webview.close('hd_insurance-index');
                    mui.fire(plus.webview.getWebviewById('member_life_order'), 'reload');
                }, 500)
            }, 3000)
        }
        //承保
        function ins_pay(id) {
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {policy_id: id},
                        company_code: 'HengDa',
                        method: 'pay'
                    }),
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 10000,
                success: function (res) {
                    if (res.code) {
                        if (res.data.resultCode === '00') {
                            mui.toast('承保成功', {duration: 'long', type: 'div'});
                            afterPay(true)
                        } else if (res.data.resultCode === '02') {
                            mui.toast(res.data.resultMsg, {duration: 'long', type: 'div'});
                            afterPay(true)
                        } else {
                            mui.toast(res.data && res.data.resultMsg ? res.data.resultMsg : '承保失败', {
                                duration: 'long',
                                type: 'div'
                            })
                            afterPay()
                        }
                    } else {
                        mui.toast('网络出错，请稍后再试', {duration: 'long', type: 'div'})
                        return false
                    }
                }
            });
        };
        //
    });

    Vue.component('sign', {
        template: '#sign',
        props: ['index'],
        data:function() {
            return {
                signature: null,
                styles: null
            }
        },
        mounted:function() {
            const lwRatio = 2 / 5
            var canvas = document.getElementById('canvas' + this.index)
            if (!canvas) return
            this.styles = {
                height: (canvas.parentNode.offsetWidth * lwRatio).toFixed(0) + 'px'
            }
            var vm = this

            function resizeCanvas() {
                var ratio = Math.max(window.devicePixelRatio || 1, 1)
                canvas.width = canvas.offsetWidth * ratio
                canvas.height = canvas.offsetWidth * lwRatio * ratio
                canvas.getContext('2d').scale(ratio, ratio)
            }

            window.onresize = resizeCanvas
            resizeCanvas()
            vm.signature = new SignaturePad(canvas, {
                minWidth: 2,
                maxWidth: 3.5
            })
        },
        destroyed:function() {
            this.signature.off()
            this.signature = null
        },
        methods: {
            clear:function() {
                this.signature && this.signature.clear()
            },
            save:function(index) {
                if (this.signature.isEmpty()) {
                    mui.toast("签名不能为空", {duration: 'short', type: 'div'})
                    return
                }
                var base64 = this.signature.toDataURL()
                if (index == 1) {
                    this.setApplSN(base64)
                } else if (index == 2) {
                    this.setAssuSN(base64)
                }
                this.$parent.save_ins(index)
                this.$parent.showSign[this.index] = false
                this.clear()
            },
            setApplSN:function(base64) {
                base64 && (this.$parent.appl_signature = base64, this.$parent.previewImg[1] = base64)
                this.$forceUpdate()
            },
            setAssuSN:function(base64) {
                base64 && (this.$parent.assu_signature = base64, this.$parent.previewImg[2] = base64)
                this.$forceUpdate()
            },
        }
    });
    var img = new Vue({
        el: '#Js-content',
        data:function() {
            return {
                agree: false,
                safegoods: '',
                newproduct: false, //是否含新型产品（福享金生、传家宝）
                war_id: '',
                assured: {},
                appl_signature: '',
                assu_signature: '',
                showSign: {
                    1: false,
                    2: false
                },
                previewImg: [] //上传图片
            }
        },
        methods: {
            cjbdesc: function () {
                mui.openWindow({
                    url: '../pdf-modal.html',
                    id: 'pdf_modal',
                    show: animateObj.aniDetal,
                    extras: {
                        pdf: config.domain + '/static/file/cjb.pdf',
                        name: '恒大传家宝年金保险（万能型）产品说明书'
                    },
                    waiting: {
                        auto: false,
                    }
                });
            },
            //主险条款
            showStatement: function (id, name) {
                luckyAjax({
                    data: {
                        data: JSON.stringify({product_id: id}),
                        server: 'lifeProduct.getProductInfo'
                    },
                    success: function (data) {
                        plus.nativeUI.closeWaiting();
                        if (data.code === 1) {
                            if (data.data.statement) {
                                mui.openWindow({
                                    url: '../pdf-modal.html',
                                    id: 'pdf_modal',
                                    show: animateObj.aniDetal,
                                    extras: {
                                        pdf: data.data.statement,
                                        name: name
                                    },
                                    waiting: {
                                        auto: false,
                                    }
                                });
                            } else {
                                mui.toast('暂无条款详情', {duration: 'short', type: 'div'});
                                return false;
                            }
                        }
                    }
                })
            },
            //保存签名
            save_ins: function(type) {
                const vm = this
                var data = {}
                if (type == 1) {
                    data.img_json = {
                        '06': vm.appl_signature
                    }
                } else {
                    data.img_json = {
                        '07': vm.assu_signature
                    }
                }
                data.id = vm.war_id
                luckyAjax({
                    data: {
                        data: JSON.stringify(data),
                        server: 'PolicyIns.saveImg',
                        view: true,
                        device: 'mobile'
                    },
                    timeout: 10000,
                    success: function (res) {
                        if (res.code) {
                            mui.toast(res.msg, {duration: 'short', type: 'div'})
                        } else {
                            mui.toast(res.msg, {duration: 'short', type: 'div'})
                        }
                    }
                });
            },
            sure: function () {
                popu.closepop();
            },
            checkForm: function () {
                var toast_text = null;
                if (!this.appl_signature) {
                    toast_text = '投保人签名不能为空';
                } else if (this.assured.rel_insured_holder!==ISASSURED && !this.assu_signature) {
                    toast_text = '被保人签名不能为空';
                }
                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    return false;
                }
                return true;
            },
            getSignature: function (index,notoast) {
                var toast_text = null
                var vm = this
                if (!index) return
                // 获取签名的ajax
                luckyAjax({
                    data: {
                        data: JSON.stringify({policy_id: this.war_id}),
                        server: 'PolicyIns.policyDetails',
                        device: 'mobile'
                    },
                    success: function (res) {
                        if (res.code) {
                            var image = res.data.policyInfo.img_json
                            if ( index === 1 && image['06']) {
                                toast_text = '成功获取投保人签名'
	                        	vm.appl_signature = config.domain + image['06']
                                vm.$set(vm.previewImg, 1, config.domain + image['06'])
	                        } else if ( index === 2 && image['07']) {
                                toast_text = '成功获取被保人签名'
                                vm.assu_signature = config.domain + image['07']
                                vm.$set(vm.previewImg, 2,  config.domain + image['07'])
	                        } else {
                                toast_text = '签名不存在'
                            }
                            if (toast_text && !notoast) {
                                mui.toast(toast_text, {duration: 'short', type: 'div'});
                                return false;
                            }
                        } else {
                            if (!notoast) {
                                mui.toast('签名不存在', {duration: 'short', type: 'div'});
                                return false;
                            }
                        }
                    }
                });
            },
        }
    })
</script>
</html>