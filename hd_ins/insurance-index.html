<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body class="BL-bg-f2f">

<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
        <h1 class="BL-title">恒大在线投保</h1>
    </div>
</header>
<div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY">
    <form class="mui-input-group BL-mar-t-1">
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(1)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':applicant}">投保人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(2)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':assured}">被保人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(3)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':beneficiary}">受益人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(4)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':safegoods}">险种信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(5)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':healthinfo}">健康告知信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(6)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':bank}">付款信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpopu(7)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':upload}">上传证件</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
    </form>
    <div class="BL-mar-t-3 BL-pad-lr-1_5">
        <a type="button" id="ins-save" class="form-btn blue">提交</a>
    </div>
</div>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="../js/IDValidator.min.js"></script>
<script src="method.js"></script>
<!--<script type="text/babel">-->
<script type="text/javascript">
    mui.init();
    mui.plusReady(function () {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;
        document.querySelector('#Js-content').style.height = winH - titHeight + 'px';
        var itemName = ['hengda_applicant','hengda_assured','hengda_beneficiary','hengda_safegoods','hengda_healthinfo','hengda_bank','hengda_upload','hengda_ids','userinfo'];
        // 预创建子页面
//        var subWvs = [];//存储窗口对象数组
        var subpages = ["insurance-applicant", "insurance-assured", "insurance-beneficiary", "insurance-safegoods", "insurance-healthinfo", "insurance-bank", "insurance-upload"];
//        for(var i = 0; i < subpages.length; i++) {
//            var subWv = plus.webview.create(subpages[i] + '.html', subpages[i], { //创建窗口：弹框
//                width: "100%",
//                height: '100%',
//                background: 'transparent',
//                popGesture: "none"
//            });
//            subWvs.push(subWv);
//        };
        //
        var index = new Vue({
            el: '#Js-content',
            data: function() {
                return {
                    userinfo: '',
                    init: {},
                    ids: '',
                    applicant: '',
                    assured: '',
                    beneficiary: '',
                    safegoods: '',
                    healthinfo: '',
                    bank: '',
                    sign: '',
                    upload: ''
                }
            },
            created:function(){
                console.log('index-created')
                var dataName = ['applicant','assured','beneficiary','safegoods','healthinfo','bank','upload','ids','userinfo'];
                for(var i = 0; i < itemName.length; i++) {
                    this.getItem(itemName[i],dataName[i])

                }
                this.$forceUpdate()
            },
            methods:{
                //获取存储数据
                getItem:function(item,data){
                    console.log('getItem:' + item + '===' + data)
                    this[data] = plus.storage.getItem(item) ? JSON.parse(plus.storage.getItem(item)) : ''
                    this.$forceUpdate();
                },
                //弹窗
                showpopu:function(e) {
                    if (e === 2 && !this.applicant) {
                        mui.toast('请填写投保人信息', {duration: 'short', type: 'div'});
                        return false
                    } else if (e === 3 && !this.assured) {
                        mui.toast('请填写被保人信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 4 && !this.beneficiary) {
                        mui.toast('请填写受益人信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 5 && !this.safegoods) {
                        mui.toast('请填写险种信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 6 && !this.healthinfo) {
                        mui.toast('请填写健康告知信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 7 && !this.bank) {
                        mui.toast('请填写付款信息', {duration: 'short', type: 'div'})
                        return false
                    }
                    showPopu(subpages[e-1] + '.html', 'hd-'+subpages[e-1], "bottom", index.init);
//                    var _self = plus.webview.currentWebview();
//                    _self.setStyle({
//                        mask: 'rgba(0,0,0,0.5)'
//                    }); // 显示遮罩层
//                    subWvs[e].show(animateObj.aniForm.aniShow, animateObj.aniForm.duration);
                }
            }
        });
        //保存数据更新
		window.addEventListener('saveFlag', function (e) {
		    console.log('saveFlag')
		    console.log(JSON.stringify(e.detail))
			index.getItem(e.detail.item,e.detail.data)

        });
        //整理下拉框需要的数据
        function dataToselect(data, type) {
            var arr = [];
            mui.each(data, function (ind, ite) {
                arr.push({
                    text: type ? ite.name : ite.enum_name,
                    value: ite.id
                });
            });
            return arr;
        }

        //初始化下拉数据获取
        luckyAjax({
            data: {
                data: JSON.stringify({'supplier_id': SCID}),
                server: 'PolicyIns.initPolicyField'
            },
            success: function (data) {
                if (data.code) {
                    var res = {}
                    var data = data.data;
                    mui.each(data, function (index, item) {
                        var itemdata = item.child;
                        if (item.cate === 'AA') {
                            res.ID_type = dataToselect(itemdata); //证件类型
                        } else if (item.cate === 'AB') {
                            res.gender = dataToselect(item.child); //性别
                        } else if (item.cate === 'AC') {
                            res.is_assured = dataToselect(item.child); //与投保人关系
                        } else if (item.cate === 'AD') {
                            res.marriage = dataToselect(item.child); //婚姻状况
                        } else if (item.cate === 'AE') {
                            res.occupation = dataToselect(item.child); //职业
                        } else if (item.cate === 'AF') {
                            res.annual_source = dataToselect(item.child);//收入来源
                        } else if (item.cate === 'AG') {
                            res.social_security = dataToselect(item.child); //是否有社保
                        } else if (item.cate === 'AH') {
                            res.tax_type = dataToselect(item.child); //税收类型
                        } else if (item.cate === 'AI') {
                            res.nation = dataToselect(item.child); //国籍
                        } else if (item.cate === 'AJ') {
                            res.drving_type = dataToselect(item.child); //驾照类型
                        } else if (item.cate === 'AL') {
                            res.resident_type = dataToselect(item.child); //居民类型
                        } else if (item.cate === 'AN') {
                            res.relation_beneficiary = dataToselect(item.child); //受益人与被保人关系
                        } else if (item.cate === 'AO') {
                            res.beneficiary_type = dataToselect(item.child); //受益人类型 法定 指定
                        } else if (item.cate === 'AP') {
                            res.benefit_type = dataToselect(item.child); //受益类型 身故
                        } else if (item.cate === 'AV') {
                            res.bank_code = dataToselect(item.child); //银行代码
                        } else if (item.cate === 'area') {
                            res.province = dataToselect(item.child, true); //省
                        } else if (item.cate === 'BB') {
                            res.nj_safe_year = dataToselect(item.child); //年金保障年限
                        } else if (item.cate === 'BC') {
                            res.nj_get_way = dataToselect(item.child); //年金领取方式
                        } else if (item.cate === 'BD') {
                            res.nj_get_type = dataToselect(item.child); //年金领取类型
                        }
                    });
                    index.init = res;
                }
            }
        });
        //申请核保
        document.querySelector('#ins-save').addEventListener('tap', function () {
            console.log(typeof index.beneficiary)
            var toast_text = null
            var war_id = index.ids ? Number(index.ids.policy_id) : ''
            war_id && deleteItem(war_id, '', 'content')
            war_id && deleteItem(war_id, '', 'beneficiary')
            war_id && deleteItem(war_id, '', 'matter_value')
            //保存前再次校验
            if (!index.applicant) {
                mui.toast('请填写投保人信息', {duration: 'short', type: 'div'});
                return false;
            }
            if (!checkAppl(index.applicant)) {
                return false;
            }
            if (!index.assured) {
                mui.toast('请填写被保人信息', {duration: 'short', type: 'div'});
                return false;
            }
            RSChanged(index.assured,index.applicant);
            if (!checkAssured(index.assured)) {
                return false
            }
            if (!index.beneficiary) {
                mui.toast('请填写受益人信息', {duration: 'short', type: 'div'});
                return false;
            }
            //
            if (!index.safegoods) {
                toast_text = '请填写险种信息';
            } else if (!index.healthinfo) {
                toast_text = '请填写健康告知信息';
            } else if (!index.bank) {
                toast_text = '请填写付款信息';
            } else if (!index.upload) {
                toast_text = '请上传证件';
            }
            if(toast_text){
                mui.toast(toast_text, {duration: 'short', type: 'div'});
                return false;
            }
            //
            var pushdata = {}
            pushdata.id = war_id
            pushdata.supplier_id = SCID
            pushdata.ins_area = '323' //深圳
            pushdata.sales_channel = '2'
            pushdata.is_first = '1'
            pushdata.user_id = index.userinfo.id
            //投保人信息
            var applfieldFilter = ['holder_contact_address_select', 'holder_has_SSID', 'resident_type', 'temp_holder_job_code', 'mail_addr_type', 'holder_ID_type_name', 'holder_nation_name', 'holder_salary_from_name', 'holder_home_district_name', 'holder_contact_province_name', 'holder_contact_city_name', 'holder_contact_district_name', 'holder_job_name', 'holder_isTaxResidents']
            for (var i in index.applicant) {
                if (applfieldFilter.indexOf(i) === -1) {
                    pushdata[i] = index.applicant[i]
                }
            }
            pushdata.holder_has_SSID = index.applicant.holder_has_SSID ? has_social_security : no_social_security
            //被保人信息
            var insured = {}
            insured.id = index.ids ? Number(index.ids.insured_id) : ''
            var assufieldFilter = ['insured_has_SSID', 'insured_temp_job_code', 'addr_type', 'insured_isTaxResidents', 'insured_job_name', 'insured_ID_type_name', 'insured_nation_name', 'insured_salary_from_name', 'insured_home_district_name']
            for (var i in index.assured) {
                if (assufieldFilter.indexOf(i) === -1) {
                    insured[i] = index.assured[i]
                }
            }
            insured.has_insured_SSID = index.assured.insured_has_SSID ? has_social_security : no_social_security
            pushdata.insured = insured
            //险种信息
            var content = []

            var totalfee = 0
            mui.each(index.safegoods, function (index, item) {
                var safeitem = {}
                safeitem.is_main = item.is_main ? '1' : '0' //是主险
                safeitem.product_id = item.safe_id
                safeitem.period_payment = item.pay_year
                safeitem.period_guanantee = item.safe_year
                safeitem.fee = item.period_money
                safeitem.amount = item.money
                totalfee += Number(item.period_money)
                if (item.safe_id.toString() === qwhh) {
                    safeitem.quantity = (item.money / 50000).toString()
                }
                safeitem.extend_items = {
                    autoApl: item.autoApl ? '1' : '0',
                    guarantee_term: item.guarantee_term,
                    draw_freq: item.draw_freq,
                    draw_age: item.draw_age,
                    shareDrawType: item.shareDrawType
                }
                content.push(safeitem)
            })

            pushdata.total = totalfee.toFixed(2) //总保费
            pushdata.content = content
            //受益人信息
            pushdata.beneficiary = []
            if (index.beneficiary === 1) {
                pushdata.is_legal_benefic = '1'
            } else {
                pushdata.is_legal_benefic = '0'
                var benefieldFilter = ['ID_type_name', 'address_select'];
                for (var i in index.beneficiary) {
                    if (benefieldFilter.indexOf(i) === -1) {
                        pushdata.beneficiary.push(index.beneficiary[i])
                    }
                }
            }
            //银行信息
            for (var i in index.bank) {
                pushdata[i] = index.bank[i]
            }
            //健康告知
            pushdata.matter = index.healthinfo
            //影像
            pushdata.img_json = index.upload
            //
            var extend_items = {}
            extend_items.resident_type = index.applicant.resident_type;
            extend_items.isTaxResidents = index.applicant.holder_isTaxResidents;
            extend_items.isTaxResidentsInsured = index.assured.insured_isTaxResidents;
            extend_items.mail_addr_type = index.applicant.mail_addr_type ? '1' : '0'
            extend_items.addr_type = index.assured.addr_type ? '1' : '0'
            pushdata.extend_items = extend_items

            console.log('==================')
            console.log(JSON.stringify(pushdata.content))
//            console.log(JSON.stringify(pushdata))

            save_ins(pushdata);
        });
        //删除保存的某条数据
        function deleteItem(war_id, itemId, type) {
            luckyAjax({
                data: {
                    data: JSON.stringify({"table": type, "id": itemId, "policy_id": war_id}),
                    server: 'PolicyIns.deleteInsInfo'
                },
                success: function (res) {
                    if (res.code) {
                        //
                    } else {
                        console.log(res.msg)
//                        mui.toast(res.msg, {duration: 'short', type: 'div'})
                    }
                }
            });
        }
        //保存保单
        function save_ins(data) {
            luckyAjax({
                data: {data: JSON.stringify(data), server: 'PolicyIns.save'},
                success: function (res) {
                    if (res.code) {
                        plus.storage.setItem('hengda_ids',JSON.stringify(res.data));
                        showPopu('insurance-sign.html', 'hd-insurance-sign', "bottom");
                    } else {
                        mui.toast(res.msg, {duration: 'short', type: 'div'})
                    }
                }
            });
        };
        //
        var old_back = mui.back;
        mui.back = function () {
            for (var i = 0; i < 8; i++) {
                console.log(itemName[i])
                plus.storage.removeItem(itemName[i])
            }
            old_back();
        }
        //
    })

</script>
</body>
</html>
