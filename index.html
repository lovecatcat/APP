<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<script src="js/config.js" type="text/javascript"></script>
		<script src="js/upgrade.js" type="text/javascript"></script>
	</head>

	<body class="BL-bg-f2f">

		<!----------- 主导航  begin -------------->
		<nav id="Js-nav" style="opacity: 0;" class="mui-bar mui-bar-tab BL-bg-fff BL-mod-footNav BL-Border-t">
			<a data-index="0" class="mui-tab-item footNav-item mui-active">
				<span class="footNav-icon footNav-icon-hm" id="homeicon"></span>
				<span class="footNav-label" id="homename">首页</span>
			</a>
			<a data-index="1" class="mui-tab-item footNav-item">
				<span class="footNav-icon footNav-icon-prospect"></span>
				<span class="footNav-label">计划书</span>
			</a>
			<a data-index="2" class="mui-tab-item footNav-item">
				<span class="footNav-icon footNav-icon-discover"></span>
				<span class="footNav-label">发现</span>
			</a>
			<a data-index="3" class="mui-tab-item footNav-item">
				<span class="footNav-icon footNav-icon-user"></span>
				<span class="footNav-label">我</span>
			</a>
		</nav>
		<!----------- 主导航  end ---------------->

	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script src="js/Tunnel.js" type="text/javascript"></script>
	<script src="js/upgrade.js" type="text/javascript"></script>
	<script type="text/javascript">
		var navHeight = document.querySelector('#Js-nav').offsetHeight / sizeObj.dpl;
		localStorage.setItem("winH", window.innerHeight); // 储存窗口高度
		localStorage.setItem("navHeight", document.querySelector('#Js-nav').offsetHeight); // 储存底部导航高度

		mui.plusReady(function() {
			var nums = 0;
            var userinfo = plus.storage.getItem('userinfo') ? JSON.parse(plus.storage.getItem('userinfo')) : '';
            var locationd = null, type=0;
            
            //读取本地存储，检查是否为首次启动
			var showGuide = localStorage.getItem("lauchFlag");
			//仅支持竖屏显示
			plus.screen.lockOrientation("portrait-primary");
            if(showGuide) {
				//有值，说明已经显示过了，无需显示；
				//关闭splash页面；
				plus.navigator.closeSplashscreen();
				plus.navigator.setFullscreen(false);
			} else {
				//显示启动导航
				mui.openWindow({
					id: 'guide',
					url: 'guide.html',
					styles: {
						popGesture: "none"
					},
					show: {
						aniShow: 'none'
					},
					waiting: {
						autoShow: false
					}
				});
					
			}
            
            window.addEventListener('closeGuide', function () {
            	if (plus.runtime.appid !== 'HBuilder') { // 开发模式不检测更新
	                //获取版本号监测是否需要更新
	                plus.runtime.getProperty(plus.runtime.appid, function (inf) {
	                    checkUpdate(inf.version, 'auto')
	                });
	            };
	            
	            if(!userinfo){
	                mui.openWindow({
	                    url:'login.html',
	                    id:'login',
						styles: {
							popGesture: "none"
						},
	                    show:{
	                        aniShow:'none'
	                    },
						waiting: {
							autoShow: false
						}
	                });
	                return false;
	            };
            })
            
            if (showGuide && plus.runtime.appid !== 'HBuilder') { // 开发模式不检测更新
                //获取版本号监测是否需要更新
                plus.runtime.getProperty(plus.runtime.appid, function (inf) {
                    checkUpdate(inf.version, 'auto')
                });
            };
            
            if(showGuide && !userinfo){
                mui.openWindow({
                    url:'login.html',
                    id:'login',
                    show:{
                        aniShow:'none'
                    }
                });
                return false;
            };
            
            if(!userinfo){
                return false;
            };
            
			//首页logo
            var logodata = null
            window.addEventListener('homeicon', function (event) {
                logodata = event.detail.data ? JSON.parse(event.detail.data) : ''
                document.getElementById('homeicon').style.backgroundImage = logodata.img_url_head ? 'url(' + logodata.img_url_head + ')' : 'url(./images/icon/nav-index-active.png)'
                document.getElementById('homename').innerHTML = logodata.module_name;
                
            	document.getElementById('Js-nav').style.opacity = 1;
            })
            
            
            /*window.addEventListener('isStopTunnel', function(data){
                if(Tunnel._webSocket && data.flag){
                    Tunnel._isStop = false;
                    Tunnel._webSocket.close();
                };
            }, false);*/
 
		    plus.geolocation.watchPosition(function(p){
		    	locationd = p;	
		    }, function(e){
				//console.log('无法获取当前位置');
			}, {
				provider:'baidu',
				enableHighAccuracy: true,
			})
		     
		    /*Tunnel.Create(JSON.parse(userinfo).id, plus.device.uuid, function (event) {
			        //console.log('Message:' + Tunnel._webSocket.readyState);
			        console.log(event.data);
			        //如果获取到消息，心跳检测重置
			        //拿到任何消息都说明当前连接是正常的
			        var _info = '';
			        var _tips = '';
			        var data = JSON.parse(event.data);
			        if(Tunnel._sessionId==''){
			        	Tunnel._sessionId = data.session_id;
			        };
			        //console.log(JSON.stringify({"uid":JSON.parse(userinfo).id,"type":5,"flag":plus.device.uuid,"platform":navigator.platform,"userAgent":navigator.userAgent,"location":locationd, "screen":plus.screen, "networkinfo":nowNetwork()}))

					switch (data.code){
					    case 1:
					        _info = '非法连接';
					        break;
					    case 2:
					        _info = '非法用户';
					        break;
					    case 3:
					        _info = '您的帐号在其它设备上登录，已经注销当前帐号';
					        break;
					    case 20:
					        _tips = data.message;
					        break;
					    case 21:
					        if(data.command == 'location'){
					        	type = 21;
							    Tunnel._webSocket.send(JSON.stringify({"uid":JSON.parse(userinfo).id,"type":5,"flag":plus.device.uuid,"platform":navigator.platform,"userAgent":navigator.userAgent,"location":locationd, "session_id":Tunnel._sessionId, "screen":plus.screen, "networkinfo":nowNetwork()}));
					        };
					        break;
					}
					if(_info != ''){
						nums++;
					};

					if(_info != '' && nums ==1){
						Tunnel._isStop = false;
						Tunnel._webSocket.close();
						plus.storage.clear();
						mui.alert(_info, '操作提示', '确定', function(){
							plus.runtime.restart();
						});
					};

					if(_tips != ''){
						mui.alert(_tips, '温馨提示', '确定');
					}
		    });*/
		    
            
            // 运行环境切换到后台，开始倒数20分钟，重启应用
            /*var apptype;
            document.addEventListener("pause", function(){
            	if(apptype != "pause"){
            		apptype = "pause";
            		var timer = null;
	            	clearTimeout(timer);
	            	timer = setTimeout(function(){
	            		if(mui.os.android){
	            			plus.runtime.quit();
	            		}else{
	            			plus.runtime.restart();		
	            		}
	            	}, 20*60000)	
            	}
            }, false);*/

            updateUserinfo()
            // 运行环境切换到前台
            document.addEventListener("resume", function () {
                updateUserinfo()
            }, false);
			//更新用户信息
            function updateUserinfo() {
            	if(!userinfo){
            		return 
            	}
                luckyAjax({
                    data: {
                        data: JSON.stringify({user_id: userinfo.id}),
                        server: 'user.getUserInfo',
                        device: 'mobile'
                    },
                    timeout: 30000,
                    success: function (res) {
                        if (res.code) {
                            console.log(JSON.stringify(res.data.data))
                            plus.storage.setItem('userinfo', JSON.stringify(res.data.data));
                        }
                    }
                })
            }
			/**
			 * 当前窗口对象，即父窗口；
			 */
			var self = plus.webview.currentWebview();
			// 子窗口地址数组
			var subpages = ["index-content.html", "prospect.html", "news.html", "member.html"];
			// 子窗口样式
			var subStyles = {
				top: "0px",
				bottom: navHeight + "px"
			};
			// 子窗口数量
			var subLen = subpages.length;
			// 子窗口对象数组
			var subWvs = [];
			// 底部选项
			var tabs = document.querySelectorAll(".footNav-item");
			// 当前页面索引，初始化为0；
			var activeIndex = 0;
			// 目标页面索引，初始化为当前页面索引；
			var targetIndex = activeIndex;
			// 《发现》页面已触发过一次，再次触发禁止，默认未触发
			var isLoadNew = false;
			// 创建子页面
			for(var i = 0; i < subLen; i++) {
				/**
				 * 创建窗口对象，并将索引做为额外的参数传递；
				 */
				var subWv = plus.webview.create(subpages[i], cutWebviewId(subpages[i]), subStyles, {
					index: i
				});
				// 窗口对象添加至数组
				subWvs.push(subWv);
				if(i > 0) {
					/**
					 * 隐藏非第一页的窗口对象
					 */
					subWv.hide("none");
				}
				/**
				 * 向父窗口添加子窗口
				 */
				self.append(subWv);
			};

			// 底部选项卡点击切换事件
			for(var j = 0, jlen = tabs.length; j < jlen; j++) {
				tabs[j].addEventListener("tap", function() {
					// 获取当前结点的索引
					targetIndex = this.getAttribute("data-index");
					console.log(typeof targetIndex + targetIndex)
					var urlimg = null
                    if (targetIndex == '0') {
                        urlimg = logodata.img_url_head ? logodata.img_url_head : './images/icon/nav-index-active.png'
                    } else {
                        urlimg = logodata.img_url_tail ? logodata.img_url_tail : './images/icon/nav-index.png'
                    }
                    document.getElementById('homeicon').style.backgroundImage = 'url(' + urlimg + ')'
                    // 转换为number类型
					targetIndex = parseInt(targetIndex, 10);
					
					if(targetIndex == activeIndex) {
						return;
					};

					if(targetIndex == 1){
						var loadPageprospect = plus.webview.getWebviewById('prospect');
						mui.fire(loadPageprospect,'loadSize');
					}

					if(targetIndex == 2 && !isLoadNew){
						var loadPageWeb = plus.webview.getWebviewById('news');
						mui.fire(loadPageWeb,'loadpage');
						isLoadNew = true;
					}

					if(targetIndex == 3){
						var loadPageMember = plus.webview.getWebviewById('member');
						mui.fire(loadPageMember,'loadpageMember');
					}

					// 切换页面
					switchPage(activeIndex, targetIndex);
				});
			};

			/**
			 * 切换页面
			 * @param {String} _event 事件类型
			 * @param {Number} _active 当前页面索引
			 * @param {Number} _target 目标页面索引
			 */
			function switchPage(_active, _target) {
				/**
				 * 目标页面展示
				 */
				subWvs[_target].show();
				// 之前展示的页面隐藏
				subWvs[_active].hide("none");
				// 更新当前页索引
				activeIndex = _target;
			};

			/**
			 * 截取url地址，获取窗口的id；
			 * @param {String} url html文件的路径
			 * @param {String} wvId webviewObject的id
			 */
			function cutWebviewId(url) {
				var startIndex = url.lastIndexOf("/");
				var endIndex = url.lastIndexOf(".html");
				var wvId = url.substring(startIndex + 1, endIndex);
				return wvId;
			}
				
		});
	</script>

</html>