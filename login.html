<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="css/mui.css" rel="stylesheet"/>
    <link href="css/common.css" rel="stylesheet"/>
    <link href="css/module.css" rel="stylesheet"/>
    <link href="css/form.css" rel="stylesheet"/>
    <link href="css/sns.css" rel="stylesheet" />
    <link href="css/member.css" rel="stylesheet"/>
    <script src="js/config.js" type="text/javascript"></script>
</head>

<body class="BL-bg-fff">
<div id="login-wrap" class="BL-rel">
    <div class="member-logo BL-ub BL-ub-ac BL-ub-pc">
        <img src="images/icon/ico-logo.png"/>
    </div>
    <div id="Js-content" class="mui-content BL-bg-fff">
        <div id="Js-name" v-if="login_type===1">
            <ul class="mui-table-view form-list-cell">
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-channel BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="number" v-model="channel_id" placeholder="请输入渠道号"/>
                </li>
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-phone BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="text" v-model="user_name" placeholder="请输入手机号/用户名"/>
                </li>
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-pwd BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="text" v-model="password" placeholder="请输入密码"
                           v-if="pwd_type===1"/>
                    <input class="BL-ub BL-ub-f1" type="password" v-model="password" placeholder="请输入密码" v-else/>
                    <div class="login-ico-pwdeye BL-bimg-contain" v-if="pwd_type===2" @click="pwd_type=1"></div>
                    <div class="login-ico-pwdeye2 BL-bimg-contain" v-else @click="pwd_type=2"></div>
                </li>
            </ul>
            <div class="form-button-group BL-pad-b-1">
                <a type="button" class="form-btn" :class="{'BL-bg-9dcdfa':!user_name||!password}" href="javascript:;"
                   id="login-sub">登&nbsp;录</a>
            </div>
            <div class="BL-ub BL-ub-ac BL-ub-pj login-more">
                <div class="a-link" href="member-forgetpwd.html" data-wid="member-forgetpwd">
                    忘记密码？
                </div>
                <div @click="login_type=2">
                    手机验证码登录
                </div>
            </div>
        </div>
        <div id="Js-sms" v-else>
            <ul class="mui-table-view form-list-cell">
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-channel BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="number" v-model="channel_id" placeholder="请输入渠道号"/>
                </li>
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-phone BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="number" v-model="tel" placeholder="请输入手机号"/>
                </li>
                <li class="BL-ub BL-ub-ac member-login-item">
                    <div class="login-ico-pwd BL-bimg-contain"></div>
                    <input class="BL-ub BL-ub-f1" type="number" v-model="codesms" placeholder="请输入验证码"/>
                    <span class="login-sms-btn BL-col-999" @click="sendCode">{{text}}</span>
                </li>
            </ul>
            <div class="form-button-group BL-pad-b-1">
                <a type="button" class="form-btn" :class="{'BL-bg-9dcdfa':!tel||!codesms}"
                   id="login-sub">登&nbsp;录</a>
            </div>
            <div class="BL-ub BL-ub-ac BL-ub-pj login-more">
                <div class="a-link" href="member-forgetpwd.html" data-wid="member-forgetpwd">
                    忘记密码？
                </div>
                <div @click="login_type=1">
                    用户名登录
                </div>
            </div>
        </div>
        <!--<div class="other-login" style="position: absolute;left: 0;bottom: 4.5625rem;width: 100%;margin: 0;">
            <div class="line-m">
        <span>
        <span>其他登录方式</span>
        </span>
            </div>
            <div class="BL-ub BL-ub-ac BL-ub-pc BL-mar-t-2">
                <div class="other-login-ico login-ico-wechat BL-bimg-contain"></div>
                <div class="other-login-ico login-ico-QQ BL-bimg-contain"></div>
            </div>
        </div>-->

        <!--首次登录-->
        <div class="mui-backdrop" v-if="flag"></div>
        <div class="BL-modal-sns BL-pad-tb-1_5" v-if="flag">
            <div class="input-item ins-font-md BL-col-999">
                <span class="BL-col-3b9cf5 BL-pad-l-2" v-if="flagtype===1">您还没有设置密码，请设置</span>
                <span class="BL-col-3b9cf5 BL-pad-l-2" v-else-if="flagtype===2">您的密码过于简单，请修改</span>
            </div>
            <br>
            <div class="input-item BL-ub BL-ub-ac BL-ub-pc">
                <label>密码</label>
                <div class="input-wrap box-f-1">
                    <input type="password" placeholder="请输入" v-model="pwd1">
                </div>
            </div>
            <div class="input-item BL-ub BL-ub-ac BL-ub-pc">
                <label>确认密码</label>
                <div class="input-wrap box-f-1">
                    <input type="password" placeholder="请输入" v-model="pwd2">
                </div>
            </div>

            <div class="input-item BL-ub BL-ub-ac BL-ub-pc">
                <label></label>
                <div class="input-wrap box-f-1">
                    <button class="sns-btn blue" @click="setpwd">确定</button>
                    <button class="sns-btn grey BL-mar-l-1" @click="flag=false">取消</button>
                </div>
            </div>
        </div>
        <!--首次登录-->
    </div>
</div>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init({
        keyEventBind: {
            backbutton: false //关闭back按键监听
        }
    });
    mui('body').on('tap', '.a-link', function () {
        var href = this.getAttribute('href');
        var id = this.getAttribute("data-wid");
        if (href) {
            //打开新窗口
            mui.openWindow({
                url: href,
                id: id,
                show: animateObj.aniDetal
            })
        }
    });
    var login = new Vue({
        el: '#login-wrap',
        data: {
            pwd1: '',
            pwd2: '',
            flag: false, //登录成功标志且为第一次登录/密码弱
            flagtype: '',//1设置密码 2修改密码
            login_type: 2, //1用户名登录  2手机验证码登录
            pwd_type: 2, //1明文  2密文
            user_name: '', //用户名
            password: '', //密码
            channel_id: '', //渠道号
            tel: '', //手机号
            codesms: '', //验证码
            disabled: false,
            second: 60,
            time: 0
        },
        created: function () {
            //登录方式切换时，手机号同步
            this.$watch('login_type', function (val) {
                if (val === 1) {//用户名/手机号
                    if (!this.user_name) {
                        this.user_name = this.tel ? this.tel : ''
                    }
                } else if (val === 2) {//验证码
                    if (/^1[3-9][0-9]{9}$/.test(this.user_name)) {
                        if (!this.tel) {
                            this.tel = this.user_name ? this.user_name : ''
                        }
                    }
                }
            });
        },
        computed: {
            text: function () {
                return this.time > 0 ? this.time + 's后可重新获取' : '点击获取'
            }
        },
        methods: {
            setpwd: function() {
                var toast_text = null
                if (!this.pwd1) {
                    toast_text = '请输入新的登录密码'
                } else if (!/^[0-9a-zA-Z]{8,16}$/.test(this.pwd1)) {
                    toast_text = '密码格式应为8-16位的字母数字组合'
                } else if (!this.pwd2) {
                    toast_text = '请再次输入密码'
                } else if (this.pwd1 !== this.pwd2) {
                    toast_text = '两次密码输入不一致'
                }
                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    return false;
                }
                luckyAjax({
                    data: {
                        data: JSON.stringify({
                            tel: this.tel,
                            code: this.codesms,
                            password: this.pwd1,
                            channel_id: this.channel_id
                        }),
                        server: 'user.resetPassword',
                        view: true
                    },
                    success: function (data) {
                        if (data.code === 1) {
                            mui.toast('操作成功', {duration: 'short', type: 'div'})
                            setTimeout(function () {
                                plus.runtime.restart();
                            }, 800)
                        } else {
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                            return false;
                        }
                    }
                });
            },
            //发送验证码
            sendCode: function () {
                if (this.disabled) return false
                var tel = this.tel
                if (!this.channel_id) {
                    mui.toast('请输入渠道号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!tel.trim()) {
                    mui.toast('请输入手机号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!/^1[3-9][0-9]{9}$/.test(tel)) {
                    mui.toast('手机号格式不正确', {duration: 'short', type: 'div'});
                    return false;
                }
                luckyAjax({
                    data: {
                        data: JSON.stringify({tel: this.tel, channel_id: this.channel_id}),
                        view: true,
                        server: 'user.sendSms'
                    },
                    success: function (data) {
                        if (data.code === 1) {
                            this.disabled = true
                            login.sended()
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                        } else {
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                            return false;
                        }
                    }
                });
            },
            run: function () {
                this.time = this.second
                this.timer()
            },
            sended: function () {
                mui.toast('发送成功', {duration: 'short', type: 'div'})
                login.run()
                this.disabled = true
            },
            timer: function () {
                if (this.time > 0) {
                    this.time--
                    setTimeout(function () {
                        login.timer()
                    }, 1000)
                } else {
                    this.disabled = false
                }
            }
        }
    })
    mui.plusReady(function () {
        document.querySelector('#login-wrap').style.height = window.innerHeight + 'px';
        plus.storage.clear();

        login.$forceUpdate();
        document.querySelector('#login-sub').addEventListener("tap", function () {
            document.activeElement.blur();
            var basedata = {}
            var type = login.login_type;
            var user_name = login.user_name;
            var password = login.password;
            var tel = login.tel;
            var code = login.codesms;
            var channel_id = login.channel_id;
            if (!channel_id) {
                mui.toast('请输入渠道号', {duration: 'short', type: 'div'});
                return false;
            }
            if (type === 1) {
                if (!user_name.trim()) {
                    mui.toast('请输入用户名', {duration: 'short', type: 'div'});
                    return false;
                } else if (!password.trim()) {
                    mui.toast('请输入密码', {duration: 'short', type: 'div'});
                    return false;
                }
                basedata = {
                    channel_id: channel_id,
                    type: 'account',
                    data: JSON.stringify({keyword: user_name, password: password})
                };
            } else if (type === 2) {
                if (!tel.trim()) {
                    mui.toast('请输入手机号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!/^1[3-9][0-9]{9}$/.test(tel)) {
                    mui.toast('手机号格式不正确', {duration: 'short', type: 'div'});
                    return false;
                } else if (!code.trim()) {
                    mui.toast('请输入验证码', {duration: 'short', type: 'div'});
                    return false;
                }
                basedata = {channel_id: channel_id, type: 'sms', data: JSON.stringify({tel: tel, code: code})}
            }
            luckyAjax({
                url: config.moduleURL + 'login',
                data: basedata,
                success: function (data) {
                    if (data.code === 1) {
                        mui.toast(data.msg, {duration: 'short', type: 'div'});
                        plus.storage.setItem('userinfo', JSON.stringify(data.data));
                        plus.storage.setItem('channel_info', JSON.stringify({channel_id: channel_id}));
                        if (data.data.password_flag) {
                            if(!data.data.password_strong){
                                login.flag = true
                                login.flagtype = 2
                                login.$forceUpdate()
                            } else {
                                setTimeout(function () {
                                    plus.runtime.restart();
                                },200)
                            }
                        } else { //未设置登录密码
                            login.flag = true
                            login.flagtype = 1
                            login.$forceUpdate()
                        }
                    } else {
                        mui.toast(data.msg, {duration: 'short', type: 'div'});
                        return false;
                    }
                }
            });
        })
    })

</script>
</body>
</html>