<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="css/mui.css" rel="stylesheet"/>
    <link href="css/common.css" rel="stylesheet"/>
    <link href="css/module.css" rel="stylesheet"/>
    <link href="css/member.css" rel="stylesheet"/>
    <link href="css/product.css" rel="stylesheet"/>
    <script src="js/config.js" type="text/javascript"></script>
</head>
<body class="BL-bg-f2f">
<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
        <h1 class="BL-title">车险</h1>
        <a class="BL-icon BL-icon-search"></a>
    </div>
</header>
<div id="Js-order" v-cloak>
    <div id="Js-content" class="mui-content">
        <!------------条件筛选 begin------------->
        <div id="Js-orderFilter">
            <!--分类栏目 begin-->
            <div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted BL-segmented-control">
                <div class="mui-scroll">
                    <a class="pro-control-item" :class="{'mui-active':type=='4'}"
                       @click="type='4',page=0">
                        <span>全部</span>
                    </a>
                    <a class="pro-control-item" :class="{'mui-active':type=='0'}"
                       @click="type='0',page=0">
                        <span>待核保</span>
                    </a>
                    <a class="pro-control-item" :class="{'mui-active':type=='1'}"
                       @click="type='1',page=0">
                        <span>核保中</span>
                    </a>
                    <a class="pro-control-item" :class="{'mui-active':type=='2'}"
                       @click="type='2',page=0">
                        <span>核保失败</span>
                    </a>
                    <a class="pro-control-item" :class="{'mui-active':type=='3'}"
                       @click="type='3',page=0">
                        <span>待支付</span>
                    </a>
                </div>
            </div>
            <!--分类栏目 end -->
        </div>
        <!------------条件筛选 end  ------------->

        <!------------产品列表 begin------------->
        <div id="Js-orderList" class="BL-rel">
            <div class="mui-content mui-scroll-wrapper BL-mar-t-07">
                <div class="mui-scroll">
                    <!-- 数据列表-->
                    <ul class="mui-table-view product-list-cell">
                        <li v-for="(item,index) in listdata" :key="index" class="member-warranty-list-item BL-rel" v-if="listdata">
                            <div class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-46 BL-txt-l">
                                <span>保单号：</span>
                                <span>{{ item.contract_no }}</span>
                                <span class="BL-col-3b9cf5 fr" v-if="item.process=='待核保'">录入中</span>
                                <span class="BL-col-3b9cf5 fr" v-else>{{item.process}}</span>
                            </div>
                            <div class="BL-pad-lr-1_5 BL-pad-tb-1_5">
                                <a class="mui-navigate-right context BL-col-666" @click="Detail(item.business_no)">
                                    <div class="team-per-ins BL-pad-b-1">
                                        <span>车牌号：<i>{{ item.vehicle_no }}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span>被保人：<i>{{ item.ass_name }}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span v-if="item.product_type == 1">交强险保费(元)：<i>{{ item.totalFee }}</i></span>
                                        <span v-if="item.product_type == 2">商业险保费(元)：<i>{{ item.totalFee }}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span>提交时间：<i>{{ item.create_time }}</i></span>
                                    </div>
                                </a>
                                <div class="BL-txt-r button">
                                    <a class="BL-btn-white BL-pad-lr-1 continue" v-if="item.process=='待核保'" :data-business="item.business_no" :data-process="item.process" :data-id="item.id" :data-status="item.status">去核保</a>
                                    <a class="BL-btn-white BL-pad-lr-1 continue" v-if="item.status=='初始状态' && item.process == '核保成功'" :data-business="item.business_no" :data-process="item.process
" :data-id="item.id" :data-status="item.status">去支付</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!------------产品列表 end  ------------->
    </div>
</div>
<!------------悬浮控制按钮 end --------------->
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script src="js/Date.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var order = new Vue({
        el: '#Js-order',
        data: {
            type: 4, // 状态类别id
            page: 0,
            listdata: []
        },
        watch: {
            type: {
                handler: function () {
                    this.page = 0;
                    mui('#Js-orderList .mui-scroll-wrapper').each(function(){
                        this.setAttribute('data-scroll', '');
                    });
                    loaddata(true);
                }
            }
        },
        methods: {
            Detail: function(business_no) {
                mui.openWindow({
                    id: 'member_warranty_manageAuto_detail',
                    url: 'member-warranty-manageAuto-detail.html',
                    show: animateObj.aniDetal,
                    extras:{
                        business_no: business_no  //扩展参数
                    }
                });
            }
        }
    });

    var self;
    var user_id;

    (function ($) {
        //阻尼系数
        var deceleration = mui.os.ios?0.003:0.0009;
        $('.mui-scroll-wrapper').scroll({
            bounce: true,
            indicators: false, //是否显示滚动条
            deceleration: deceleration
        });
        $.plusReady(function () {
            user_id = JSON.parse(plus.storage.getItem("userinfo")).id

            statusbar();

            var winH = window.innerHeight;
            var titHeight = document.querySelector('#Js-header').offsetHeight;
            var divHeight = document.querySelector('#Js-orderFilter').offsetHeight;
            document.querySelector('#Js-orderList').style.height = winH - titHeight - divHeight + 'px';

            //循环初始化所有下拉刷新，上拉加载。
            $('#Js-orderList .mui-scroll').pullToRefresh({
                up: { // 上拉加载更多
                    auto: true, // 自动上拉一次
                    contentrefresh: '正在加载...',
                    contentnomore:'没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
                    callback: function() {
                        self = this
                        loaddata()
                    }
                }
            });
            //继续录入-后更新列表
            window.addEventListener('auto_reload', function () {
                plus.webview.currentWebview().reload()
            });
            // 去核保或支付
            mui('body').on('tap', '.continue', function () {
                var _this = this
                var business_no = _this.getAttribute('data-business')
                var process = this.getAttribute("data-process")
                var status = this.getAttribute("data-status")
                var id = this.getAttribute("data-id")
                var url = null
                var wid = null
                var extras = null
                if (process == '待核保') {
                    url = 'auto2c-order.html'
                    wid = 'auto2c_order'
                    extras = {
                        business_no: business_no
                    }

                    //打开新窗口
                    mui.openWindow({
                        url: url,
                        id: wid,
                        show: animateObj.aniDetal,
                        extras: extras
                    });

                } else if (process == '核保成功' && status == '初始状态') {
                    url = 'auto2c-pay.html'
                    wid = 'auto2c_pay'
                    // 重新获取支付链接
                    luckyAjax({
                        data: {
                            server: 'carIns.payLink',
                            view: true,
                            data: JSON.stringify({
                                id: id
                            })
                        },
                        success:function(res) {
                            if (res.code == 1) {
                                extras = {
                                    business_no: business_no,
                                    payLink: res.data.payLink
                                }

                                //打开新窗口
                                mui.openWindow({
                                    url: url,
                                    id: wid,
                                    show: animateObj.aniDetal,
                                    extras: extras
                                });
                            } else {
                                mui.toast('重新获取支付链接失败', {duration: 'long', type: 'div'})
                                return false
                            }

                        }
                    })

                }
            })
        });
    }(mui));
    //加载险种列表
    var loaddata = function (e) {
        order.page++;
        var basedata = {
            userId: user_id,
            type: order.type,
            page: order.page,
            row: 10
        }

        luckyAjax({
            data: {
                server: 'carIns.getPolicyList',
                view: true,
                data: JSON.stringify(basedata)
            },
            success: function(res){
                if(res.code == 1) {
                    if (order.page >= res.data.page) {
                        self.endPullUpToRefresh(true);
                    } else {
                        self.endPullUpToRefresh(false);
                    }
                    if (e) {
                        order.listdata = res.data.list;
                    } else {
                        var list = res.data.list;
                        mui.each(list, function (index, item) {
                            order.listdata.push(item);
                        });
                    }
                } else {
                    mui.toast(res.msg, {duration: 'long', type: 'div'})
                }
            }
        });
    };
</script>

</html>