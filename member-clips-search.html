<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>条款/投保规则搜索</title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <style>
        #Js-search.BL-mod-headbar {
            height: 5.5rem;
        }
        .BL-mod-headbar .headbar-search {
            padding: 1.1875rem 1.4375rem;
        }
        .BL-mod-headbar .headbar-search .search {
            margin-left: 0rem;
            border-radius: 1.5rem;
            -webkit-border-radius: 1.5rem;
        }
    </style>
</head>
<body class="BL-bg-f2f">
    <header id="Js-header" class="BL-bg-fff">
        <div class="BL-mod-headbar BL-mod-headbar-pos">
            <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
            <h1 class="BL-title"></h1>
        </div>
    </header>
    <div id="Js-main">
        <div id="Js-search" class="BL-mod-headbar BL-bg-fff">
            <div class="BL-ub BL-ub-ac headbar-search">
                <div class="search search-pro BL-ub BL-ub-ac BL-ub-f1">
                    <input type="search" placeholder="请输入关键字" class="BL-ub BL-ub-f1" v-model="keyword" @keyup.enter="query" />
                    <div class="button" @click="query">
                        <span class="BL-bimg-contain">&nbsp;</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY">
            <div v-show="list">
                <div v-show="list&&list.length>0" :class="{'BL-bg-fff': list&&list.length>0}">
                    <div class="mui-content mui-scroll-wrapper">
                        <div class="mui-scroll">
                            <ul class="mui-table-view form-list-cell">
                                <li class="fItem BL-ub BL-ub-f1" v-for="(item,index) in list" :key="index">
                                    <a class="mui-navigate-right form-list-label BL-ub-f1 BL-ub-f1" :data-name="item.product_name" :data-statement="item.statement" :data-rule="item.insured_rule">
                                        <div class="BL-ftz-52 BL-ellipsis BL-pad-r-2">
                                            {{ item.product_name }}
                                        </div>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div v-show="list&&list.length==0" class="BL-col-999 BL-txt-c BL-pad-tb-1 BL-ftz-46">搜索不到相关数据</div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var search = new Vue({
        el: '#Js-main',
        data: {
            name:'',
            supplier_id: '',
            list: null,
            row: 12,
            page: 0,
            keyword: ""    // 关键字
        },
        methods: {
            toblur:function(){
                document.activeElement.blur();
            },
            query: function () {
                this.toblur();
                this.page = 0;
                this.list = null;
                if (!this.keyword) {
                    mui.toast('关键字不能为空', {duration: 'short', type: 'div'});
                    return
                }
                // 模糊匹配品牌型号信息
                loadList()
            }
        }
    });
    (function($){
        //阻尼系数
        var deceleration = mui.os.ios ? 0.003 : 0.0009;
        $('#Js-content .mui-scroll-wrapper').scroll({
            bounce: true,
            indicators: false, //是否显示滚动条
            deceleration: deceleration
        });

        $.plusReady(function() {
            // 设置内容区域
            statusbar();
            var winH = window.innerHeight;
            var titHeight = document.querySelector('#Js-header').offsetHeight;
            var divHeight = document.querySelector('#Js-search').offsetHeight;
            document.querySelector('#Js-content').style.height = (winH - titHeight - divHeight) +'px';

            search.supplier_id = plus.webview.currentWebview().supplier_id;
            search.supplier_id == 1 ? document.querySelector('.BL-title').innerHTML = '条款搜索': document.querySelector('.BL-title').innerHTML = '投保规则搜索'

            var i = 0;
            $('#Js-content .mui-scroll').pullToRefresh({
                up: { // 上拉加载更多
                    auto: false, // 自动上拉一次
                    contentrefresh: '正在加载...',
                    contentnomore:'没有更多数据了',// 可选，请求完毕若没有更多数据时显示的提醒内容；
                    callback: function() {
                        loadList()
                    }
                }
            });
        });
    }(mui));
    //加载品牌列表
    var loadList = function () {
        search.page++;
        var basedata = {
            state: "1",   // 1 表示上线
            product_name: search.keyword,
            page: search.page,
            row: 12
        };
        luckyAjax({
            data: {
                server: 'lifeProduct.getProductList',
                data: JSON.stringify(basedata)
            },
            success:function(res){
                if (res.code == 1) {
                    search.$nextTick(function () {
                        if (res.code) {
                            if(search.page == 1 && res.data.count == res.data.list.length) {
                                search.list = res.data.list
                                mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(true);
                            } else if(search.page == 1 &&  res.data.count > res.data.list.length) {
                                search.list = res.data.list
                                mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh();
                            } else if(res.data.count > res.data.list.length && search.page <= res.data.totalPage) {
                                search.list = search.list.concat(res.data.list)
                                mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh();
                            } else {
                                mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(true);
                            }
                        } else {
                            mui.toast(res.msg, {duration: 'short', type: 'div'});
                            return false;
                        }
                    })
                } else {
                    mui.toast(res.msg, {duration: 'short', type: 'div'});
                }
            }
        });
    };
    //列表点击事件查看pdf
    mui('body').on('tap', '.mui-navigate-right', function (e) {
        var pdf_url;
        if(search.supplier_id == 1) {
            pdf_url = this.getAttribute('data-statement');
        } else {
            pdf_url = this.getAttribute('data-rule');
        }
        var pdf_name = this.getAttribute('data-name');
        if (pdf_url) {
            mui.openWindow({
                url: 'pdf-modal.html',
                id: 'pdf_modal',
                show: animateObj.aniDetal,
                extras: {
                    pdf:pdf_url,
                    name:pdf_name
                },
                waiting:{
                    auto:false
                }
            });
        } else {
            mui.toast('暂无条款pdf可查看', {duration: 'short', type: 'div'})
            return false
        }
    });
</script>
</html>
