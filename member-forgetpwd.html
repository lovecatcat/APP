<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <link href="css/member.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
</head>

<body class="BL-bg-f2f">
<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
        <h1 class="BL-title">重置密码</h1>
    </div>
</header>

<div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY">
    <div id="Js-sms">
        <ul class="mui-table-view form-list-cell">
            <li class="BL-ub BL-ub-ac member-login-item">
                <input type="number" class="BL-ub BL-ub-f1" v-model="channel_id" placeholder="请输入渠道号"/>
            </li>
            <li class="BL-ub BL-ub-ac member-login-item">
                <input type="number" class="BL-ub BL-ub-f1" v-model="tel" placeholder="请输入手机号"/>
            </li>
            <li class="BL-ub BL-ub-ac member-login-item">
                <input class="BL-ub BL-ub-f1" type="number" v-model="codesms" placeholder="请输入验证码"/>
                <span class="login-sms-btn BL-col-999" @click="sendCode">{{text}}</span>
            </li>
            <li class="BL-ub BL-ub-ac member-login-item">
                <input type="password" class="BL-ub BL-ub-f1" v-model="password" placeholder="请设置新密码"/>
            </li>
            <li class="BL-ub BL-ub-ac member-login-item">
                <input type="password" class="BL-ub BL-ub-f1" v-model="password1" placeholder="请再次输入新密码"/>
            </li>
        </ul>
    </div>
    <div class="form-button-group">
        <a type="button" class="form-btn" @click="resetpwd">确定</a>
    </div>
</div>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    mui.plusReady(function() {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;

        document.querySelector('#Js-content').style.height = (winH - titHeight) +'px';
    });
    var forget = new Vue({
        el: '#Js-content',
        data: {
            channel_id: '',//渠道号
            tel: '', //手机号
            codesms: '', //验证码
            password: '',//新密码
            password1: '',//新密码确认
            disabled: false,
            second: 60,
            time: 0
        },
        computed: {
            text: function () {
                return this.time > 0 ? this.time + 's后可重新获取' : '点击获取'
            }
        },
        methods: {
            resetpwd: function() {
                var toast_text = null
                if (!this.channel_id) {
                    mui.toast('请输入渠道号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!this.tel.trim()) {
                    mui.toast('请输入手机号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!/^1[3|4|5|6|7|8][0-9]{9}$/.test(this.tel)) {
                    mui.toast('手机号格式不正确', {duration: 'short', type: 'div'});
                    return false;
                } else if (!this.codesms.trim()) {
                    mui.toast('请输入验证码', {duration: 'short', type: 'div'});
                    return false;
                } else if (!this.password) {
                    toast_text = '请输入新的登录密码'
                } else if (!/(?=.*\d)(?=.*[A-z])^[0-9A-z]{8,}$/.test(this.password)) {
                    toast_text = '密码格式应为8-16位的字母数字组合'
                } else if (!this.password1) {
                    toast_text = '请再次输入密码'
                } else if (this.password !== this.password1) {
                    toast_text = '两次密码输入不一致'
                }
                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    return false;
                }
                luckyAjax({
                    data: {
                        data: JSON.stringify({tel: this.tel, code: this.codesms, password: this.password}),
                        server: 'user.resetPassword',
                        view: true
                    },
                    success: function (data) {
                        if (data.code === 1) {
                            mui.toast('操作成功', {duration: 'short', type: 'div'})
                            setTimeout(function () {
                                plus.runtime.restart();
                            }, 1000)
                        } else {
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                            return false;
                        }
                    }
                });
            },
            //发送验证码
            sendCode: function () {
                if (this.disabled) return false
                var tel = this.tel
                if (!this.channel_id) {
                    mui.toast('请输入渠道号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!tel.trim()) {
                    mui.toast('请输入手机号', {duration: 'short', type: 'div'});
                    return false;
                } else if (!/^1[3|4|5|6|7|8][0-9]{9}$/.test(tel)) {
                    mui.toast('手机号格式不正确', {duration: 'short', type: 'div'});
                    return false;
                }
                luckyAjax({
                    data: {
                        data: JSON.stringify({tel: this.tel, channel_id: this.channel_id}),
                        view: true,
                        server: 'user.sendSms'
                    },
                    success: function (data) {
                        if (data.code === 1) {
                            this.disabled = true
                            forget.sended()
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                        } else {
                            mui.toast(data.msg, {duration: 'short', type: 'div'})
                            return false;
                        }
                    }
                });
            },
            run: function () {
                this.time = this.second
                this.timer()
            },
            sended: function () {
                mui.toast('发送成功', {duration: 'short', type: 'div'})
                forget.run()
                this.disabled = true
            },
            timer: function () {
                if (this.time > 0) {
                    this.time--
                    setTimeout(function () {
                        forget.timer()
                    }, 1000)
                } else {
                    this.disabled = false
                }
            }
        }
    })
</script>
</html>

