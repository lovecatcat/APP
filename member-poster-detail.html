<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>我的海报</title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<script src="js/config.js" type="text/javascript"></script>
	</head>

	<body>
		<header id="Js-header" class="BL-bg-fff">
			<div class="BL-mod-headbar BL-mod-headbar-pos">
				<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
				<h1 class="BL-title">我的海报</h1>
				<a id="Js-openShare" class="BL-icon BL-icon-share"></a>
			</div>
		</header>
		
		<div id="Js-content" class="mui-content BL-overFlow-autoY">
			<div style="padding: 2rem;">
				<div id="Js-wrap" style=" -webkit-box-shadow:.5rem .5rem 1rem rgba(0,0,0,0.3);">
					<div id="Js-context">	
						<!--画布-->
			    		<canvas id="canvas"></canvas>	
		    		</div>
	    		</div>
    		</div>
		</div>
	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script src="js/plusShare.js" type="text/javascript"></script>
	<script type="text/javascript">
		mui.init();

		mui.plusReady(function() {
			statusbar();
			var pid = plus.webview.currentWebview().pid;
			var userinfo = JSON.parse(plus.storage.getItem('userinfo'));
			var winW = window.innerWidth;
			var winH = window.innerHeight;
			var topHeight = document.querySelector('#Js-header').offsetHeight;
			var divPading = document.getElementById('Js-context').offsetLeft * 2;
			var divW = document.querySelector('#Js-context').offsetWidth;
			var divH = winH - topHeight - divPading;
			var imgdata = null;
			document.getElementById('Js-content').style.height = (winH - topHeight) +'px';
			
			document.getElementById('canvas').width = divW;
			//document.getElementById('canvas').height = divH;
			
			// image.src = config.baseUrl + '?server=user.getQrcode&device=mobile&data={"user_id":"'+ userinfo.id +'"}'
			
			
			document.getElementById("Js-openShare").addEventListener("tap", function() {
				var data = saveImageInfo();
				var bitmap = new plus.nativeObj.Bitmap("test");
				
				bitmap.loadBase64Data(data, function(){
					//console.log("加载Base64图片数据成功");
				}, function(){
					//console.log('加载Base64图片数据失败：'+JSON.stringify(e));
				});
				
				bitmap.save("_doc/a.png"
				,{
					overwrite:true,
					format:'png',
					quality:100
				}
				,function(i){
					//console.log('保存图片成功：'+JSON.stringify(i));
					var imgdata = i.target;
					
					//分享内容，开发者可自定义
					var message = {
						pictures:[imgdata],
						extra:{scene:"WXSceneSession"}
					}
				    //调起分享
				    plusShare(message, function(res) {
				        //分享回调函数
				        if(res) {
				            plus.nativeUI.toast("分享成功");
				        } else {
				            plus.nativeUI.toast("分享失败");
				        }
				    })
				},function(e){
					console.log('保存图片失败：'+JSON.stringify(e));
				});
				bitmap.clear();
			});
			
			initdrawPoster();
			function initdrawPoster(){
				// 获取代理人信息
				var name = userinfo.user_name;
				var phone = userinfo.tel;
				
				// 创建canvas对象
				var context = getCanvasContext('canvas');
				
				// 创建qcord二维码图片对象
				var qcordImg = new Image();
				qcordImg.src = config.baseUrl + '?server=user.getQrcode&device=mobile&data={"user_id":"'+ userinfo.id +'"}';
				qcordImg.onload = function(){
					//先把图片绘制在这里
					context.drawImage(qcordImg, divW - 190 , divW * (img.height/img.width), 170, 170);
				}
				
				//创建图片对象，用于在canvas中渲染
				var img = new Image();
				img.src = "images/member/pos"+pid+".jpg";
				img.onload = function(){
					//设置画布高度
					document.getElementById('canvas').height = divW * (img.height/img.width) + 190;
					//设置画布背景色
					context.fillStyle = "#ffffff";
					context.fillRect(0,0, divW, divH);
					//先把图片绘制在这里
					context.drawImage(img, 20, 20, divW - 40, divW * (img.height/img.width) - 40);
					//设置用户文本的大小字体等属性
	                context.font = "small-caps 28px STXinwei";
	                //设置用户文本填充颜色
	                context.fillStyle = "#333333";
	                //绘制文字
	                context.fillText('详情咨询：'+name, 20, divW * (img.height/img.width) + 70);
	                //设置用户文本填充颜色
	                context.fillStyle = "#333333";
	                //绘制文字
	                context.fillText('联系方式：'+phone, 20, divW * (img.height/img.width) + 110);
				}
			};
			
			//通过id获取canvas对象
		    function getCanvasContext(id){
		        return document.getElementById(id).getContext("2d");
		    }
		    
		    //生成base64
		    function saveImageInfo(){
		    	return document.getElementById('canvas').toDataURL();
		    }
			
		});
	</script>

</html>