<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>我的海报</title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<script src="js/config.js" type="text/javascript"></script>
	</head>

	<body>
		<header id="Js-header" class="BL-bg-fff">
			<div class="BL-mod-headbar BL-mod-headbar-pos">
				<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
				<h1 class="BL-title">我的海报<span id="Js-download">下载</span></h1>
				<a id="Js-openShare" class="BL-icon BL-icon-share"></a>
			</div>
		</header>
		
		<div id="Js-content" class="mui-content BL-overFlow-autoY">
			<!--画布-->
    		<canvas id="canvas"></canvas>		
		</div>
	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		mui.init();

		mui.plusReady(function() {
			statusbar();
			var pid = plus.webview.currentWebview().pid;
			var userinfo = JSON.parse(plus.storage.getItem('userinfo'));
			var winW = window.innerWidth;
			var winH = window.innerHeight;
			var topHeight = document.querySelector('#Js-header').offsetHeight;
			document.getElementById('Js-content').style.height = (winH - topHeight) +'px';
			document.getElementById('canvas').width = winW;
			document.getElementById('canvas').height = winH - topHeight;
			// image.src = config.baseUrl + '?server=user.getQrcode&device=mobile&data={"user_id":"'+ userinfo.id +'"}'
			
			document.getElementById("Js-download").addEventListener("tap", function() {
			    saveImageInfo();
			});
			
			document.getElementById("Js-openShare").addEventListener("tap", function() {
			    //分享内容，开发者可自定义
			    var message = {
			        title: userinfo.user_name + "的个人海报", //标题
			        content: "【保险plus，更专业的保险管家】",
			        href: config.domain + "/share/AppShare.html#/Posterdetail?uId="+ userinfo.id +"&pId="+pid, //分享出去后，点击跳转地址
			        thumbs: ["_www/images/pic/logo.png"] //分享缩略图
			    }
			    //调起分享
			    plusShare(message, function(res) {
			        //分享回调函数
			        if(res) {
			            plus.nativeUI.toast("分享成功");
			        } else {
			            plus.nativeUI.toast("分享失败");
			        }
			    })
			});
			
			initdrawPoster();
			function initdrawPoster(){
				// 获取代理人信息
				var name = userinfo.user_name;
				var phone = userinfo.tel;
				
				// 创建canvas对象
				var context = getCanvasContext('canvas');
				
				// 创建qcord二维码图片对象
				var qcordImg = new Image();
				qcordImg.src = config.baseUrl + '?server=user.getQrcode&device=mobile&data={"user_id":"'+ userinfo.id +'"}';
				qcordImg.onload = function(){
					//先把图片绘制在这里
					context.drawImage(qcordImg, winW - 210 , winW * (img.height/img.width) + 20, 170, 170);
				}
				
				//创建图片对象，用于在canvas中渲染
				var img = new Image();
				img.src = "images/member/pos"+pid+".jpg";
				img.onload = function(){
					
					//设置画布背景色
					context.fillStyle = "#ffffff";
					context.fillRect(0, 0, winW, winH-topHeight);
					//先把图片绘制在这里
					context.drawImage(img, 0, 0, winW, winW * (img.height/img.width));
					//设置用户文本的大小字体等属性
	                context.font = "small-caps 28px STXinwei";
	                //设置用户文本填充颜色
	                context.fillStyle = "#333333";
	                //绘制文字
	                context.fillText('详情咨询：'+name, 50, winW * (img.height/img.width) + 90);
	                //设置用户文本填充颜色
	                context.fillStyle = "#333333";
	                //绘制文字
	                context.fillText('联系方式：'+phone, 50, winW * (img.height/img.width) + 130);
				}
			};
			
			//通过id获取canvas对象
		    function getCanvasContext(id){
		        return document.getElementById(id).getContext("2d");
		    }
		    //将画布生成图片并保存到相册
		    function saveImageInfo() {
		        var mycanvas = document.getElementById("canvas");
		        var img = mycanvas.toDataURL("images/jpg");
		        
		        var b=new plus.nativeObj.Bitmap();

                b.loadBase64Data(img,function(){
                	console.log("创建成功");
                	
                	b.save('_www/img1.jpg',{overwrite:true},function(){
	                    console.log("保存成功");
	                },function(){
	                    console.log("保存失败");
	                });
                	
                },function(){
                    console.log("创建失败");
                });
                
		        
//		        plus.gallery.save( img, function () {
//					alert( "保存图片到相册成功" );
//				});
		    }
		    
			
		});
	</script>

</html>