<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>补充信息</title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="css/mui.picker.min.css"/>
    <link href="css/signature.css" rel="stylesheet"/>
</head>
<body class="BL-bg-f2f">
    <header id="Js-header" class="BL-bg-fff">
        <div class="BL-mod-headbar BL-mod-headbar-pos">
            <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
            <h1 class="BL-title">信息完善</h1>
        </div>
    </header>
    <div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY" v-cloak>
        <ul class="mui-table-view auto-list-cell">
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">入职城市</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r address-select-2">{{ city_work_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.user_name" @blur="checkName">
                </div>
                <div class="form-list-icon" v-show="user.user_name!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.user_name=''"></span>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别</label>
                <div class="form-list-control BL-txt-r">
                    <label class="BL-mar-l-6 form-sex">
                            <span class="mui-radio">
                                <input name="sex" type="radio" v-model="user.sex" value="1">
                            </span>
                        男
                    </label>
                    <label class="BL-mar-l-6 form-sex">
                            <span class="mui-radio">
                                <input name="sex" type="radio" v-model="user.sex" value="0">
                            </span>
                        女
                    </label>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">出生日期</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r date" data-options='{"type":"date","beginYear":1950}'> {{ user.birthday }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">民&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;族</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r" id="Nation">{{ nation_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">联系地址</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r address-select-3">{{ address_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">详细地址</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.address">
                </div>
                <div class="form-list-icon" v-show="user.address!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.address=''"></span>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">银行卡号</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.bank_no">
                </div>
                <div class="form-list-icon" v-show="user.bank_no!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.bank_no=''"></span>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">银行名称</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r" id="Banktype">{{ bank_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">银行开户地</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r address-select-2">{{ bank_city_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">手机号码</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.tel" @blur="checkTel">
                </div>
                <div class="form-list-icon" v-show="user.tel!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.tel=''"></span>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <div class="form-list-control">
                    <input class="BL-txt-l" type="text" placeholder="请输入手机验证码" v-model="user.code" style="height: 5.1rem">
                </div>
                <div class="form-list-label BL-txt-r">
                    <a class="sms-btn" @click="sendCode">{{ text }}</a>
                </div>
            </li>
        </ul>
        <ul class="mui-table-view auto-list-cell BL-mar-t-1">
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">证件类型</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r" id="Cardtype">{{ card_type_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">证件号码</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.card_no" @blur="checkIDBefore(user.card_no)">
                </div>
                <div class="form-list-icon" v-show="user.card_no!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.card_no=''"></span>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">政治面貌</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r" id="Politics">{{ politics_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">学&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;历</label>
                <div class="form-list-control">
                    <div class="sel-control BL-txt-r" id="Academic">{{ academic_name }}</div>
                </div>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li class="fItem BL-ub BL-ub-f1">
                <label class="form-list-label">毕业学校</label>
                <div class="form-list-control">
                    <input type="text" placeholder="请输入" v-model="user.grad_school">
                </div>
                <div class="form-list-icon" v-show="user.grad_school!=''">
                    <span class="mui-icon mui-icon-clear" @click="user.grad_school!=''"></span>
                </div>
            </li>
        </ul>
        <ul class="mui-table-view auto-list-cell BL-mar-t-1">
            <li class="fItem BL-ub BL-ub-f1">
                <a href="javacript:void(0);" @click="work" class="BL-ub-f3 form-list-label">
                    工作经历<small class="BL-col-999">(至少填写一项工作经历)</small>
                </a>
                <div class="form-list-icon">
                    <div class="mui-icon mui-icon-arrowright"></div>
                </div>
            </li>
            <li v-if="work_on.length > 0" class="fItem BL-ub BL-ub-f1">
                <ul class="line-time">
                    <li v-for="item in work_on">
                        <i class="point BL-bimg-cover"></i>
                        <p>{{ item.start.split('-').join('/') }} - {{ item.end.split('-').join('/') }}</p>
                        <p class="name">{{ item.name }}</p>
                        <p>职位：{{ item.position }}</p>
                    </li>
                </ul>
            </li>
        </ul>
        <div class="BL-bg-fff BL-mar-t-1">
            <div class="mui-row BL-pad-t-1 BL-pad-b-1_5 BL-pad-lr-1_5">
                <div class="form-inline-block form-left BL-mar-b-1">
                    <div class="BL-txt-c">
                        <div class="form-upload BL-mar-r-1" :style="previewImg[0]" data-id="0">
                            <div class="form-upload-img"></div>
                        </div>
                        <span class="form-upload-tip">请上传个人正面照片</span>
                    </div>
                </div>
                <div class="form-inline-block form-right BL-mar-b-1">
                    <div class="BL-txt-c">
                        <div class="form-upload BL-mar-r-1" :style="previewImg[1]" data-id="1">
                            <div class="form-upload-img"></div>
                        </div>
                        <span class="form-upload-tip">请上传银行卡正面照片</span>
                    </div>
                </div>
                <div class="form-inline-block form-left">
                    <div class="BL-txt-c">
                        <div class="form-upload BL-mar-r-1" :style="previewImg[2]" data-id="2">
                            <div class="form-upload-img"></div>
                        </div>
                        <span class="form-upload-tip">请上传身份证正面照片</span>
                    </div>
                </div>
                <div class="form-inline-block form-right">
                    <div class="BL-txt-c">
                        <div class="form-upload BL-mar-r-1" :style="previewImg[3]" data-id="3">
                            <div class="form-upload-img"></div>
                        </div>
                        <span class="form-upload-tip">请上传身份证反面照片</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox mui-left BL-mar-t-1">
            <div class="BL-mar-l-1 BL-pad-l-3 BL-pad-r-1 BL-ftz-48 BL-ub BL-ub-ac">
                <label style="font-size: 1.5rem">本人已认真阅读并同意签署</label><a href="javacript:void(0);" id="protocol"> “藏保图” 用户使用协议</a>。
                <input name="checkbox" type="checkbox" v-model="agree_check" style="left: .8rem;top: 0.5rem;">
            </div>
        </div>
        <div id="signature_img" class="BL-ub BL-ub-ac BL-pad-lr-1_5" :class="{'BL-hide': image.sign=='' }">
            <label class="BL-ftz-46 BL-pad-l-1 BL-pad-r-2" style="display: flex">您的签名：</label>
            <img :src="image.sign" alt="" width="500px">
        </div>
        <div class="form-button-group mui-row" style="padding: 1rem 1.5rem 2rem 1.5rem">
            <div class="mui-col-xs-6 BL-txt-c BL-pad-r-1">
                <button href="javacript:void(0);" type="button" class="form-btn form-btn-grey" @click="openSign">手写签名（正楷）</button>
            </div>
            <div class="mui-col-xs-6 BL-txt-c BL-pad-l-1">
                <button href="javacript:void(0);" type="button" class="form-btn" :disabled="disabled" @click="addUser">激活</button>
            </div>
        </div>
        <sign v-if="showSign"></sign>
    </div>
    <!--签名 -->
    <template id="sign">
        <div class="signature-box BL-pad-lr-1_5">
            <div id="signature-pad" class="m-signature-pad">
                <div class="m-signature-pad--body" :style="styles">
                    <canvas id="canvas"></canvas>
                </div>
                <div class="m-signature-pad--footer BL-mar-b-2">
                    <div class="description">请用正楷字体签名</div>
                    <div class="left">
                        <button type="button" class="sign-btn clear BL-pad-lr-2" @click="clear">清除</button>
                    </div>
                    <div class="right">
                        <button type="button" class="sign-btn save BL-pad-lr-2" @click="saveSign">保存</button>
                    </div>
                </div>
            </div>
            <!-- 为了让签名面板显示出来 onfocus="this.blur();"不显示键盘-->
            <input type="text" id="signInput" style="opacity: 0; height: 0rem" onfocus="this.blur();">
        </div>
    </template>
    <!--签名 -->
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script src="js/mui.picker.js" type="text/javascript"></script>
<script src="js/mui.dtpicker.js" type="text/javascript"></script>
<script src="js/mui.poppicker.js" type="text/javascript"></script>
<script src="js/IDValidator.min.js" type="text/javascript"></script>
<script src="js/city.data-3.js" type="text/javascript"></script>
<script src="js/signature/signature_pad.js"></script>
<script type="text/javascript">
    mui.init();

    mui.plusReady(function() {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;
        document.querySelector('#Js-content').style.height = winH - titHeight + 'px';
		mui.fire(plus.webview.getWebviewById('popup_content'), 'closePop');

        Vue.component('sign', {
            template: '#sign',
            data:function() {
                return {
                    signature: null,
                    styles: null
                }
            },
            mounted:function() {
                const lwRatio = 2 / 5
                var canvas = document.getElementById('canvas')
                if (!canvas) return
                this.styles = {
                    height: (canvas.parentNode.offsetWidth * lwRatio).toFixed(0) + 'px'
                }
                var vm = this

                function resizeCanvas() {
                    var ratio = Math.max(window.devicePixelRatio || 1, 1)
                    canvas.width = canvas.offsetWidth * ratio
                    canvas.height = canvas.offsetWidth * lwRatio * ratio
                    canvas.getContext('2d').scale(ratio, ratio)
                }

                window.onresize = resizeCanvas
                resizeCanvas()
                vm.signature = new SignaturePad(canvas, {
                    minWidth: 2,
                    maxWidth: 3.5
                })
            },
            destroyed:function() {
                this.signature.off()
                this.signature = null
            },
            methods: {
                clear: function() {
                    this.signature && this.signature.clear()
                },
                saveSign: function() {
                    if (this.signature.isEmpty()) {
                        mui.toast("签名不能为空", {duration: 'short', type: 'div'})
                        return
                    }
                    var base64 = this.signature.toDataURL()
                    this.setSignSN(base64)
                },
                setSignSN:function(base64) {
                    if (base64) {
                        this.$parent.uploadSign(base64)
                    }
                    this.$parent.showSign = false
                    this.clear()
                }
            }
        });

        var Info = new Vue({
            el: "#Js-content",
            data: {
                init: null,   // 基本信息
                user: {
                    city_work: "", // 入职城市
                    user_name: "",  // 姓名
                    sex: "1",    // 性别
                    birthday: "请选择",  // 出生日期
                    nation: "",    // 民族
                    academic: "", // 学历
                    grad_school: "", // 毕业学校
                    politics: "", // 政治面貌
                    card_type: "", // 证件类型
                    card_no: "",  // 证件号码
                    bank: "",
                    bank_city: "", // 银行开户地
                    bank_no: "",   // 银行卡号
                    province: "",   //  省
                    city: "",        // 市
                    district: "",   // 区
                    address: "",  // 联系地址
                    tel: "",    // 手机号码
                    code: ""    // 短信验证码
                },
                work_on:[],   // 工作经历
                previewImg: [],           //上传图片
                image: {
                    person: "",
                    bank: "",
                    card_face: "",
                    card_turn: "",
                    sign: ""
                },
                agree_check: false, // 条款确认状态
                city_work_name: "请选择",
                nation_name: "请选择",
                academic_name: "请选择",
                politics_name: "请选择",
                card_type_name: "请选择",
                bank_name: "请选择",// 银行开户行
                bank_city_name: "请选择",
                address_name: "请选择",
                disabled: false,
                showSign: false,
                second: 60,
                time: 0,
                code_disabled: false
            },
            computed: {
                text: function () {
                    return this.time > 0 ? this.time + 's后可重新获取' : '点击获取'
                }
            },
            methods: {
                toblur:function(){
                    document.activeElement.blur();
                },
                openSign: function () {
                    this.showSign = true
                    this.$nextTick(function () {
                        document.getElementById("signInput").focus()
                    })
                },
                checkIDBefore: function (val) {
                    var vm = this
                    if (vm.checkID(vm.user.card_type, val)) {
                        vm.checkIDOnline()
                    }
                },
                checkIDOnline: function () {
                    var vm = this
                    if (vm.checkName() && (vm.user.card_type == 'HAA0001' || vm.user.card_type == 'HAA0005' || vm.user.card_type == 'HAA0012')) {
                        luckyAjax({
                            data: {
                                data:JSON.stringify({
                                    card_no: vm.user.card_no,
                                    user_name: vm.user.user_name
                                }),
                                server: "user.checkIdCard"
                            },
                            success: function (ret) {
                                if (ret.code == 1) {
                                    mui.toast('实名认证通过，请继续填写', {duration: 'long', type: 'div'});
                                } else {
                                    mui.toast(ret.msg, {duration: 'long', type: 'div'});
                                    vm.disabled = false
                                }
                            }
                        });
                    }
                },
                // 验证证件类别与证件号码
                checkID: function (type, id_no) {
                    var toast_text = null
                    var vm = this
                    var Validator = new IDValidator();
                    if (!type) {
                        toast_text = '请选择证件类型';
                    } else if (!id_no) {
                        toast_text = '请输入证件号码';
                    } else {
                        switch (type) {
                            case 'HAA0001': // 身份证
                            case 'HAA0005': // 临时身份证
                            case 'HAA0012': // 户口本
                                // 不能为空
                                if (id_no.length !== 18) {
                                    toast_text = '证件号码不符合18位校验规则';
                                } else if (!Validator.isValid(id_no, 18)) {
                                    toast_text = '证件号码不符合公安部校验规则，请确认!';
                                } else {
                                    var data = Validator.getInfo(id_no, 18)
                                    Info.user.birthday = data.birth
                                    Info.user.sex = (data.sex == 1 ? "1": "0")
                                }
                                break;
                            case 'HAA0004':  // 护照
                                if (!/^[a-zA-Z]{5,17}$/.test(id_no) || !/^[a-zA-Z0-9]{5,17}$/.test(id_no)) {
                                    toast_text = '护照证件号码格式不正确，请重新输入';
                                }
                                break;
                            case 'HAA0006':
                                if (!/^[HMhm]{1}([0-9]{10}|[0-9]{8})$/.test(id_no)) {
                                    toast_text = '港澳通行证证件号码格式不正确，请重新输入';
                                }
                                break;
                            case 'HAA0007':
                                if (!/^[0-9]{8}$/.test(id_no) || !/^[0-9]{10}$/.test(id_no)) {
                                    toast_text = '台湾通行证证件号码格式不正确，请重新输入';
                                }
                                break;
                        }
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }
                    return true
                },
                // 校验姓名
                checkName: function () {
                    var toast_text = null
                    if (!Info.user.user_name) {
                        toast_text = '请输入姓名'
                    } else if (Info.user.user_name > 20) {
                        toast_text = '姓名长度不能超过20位'
                    } else if (/[a-z]/i.test(Info.user.user_name)) { // 英文
                        if (Info.user.user_name.replace(/\s/, '').length < 3) {
                            toast_text = '姓名不小于3个字符'
                        } else if (!/^[a-z]+[a-z\s]*[a-z]+$/i.test(Info.user.user_name) || /(\s)\1/.test(Info.user.user_name)) {
                            toast_text = '姓名填写有误'
                        }
                    } else if (/[\u4e00-\u9fa5·]/i.test(Info.user.user_name)) { // 中文
                        if (Info.user.user_name.length < 2) {
                            toast_text = '姓名不小于2个汉字'
                        } else if (!/^[\u4e00-\u9fa5]+[\u4e00-\u9fa5·]*[\u4e00-\u9fa5]+$/i.test(Info.user.user_name) || /(·)\1/.test(Info.user.user_name)) {
                            toast_text = '姓名填写有误'
                        }
                    } else if (!/^[a-z]+[\sa-z]*[a-z]+$/i.test(Info.user.user_name) &&
                        !/^[\u4e00-\u9fa5]+[\u4e00-\u9fa5·]*[\u4e00-\u9fa5]+$/i.test(Info.user.user_name)) { //中英文
                        toast_text = '姓名填写有误'
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }

                    return true
                },
                // 检验生日
                getAge: function (str) {
                    if (!str) return;
                    var now = new Date();
                    var year = now.getFullYear();
                    var month = now.getMonth() + 1;
                    var day = now.getDate();
                    var r = str.split('-').map(function (item) {
                        return parseInt(item);
                    });
                    var age = year - r[0];
                    if (r[1] > month || (r[1] === month && r[2] >= day)) { // 当月
                        age -= 1;
                    }
                    return age;
                },
                // 校验手机号码
                checkTel: function() {
                    var toast_text = null
                    if (!this.user.tel) {
                        toast_text = '请输入手机号码';
                    }
                    if (!/^(0|86|17951)?1[2|3|4|5|6|7|8|9][0-9]{9}$/.test(this.user.tel)) {
                        toast_text = '请输入正确的手机号码';
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }

                    return true
                },
                // 验证图片
                checkImg: function () {
                    var toast_text = null
                    var vm = this
                    if (!vm.image.person) {
                        toast_text = '请上传个人正面照片'
                    }else if (!vm.image.bank) {
                        toast_text = '请上传银行卡正面照片'
                    }else if (!vm.image.card_face) {
                        toast_text = '请上传身份证正面照片'
                    }else if (!vm.image.card_turn) {
                        toast_text = '请上传身份证反面照片'
                    }else if (!vm.image.sign) {
                        toast_text = '请手写签名'
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }
                    return true
                },
                // 基础信息校验
                checkBase: function () {
                    var toast_text = null
                    var vm = this

                    // 入职城市
                    if (!vm.user.city_work) {
                        toast_text = '请选择入职城市'
                    } else if (!vm.checkName()) {
                        return false
                    } else if (!vm.user.birthday || vm.user.birthday == "请选择") {
                        toast_text = '请选择出生日期'
                    } else if (vm.getAge(Info.user.birthday) < 18) {
                        toast_text = '年龄小于18岁不能激活'
                    } else if (!vm.user.nation) {
                        toast_text = '请选择民族'
                    } else if (!vm.user.province) {
                        toast_text = '请选择省级'
                    } else if (!vm.user.city) {
                        toast_text = '请选择市级'
                    } else if (!vm.user.address) {
                        toast_text = '请填写详细地址'
                    } else if (!vm.user.bank_no) {
                        toast_text = '请填写银行卡号'
                    } else if (!vm.user.bank) {
                        toast_text = '请选择银行开户行'
                    } else if (!vm.user.bank_city) {
                        toast_text = '请选择银行开户地'
                    } else if (!vm.checkTel()) {
                        return false
                    } else if (!vm.user.code) {
                        toast_text = '请填写手机验证码'
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }
                    return true
                },
                // 验证表单
                checkForm: function() {
                    var toast_text = null
                    var vm = this

                    if (!vm.checkBase()) {
                        return false
                    } else if (!vm.checkID(vm.user.card_type,vm.user.card_no)) {
                        return false
                    } else if (!vm.user.politics) {
                        toast_text = '请选择政治面貌'
                    } else if (!vm.user.academic) {
                        toast_text = '请选择学历'
                    } else if (!vm.user.grad_school) {
                        toast_text = '请填写毕业学校'
                    } else if (vm.work_on.length == 0) {
                        toast_text = '请至少填写一项工作经历'
                    } else if (!vm.checkImg()) {
                        return false
                    }

                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        return false;
                    }
                    return true
                },
                work: function(){
                    // 添加工作、编辑工作
                    var id = "", url=""
                    if (this.work_on.length == 0) {
                        id = 'member_register_addwork'
                        url = 'member-register-addwork.html'
                    } else {
                        id = 'member_register_editwork'
                        url = 'member-register-editwork.html'
                    }
                    mui.openWindow({
                        url: url,
                        id: id,
                        show: animateObj.aniDetal,
                        extras:{
                            work_on: this.work_on   // 工作经历
                        }
                    })
                },
                uploadSign: function (base64) {
                    luckyAjax({
                        data: {
                            data:JSON.stringify({
                                image: base64
                            }),
                            server: "user.uploadImg",
                            view: true
                        },
                        success: function (ret) {
                            if(ret.code == 1) {
                                Info.image['sign'] = ret.data
//                                $("#signature_img img").attr('src', signaturePad.toDataURL()).parent().removeClass('BL-hide')
                            } else {
                                mui.toast('上传签名失败', {duration: 'short', type: 'div'});
                            }
                        }
                    });
                },
                //发送验证码
                sendCode: function () {
                    var vm = this
                    if (vm.code_disabled) return false

                    var userinfo = JSON.parse(plus.storage.getItem('userinfo'))
                    if (vm.checkTel()) {
                        luckyAjax({
                            data: {
                                data: JSON.stringify({
                                    tel: vm.user.tel,
                                    channel_id: userinfo.channel_id
                                }),
                                view: true,
                                server: 'user.sendSms'
                            },
                            success: function (ret) {
                                if (ret.code === 1) {
                                    vm.code_disabled = true
                                    vm.sended()
                                    mui.toast(ret.msg, {duration: 'short', type: 'div'})
                                } else {
                                    mui.toast(ret.msg, {duration: 'short', type: 'div'})
                                    return false;
                                }
                            }
                        });
                    }
                },
                run: function () {
                    this.time = this.second
                    this.timer()
                },
                sended: function () {
                    mui.toast('发送成功', {duration: 'short', type: 'div'})
                    this.run()
                    this.code_disabled = true
                },
                timer: function () {
                    var vm = this
                    if (vm.time > 0) {
                        vm.time--
                        setTimeout(function () {
                            vm.timer()
                        }, 1000)
                    } else {
                        vm.code_disabled = false
                    }
                },
                addUser: function () {
                    // 验证表单
                    if (!Info.checkForm()) {
                        return false
                    }

                    if (!Info.agree_check) {
                        mui.toast('请阅读“藏保图”用户使用协议',{duration: 'short', type: 'div'});
                        return false
                    }

                    mui.toast('正在激活...',{duration: 'short', type: 'div'});
                    Info.disabled = true

                    setTimeout(function () {
                        Info.disabled = false
                    },2000)


                    var pushData = {}
                    var data = Info.user
                    for (var i in data) {
                        pushData[i] = data[i]
                    }
                    // 上传工作经历
                    pushData.work_on = []
                    Info.work_on.forEach(function(item, index) {
                        pushData.work_on.push({
                            start_time: item.start,
                            end_time: item.end,
                            company: item.name,
                            position: item.position
                        })
                    })
                    // 上传图片
                    pushData.image = {
                        person: Info.image.person,
                        bank: Info.image.bank,
                        card_face: Info.image.card_face,
                        card_turn: Info.image.card_turn,
                        sign: Info.image.sign
                    }

                    luckyAjax({
                        data: {
                            data: JSON.stringify(pushData),
                            server: "user.save"
                        },
                        success: function (ret) {
                            if (ret.code == 1) {
                                mui.toast('激活成功,请重新登录', {duration: 'short', type: 'div'});
                                luckyAjax({
                                    url: config.moduleURL + 'logout',
                                    success: function (res) {
                                        if (res.code) {
                                            var index_ws = plus.webview.getLaunchWebview();
                                            mui.fire(index_ws,'isStopTunnel',{'flag':true});
                                            plus.storage.clear();

                                            setTimeout(function(){
                                                plus.runtime.restart();
                                            }, 100);
                                        } else {
                                            mui.toast('退出失败', {duration: 'short', type: 'div'});
                                            return false
                                        }
                                    }
                                })
                            } else {
                                Info.disabled = false
                                mui.toast('激活失败，' + ret.msg, {duration: 'short', type: 'div'});
                            }
                        }
                    })
                }
            }
        });

        // 监听工作经历修改
        window.addEventListener('updateWork', function (e) {
            var work = e.detail.work
            var index = e.detail.index
            if (index.length != 0) {
                Vue.set(Info.work_on, index, work)
            } else {
                Info.work_on.push(work)
            }
        });

        // 监听工作经历编辑
        window.addEventListener('refreshWork', function (e) {
            Info.work_on = e.detail.work_on
        });

        //整理所有下拉框需要的数据
        function dataToselect(data) {
            var arr = [];
            mui.each(data, function (ind, ite) {
                arr.push({
                    text: ite.enum_name,
                    value: ite.id
                });
            });
            return arr;
        }

        //选择省市
        var _getParam = function (obj, param) {
            return obj[param] || '';
        };
        var cityPicker2 = new mui.PopPicker({
            layer: 2
        });
        cityPicker2.setData(cityData3);
        mui('.address-select-2').each(function (i, d) {
            d.addEventListener('tap', function () {
                Info.toblur()
                var _self = this;
                cityPicker2.show(function (items) {
                    if (i == 0) {
                        Info.user.city_work = _getParam(items[1], 'value')
                    } else if (i == 1) {
                        Info.user.bank_city = _getParam(items[1], 'value')
                    }
                    _self.innerText = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text');
                });
            }, false);
        })

        // 选择省市区
        var cityPicker3 = new mui.PopPicker({
            layer: 3
        });
        cityPicker3.setData(cityData3);
        mui('.address-select-3').each(function (i, d) {
            d.addEventListener('tap', function () {
                Info.toblur()
                var _self = this;
                cityPicker3.show(function (items) {
                    Info.user.province = _getParam(items[0], 'value')
                    Info.user.city = _getParam(items[1], 'value')
                    Info.user.district = _getParam(items[2], 'value')
                    _self.innerText = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(items[2], 'text');
                });
            }, false);
        })
        // 获取基础数据（民族、学历、政治面貌、银行类型、学历等）
        // 民族
        var nationType = new mui.PopPicker();
        document.querySelector('#Nation').addEventListener('tap', function () {
            Info.toblur()
            nationType.show(function (items) {
                Info.user.nation = items[0].value;
                Info.nation_name = items[0].text;
            })
        });
        // 学历
        var academicType = new mui.PopPicker();
        document.querySelector('#Academic').addEventListener('tap', function () {
            Info.toblur()
            academicType.show(function (items) {
                Info.user.academic = items[0].value;
                Info.academic_name = items[0].text;
            })
        });
        // 政治面貌
        var politicsType = new mui.PopPicker();
        document.querySelector('#Politics').addEventListener('tap', function () {
            Info.toblur()
            politicsType.show(function (items) {
                Info.user.politics = items[0].value;
                Info.politics_name = items[0].text;
            })
        });
        // 证件类型
        var cardType = new mui.PopPicker();
        document.querySelector('#Cardtype').addEventListener('tap', function () {
            Info.toblur()
            cardType.show(function (items) {
                Info.user.card_type = items[0].value;
                Info.card_type_name = items[0].text;
            })
        });
        // 银行开户行
        var bankType = new mui.PopPicker();
        document.querySelector('#Banktype').addEventListener('tap', function () {
            Info.toblur()
            bankType.show(function (items) {
                Info.user.bank = items[0].value;
                Info.bank_name = items[0].text;
            })
        });
        // 出生日期选择
        mui('.date').each(function (i, d) {
            d.addEventListener('tap', function () {
                Info.toblur()
                var optionsJson = this.getAttribute('data-options') || '{}';
                var options = JSON.parse(optionsJson);
                var _this = this
                var picker = new mui.DtPicker(options);
                picker.show(function (rs) {
                    Info.user.birthday = rs.text;
                    picker.dispose();
                });
            }, false);
        });

        //初始化下拉数据获取
        luckyAjax({
            data: {
                server: "user.getDownList",
                view: true
            },
            success: function (ret) {
                if(ret.code == 1) {
                    Info.init = ret.data
                    console.log("基础数据" + JSON.stringify(Info.init))
                      // 民族选择初始化
                    nationType.setData(dataToselect(Info.init.AG));
                      // 学历选择初始化
                    academicType.setData(dataToselect(Info.init.AH));
                      // 政治面貌选择初始化
                    politicsType.setData(dataToselect(Info.init.AF));
                      // 证件类型选择初始化
                    cardType.setData(dataToselect(Info.init.AA));
                      // 银行开户行选择初始化
                    bankType.setData(dataToselect(Info.init.AD))
                }
            }
        });
        // 协议
        document.querySelector('#protocol').addEventListener('tap',function () {
            //打开“藏保图”协议窗口
            mui.openWindow({
                url: "member-register-protocol.html",
                id: 'member_register_protocol',
                show: animateObj.aniDetal
            })
        })

        // 图片字段名
        const fileName = [
            'person',
            'bank',
            'card_face',
            'card_turn'
        ]

        // 上传图片页面
        mui('body').on('tap', '.form-upload', function (e) {
            var id = this.getAttribute('data-id')
            // 打开遮罩层，弹框
            showPopu("member-avatarmenu.html", "member-avatarmenu", "bottom",{id: id});
        });

        //获取要上传的证件
        window.addEventListener('img', function (event) {
            Info.$set(Info.previewImg, event.detail.id, {
                'backgroundImage': 'url(' + event.detail.img + ')'
            })
            console.log("222"+event.detail.img)
            // 上传到后台
            upload(fileName[event.detail.id],event.detail.img)
        })
        
        function upload(id, img) {
            luckyAjax({
                data: {
                    data:JSON.stringify({
                        image: img
                    }),
                    server: "user.uploadImg",
                    view: true
                },
                success: function (ret) {
                    if(ret.code == 1) {
                        Info.image[id] = ret.data
                    } else {
                        mui.toast('上传图片失败', {duration: 'short', type: 'div'});
                    }
                }
            });
        }
    })
</script>
</html>