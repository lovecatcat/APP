<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<link href="css/member.css" rel="stylesheet" />
		<script src="js/config.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
	</head>

	<body class="BL-bg-f2f">
		<div id="Js-content" class="mui-content" v-cloak>
			<div class="BL-bg-fff BL-pad-b-1">
				<!--日期搜索 begin-->
				<div id="Js-teamFilter" class="member-team-search BL-ub BL-ub-ac BL-ub-f1">
					<div class="search-date BL-ub BL-ub-ac">
						<input id="start_time" class="BL-ub BL-ub-f1 date" type="text" data-options='{"type":"date"}'/>
						<div class="down">
							<span class="BL-bimg-contain search-down"></span>
						</div>
					</div>
					<div class="search-date BL-ub BL-ub-ac">
						<input id="end_time" class="BL-ub BL-ub-f1 date" type="text" data-options='{"type":"date"}'/>
						<div class="down">
							<span class="BL-bimg-contain search-down"></span>
						</div>
					</div>
					<a id="search" class="searchbtn BL-ub BL-ub-pc">搜索</a>
				</div>
				<!--日期搜索 end -->
				<div id="Js-teamtab" class="BL-rel">
					<table width="100%" class="member-team-tab"> 
						<thead>
							<tr>
								<th width="18%"></th>
								<th width="20%">承保件数</th>
								<th width="30%">承保标保</th>
								<th width="20%">出单人数</th>
								<th width="12%">操作</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(item,index) in policy" :key="index">
                                <td>{{ item.name }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.money }}</td>
                                <td>{{ item.people_num == null? "-" : item.people_num }}</td>
                                <td><a class="BL-col-3b9cf5" @click="show_detail(item)">查看</a></td>
                            </tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="BL-bg-fff BL-mar-t-1">
				<div id="Js-teamFilter" class="member-team-search BL-ub BL-ub-ac BL-ub-f1">
					<div class="search-role BL-ub BL-ub-ac" style="width: 14.375rem;">
						<select id="rank_search" class="BL-ub BL-ub-f1">
							<option value="">全部</option>
                            <option v-for="(item,index) in rank_list" :value="item.rank_id">{{ item.rank_name }}</option>
						</select>
						<div class="down">
							<span class="BL-bimg-contain search-down"></span>
						</div>
					</div>
				</div>
				<ul class="mui-table-view">
				    <li v-for="(item,index) in person" :key="index" class="mui-table-view-cell member-team-list-item">
				        <a href="team-personal-performance.html" class="mui-navigate-right BL-ub BL-ub-ac item">
				        	<div class="img">
				        		<img :src="item.avatar | isErrorImg"/>
				        	</div>
				        	<div class="context BL-ub-f1">
				        		<div class="team-per-intro">
				        			<span>{{ item.user_name }}</span>
				        			<span>{{ item.rank_name }}</span>
				        		</div>
				        		<div class="team-per-ins">
				        			<span>承保<i class="BL-col-3b9cf5">3</i>件</span>
				        			<span>标保<i class="BL-col-3b9cf5">{{ item.money }}</i>元</span>
				        		</div>
				        	</div>
				        </a>
				    </li>
				</ul>
			</div>
			<div class="member-team-modal BL-ub BL-ub-ac" :class="{'BL-hide': show }">
				<div class="BL-bg-fff" v-if="policy_detail">
					<div class="member-team-modal-title BL-txt-c">
						{{ policy_detail.name }}
						<a class="mui-icon mui-icon-closeempty BL-abs" @click="hide_detail"></a>
					</div>
					<div class="member-team-modal-body" >
						<table class="member-team-tab fixed-thead">
							<thead>
								<tr class="BL-col-3b9cf5">
									<th width="40%">
										<div>承保件数</div>
										<div>{{ policy_detail.count }}件</div>
									</th>
									<th width="40%">
										<div>承保标保</div>
										<div>{{policy_detail.money}}元</div>
									</th>
									<th width="20%">出单件数</th>
								</tr>
							</thead>
						</table>
						<div class="member-team-scroll">
							<table class="member-team-tab">
								<tbody>
									<tr v-for="(item,index) in policy_detail.details" :key="index">
										<td class="BL-txt-l" width="40%">{{ index+1 }}.{{ item.product_name }}</td>
										<td width="40%">标保 <span class="BL-col-3b9cf5">{{ item.money }}</span>元</td>
										<td width="20%">{{ item.count }}件</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script src="js/mui.picker.js"></script>
	<script src="js/mui.dtpicker.js"></script>
	<script src="js/vue.min.js"></script>
	<script src="js/Date.js"></script>
	<script type="text/javascript">
		mui.init()
		
		var team = new Vue({
			el: '#Js-content',
			data: {
				policy: [
					{"count": 0,"people_num": 0,"money": 0,"name": "本人","details": []},
                    {"count": 0,"people_num": 0,"money": 0,"name": "事务所合伙人","details": []},
                    {"count": 0,"people_num": 0,"money":0,"name": "高级合伙人","details":[]},
                    {"count": 0,"people_num": 0,"money":0,"name": "合伙人","details":[]},
                    {"count": 0,"people_num": 0,"money":0,"name": "顾问","details":[]},
                    {"count": 0,"people_num": 0,"money":0,"name": "会员","details":[]}
				],
				policy_detail: null,
				rank_list: null,
				person: null,
				show: true
			},
			created: function () {
        	},
			methods: {
				show_detail: function(item) {
                    this.policy_detail = item
                    this.show = false
                },
                hide_detail: function() {
                	this.show = true
                }
			}
		});
		//定义合伙人头像过滤器
        Vue.filter('isErrorImg', function(imgUrl) {
            var reg = new RegExp("(https|http)?://.+\.(jpg|gif|png|jpeg|bmp)");
            if(imgUrl && reg.test(imgUrl)){
                return imgUrl;
            }else{
                return "images/pic/logo.png";
            }
        });
        
		(function($){
			var start_time = document.getElementById("start_time")
			var end_time = document.getElementById("end_time")
			// 阻尼系数
			var deceleration = mui.os.ios ? 0.003 : 0.0009;
			$('#Js-cmistab .mui-scroll-wrapper').scroll({
				bounce: true,
				indicators: false, //是否显示滚动条
				deceleration: deceleration
			});
			
			// 设置内容区域
			$.plusReady(function() {
				var winH = window.innerHeight;
				var divHeight = document.querySelector('#Js-teamFilter').offsetHeight;
				document.querySelector('#Js-content').style.height = winH - divHeight + 'px';
			});	
			
			// 日期选择
			var dates = $('.date');
			dates.each(function(i, d) {
				d.addEventListener('tap', function() {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var _this = this
					var picker = new $.DtPicker(options);
					picker.show(function(rs) {
						_this.value = rs.text;
						picker.dispose();
					});
				}, false);
			});
			// 登录
			var data = {
				type: 'account',
				channel_id: 1,
				data: JSON.stringify({keyword: "陆惠忠", password: "123456"})
			};
			mui.post("http://www.luckyins.com/api/api/login", data, function(ret) {
				alert(ret.msg)
			});
				
			// 初始化当前月份和上个月份的团队业绩数据
			start_time.value = new Date().addDays(0).Format('yyyy-MM-dd')
			end_time.value = new Date().addMonth(-1).Format('yyyy-MM-dd')
			getScore(start_time.value, end_time.value)
			
			// 点击搜索按钮事件
			document.querySelector('#search').addEventListener('tap', function(){
				var s_time = start_time.value
				var e_time = end_time.value
				getScore (s_time, e_time)
			})
			
			// 团队角色下拉框事件
			document.querySelector('#rank_search').addEventListener('change', function(){
				var index = this.selectedIndex
				var rank_id = this.options[index].value
				getTempList(start_time.value,end_time.value,rank_id)
			})
		}(mui));
		
		/**
	     * 获取团队业绩
	     * @param {String} start_time 开始时间
	     * @param {String} end_time  结束时间
	     */
		function getScore (start_time,end_time) {
			mui.ajax(config.baseUrl, {
	            data: {
	            	start_time: start_time,
	            	end_time: end_time,
	            	data: JSON.stringify({user_id: 65}),
	                server: 'team.getScore',
	                device: 'mobile'
	            },
	            dataType: 'json',
	            type: 'post',
	            success: function (ret) {
	                if (ret.code) {
	                    team.policy = ret.data.policy;
	                    team.rank_list = ret.data.rank_list;
	                    team.person = ret.data.person.list
	                }
	            },
	            error: function () {
	                plus.nativeUI.toast('网络异常：101')
	            }
        	});
		}
		/**
		 * 获取团队成员列表
		 * @param {String} start_time 开始时间
		 * @param {String} end_time  结束时间
		 * @param {String} rank_id 角色ID
		 */
		function getTempList (start_time,end_time,rank_id) {
			mui.ajax(config.baseUrl, {
				data: {
					start_time: start_time,
					end_time: end_time,
					data: JSON.stringify({user_id: 65,rank_id:rank_id}),
					server: 'team.getTempList',
					device: 'mobile'
				},
				dataType: 'json',
				type: 'post',
				success: function (ret) {
					if (ret.code) {
						team.person = ret.data.list
					}
				},
				error: function () {
					plus.nativeUI.toast('网络异常：101')
				}
			});
		}
		
		//主列表点击事件
		mui('body').on('tap', 'a', function() {
			var href = this.getAttribute('href');
			var id = this.getAttribute("data-wid");
			var anIn = this.getAttribute('data-ani'); // 使用fadeIn打开新页面

			//非plus环境，直接走href跳转
			if(!mui.os.plus) {
				location.href = href;
				return;
			}

			if(href && ~href.indexOf('.html')) {
				//打开新窗口
				if(anIn){
					mui.openWindow({
						url: href,
						id: id,
						show: animateObj.aniDetal
					});	
				}else{
					mui.openWindow({
						url: href,
						id: id,
						show: animateObj.aniPage
					});	
				}
			}
		});
	</script>
</html>
