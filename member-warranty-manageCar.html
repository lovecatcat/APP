<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>寿险订单</title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/member.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
</head>

<body class="BL-bg-f2f">
    <div class="mui-content">
        <div id="Js-content" class="mui-content" v-cloak>
        <!--搜索 begin-->
        <div id="Js-teamFilter" class="member-team-search member-warranty-search BL-ub BL-ub-ac BL-bg-fff">
            <div class="search-date BL-rel">
                <div class="BL-pad-lr-1" id='warranty_date' data-options='{"type":"month","beginYear":1950}'>{{warranty_date.text}}</div>

                <div class="down BL-abs">
                    <span class="BL-bimg-contain search-down"></span>
                </div>
            </div>
            <div class="search-date BL-rel">
                <div class="BL-pad-lr-1" id="company">{{company_type.text}}</div>
                <div class="down BL-abs">
                    <span class="BL-bimg-contain search-down"></span>
                </div>
            </div>
        </div>
        <!--搜索 end -->
        <!------------车险订单列表 begin------------->
        <div id="Js-warrantyList">
            <div class="mui-content mui-scroll-wrapper BL-bg-f2f" style="top: 6.625rem;">
                <div class="mui-scroll">
                    <ul class="mui-table-view">
                        <li class="member-warranty-list-item" v-for="item in warranty_list">
                            <div class="BL-title BL-pad-lr-1_5 BL-bg-ebf5fe BL-ftz-46 BL-txt-l">
                                <span>保单号:</span>
                                <span>{{item.contract_no}}</span>
                                <span class="BL-col-3b9cf5 fr">{{item.status}}</span>
                            </div>
                            <div class="BL-pad-lr-1_5 BL-pad-tb-1_5">
                                <div class="BL-ub-f1 context">
                                    <div class="team-per-ins BL-pad-b-1">
                                        <span>车牌号:<i>{{item.vehicle_no}}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span>被保人:<i>{{item.ass_name}}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span v-if="item.product_type == 1">交强险保费(元)：<i>{{ item.totalFee }}</i></span>
                                        <span v-if="item.product_type == 2">商业险保费(元)：<i>{{ item.totalFee }}</i></span>
                                    </div>
                                    <div class="team-per-ins BL-pad-b-1 clearfloat">
                                        <span>提交时间：<i>{{ item.create_time }}</i></span>
                                    </div>
                                </div>
                                <div class="BL-txt-r button">
                                    <a data-wid="member_warranty_manageAuto_detail" :data-no="item.business_no" href="member-warranty-manageAuto-detail.html" class="BL-btn-blue BL-pad-lr-2 BL-mar-l-1">详情</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!------------车险订单列表 end  ------------->
    </div>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.picker.js"></script>
<script src="js/mui.dtpicker.js"></script>
<script src="js/mui.poppicker.js"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/vue.min.js"></script>
<script type="text/javascript">
    var user_id;
    var manageAuto = new Vue({
        el: '#Js-content',
        data: {
            warranty_date: {
                value: '',
                text: '选择日期'
            },
            company_type: {
                value: '',
                text: '保险公司'
            },
            company: [],
            warranty_list: [],  // 列表数据
            page: 0
        }
    });
    mui.init();
    (function($) {
        //阻尼系数
        var deceleration = mui.os.ios ? 0.003 : 0.0009;
        $('#Js-warrantyList .mui-scroll-wrapper').scroll({
            bounce: true,
            indicators: false, //是否显示滚动条
            deceleration: deceleration
        });
        $.plusReady(function() {
            user_id = JSON.parse(plus.storage.getItem("userinfo")).id
            var winH = window.innerHeight;
            var divHeight = document.querySelector('#Js-teamFilter').offsetHeight;
            document.querySelector('#Js-warrantyList').style.height = winH - divHeight + 'px';
            var self; // $('#Js-warrantyList .mui-scroll')的this

            // 保险公司
            var company = new mui.PopPicker();
            document.querySelector('#company').addEventListener('tap', function() {
                var _self = this;
                company.show(function(items) {
                    manageAuto.company_type.text = items[0].text;
                    manageAuto.company_type.value = items[0].value;
                    manageAuto.page = 1;
                    manageAuto.warranty_list = []
                    mui('.mui-scroll-wrapper').scroll().scrollTo(0,0);
                    pullAjax()
                });
            }, false);
            //选择日期月
            document.querySelector('#warranty_date').addEventListener('tap', function() {
                var _self = this;
                var optionsJson = this.getAttribute('data-options') || '{}';
                var options = JSON.parse(optionsJson);
                _self.picker = new mui.DtPicker(options);
                _self.picker.show(function(rs) {
                    manageAuto.warranty_date.text = rs.text;
                    manageAuto.warranty_date.value = (rs.text).replace('-','');
                    _self.picker.dispose();
                    _self.picker = null;
                    manageAuto.page = 1;
                    manageAuto.warranty_list = []
                    mui('.mui-scroll-wrapper').scroll().scrollTo(0,0);
                    pullAjax()
                }, false);
            });

            // 获取保险公司列表
            luckyAjax({
                data: {
                    server: 'carIns.getCompanyList',
                },
                success: function(res){
                    if(res.code == 1) {
                        manageAuto.company = []
                        $.each(res.data, function(index, item) {
                            manageAuto.company.push({
                                value: item.id,
                                text: item.company_name
                            })
                        });
                        company.setData(manageAuto.company);
                    } else {
                        mui.toast(res.msg, {duration: 'long', type: 'div'})
                    }
                }
            });
            //循环初始化所有下拉刷新，上拉加载。
            var pullAjax = function(e) {
                plus.nativeUI.showWaiting();
                luckyAjax({
                    data: {
                        server: 'carIns.getPaidPolicyList',
                        data: JSON.stringify({
                            userId: user_id,
                            company: manageAuto.company_type.value, // 保单类型
                            month: manageAuto.warranty_date.value,
                            page: manageAuto.page,
                            row: 10
                        })
                    },
                    success:function(res){
                        plus.nativeUI.closeWaiting();
                        if(res.code == 1) {
                            if (manageAuto.page >= res.data.page) {
                                self.endPullUpToRefresh(true);
                            } else {
                                self.endPullUpToRefresh(false);
                            }
                            if (e) {
                                manageAuto.warranty_list = res.data.list;
                            } else {
                                var list = res.data.list;
                                mui.each(list, function (index, item) {
                                    manageAuto.warranty_list.push(item);
                                });
                            }
                        } else {
                            mui.toast(res.msg, {duration: 'long', type: 'div'})
                        }
                    }
                });
            }
            $('#Js-warrantyList .mui-scroll').pullToRefresh({
                up: { // 上拉加载更多
                    auto: true, // 自动上拉一次
                    callback: function() {
                        manageAuto.page++;
                        self = this;
                        pullAjax()
                    }
                }
            });
        });

        //跳转详情
        $('body').on('tap', 'a', function() {
            var href = this.getAttribute('href');
            var id = this.getAttribute("data-wid");
            var business_no = this.getAttribute("data-no");

            //非plus环境，直接走href跳转
            if(!mui.os.plus) {
                location.href = href;
                return;
            };

            if(href && ~href.indexOf('.html')) {
                //打开新窗口
                mui.openWindow({
                    id: id,
                    url: href,
                    show: animateObj.aniDetal,
                    extras:{
                        business_no: business_no  //扩展参数
                    }
                });
            }

        });
    }(mui));
</script>

</html>