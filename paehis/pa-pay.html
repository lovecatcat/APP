<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>收银台</title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <script src="../js/sha256.js" type="text/javascript"></script>
    <script src="../js/config.js" type="text/javascript"></script>
</head>

<body class="BL-bg-f2f">
<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
        <a id="Js-closePage" class="BL-ctrl-close">关闭</a>
        <!--<a id="Js-closePage" class="mui-icon-closeempty BL-icon" style="left: 4rem;font-size: 4rem;font-weight: 500;"></a>-->
        <h1 class="BL-title">收银台</h1>
    </div>
</header>
</body>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="method.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();

    (function ($) {
        $.plusReady(function () {
            statusbar();
            var topHeight = document.getElementById('Js-header').offsetHeight / sizeObj.dpl;

            //跳转收银台
            var secretKey = null //密钥
            var interfaceUrl = null
            if (config.domain.indexOf('ts-') > -1) {
                secretKey = '93BEWPQ82UB1NYSWQN6Y1RVUVG687FIG' //移动端
                interfaceUrl = 'https://test-mobile.health.pingan.com:42443'
            } else { //正式
                secretKey = 'AFZOEUEVTHG8LS46EGDUHQQH5TWGP3QW' //移动端
                interfaceUrl = 'https://mobile.health.pingan.com'
            }
            const channel_order_no = plus.webview.currentWebview().order_no;
            const goods_desc = '平安e生保'
            const total_fee = plus.webview.currentWebview().fee * 100
            const channel_id = '000032'
            const return_url = config.domain + '/api/api/callBack?param=PingAn.ReturnUrl'
            const notify_url = config.domain + '/api/api/callBack?param=PingAn.notifyUrl'
            const sign_type = 'SHA-256'
            var sign = ''

            var basedata = 'channel_id=' + channel_id + '&channel_order_no=' + channel_order_no + '&goods_desc=' + goods_desc + '&notify_url=' + notify_url + '&return_url=' + return_url
            var string = '&total_fee=' + total_fee

            sign = CryptoJS.SHA256(basedata + string + secretKey) + ''

            var url = interfaceUrl + '/ehis-hm/cashier/pay.do?' + 'channel_id=' + channel_id + '&channel_order_no=' + channel_order_no + '&goods_desc=' + encodeURIComponent(goods_desc) + '&notify_url=' + encodeURIComponent(notify_url) + '&return_url=' + encodeURIComponent(return_url) + '&sign=' + sign + '&sign_type=' + sign_type + string
            console.log(url)
            var embed = plus.webview.create(url, '', {top: topHeight + 'px', bottom: '0px'});
            plus.webview.currentWebview().append(embed);

            // 自定义返回事件
            mui.oldBack = mui.back;
            mui.back = function () {
                embed.canBack(function (e) {
                    if (e.canBack) {
                        embed.back();
                    } else {
                        mui.oldBack();
                    }
                })
            };

            document.querySelector('#Js-closePage').addEventListener('tap', function () {
//                mui.oldBack();
                luckyAjax({
                    data: {
                        data: JSON.stringify({
                            msg: {policy_id: plus.webview.currentWebview().policy_id},
                            company_code: 'PingAn',
                            method: 'pay'
                        }),
                        server: 'PolicyIns.onlineInsured',
                        device: 'mobile'
                    },
                    timeout: 10000,
                    success: function (res) {
                        console.log(JSON.stringify(res))
                        if (res.code) {
                            console.log('支付成功')
                            plus.webview.close('pa_pay');
                            plus.webview.close('pa_toinsure');
                            plus.webview.close('pa_question');
                            plus.webview.close('pa_insurance-index');
                            mui.oldBack();
                        } else {
                            console.log('支付失败')
                            plus.webview.close('pa_pay');
                            plus.webview.close('pa_toinsure');
                            plus.webview.close('pa_question');
                            plus.webview.close('pa_insurance-index');
                            mui.oldBack();
                        }
                    }
                })
            }, false);

        });
    })(mui);
</script>

</html>