<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/module.css" rel="stylesheet" />
		<link href="css/plans.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<script src="js/config.js" type="text/javascript"></script>

	</head>

	<body class="BL-bg-f2f">
		<div id="prospect">
			<header id="Js-header" class="BL-bg-fff">
				<div class="BL-mod-headbar BL-mod-headbar-pos">
					<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
					<h1 class="BL-title">计划书制作</h1>
				</div>
				<!--计划书方案选项 begin-->
				<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted BL-segmented-control">
					<div class="mui-scroll">
						<div data-wid="prospect_main" href="prospect-main.html" class="plans-nav mui-active" v-for="plan,index in plans" :key="plan.id" :data-id="plans[index].id" :data-index="index" :id="'plan'+ plans[index].id">
							<span v-if="!plans[index].assu.name">保障计划</span>
							<span v-else>{{plans[index].assu.name}}</span>
							<i class="mui-icon mui-icon-clear" @tap="removePlan(index)" v-if="plans.length > 1"></i>
						</div>
					</div>
				</div>
				<!--计划书方案选项 end -->
				
			</header>

			<div id="Js-content" class="mui-content BL-overFlow-autoY">
				<!--方案名称 begin -->
				<div class="BL-ub BL-rel BL-bg-fff BL-pad-lr-1_5 BL-pad-tb-1 input-item BL-border-b" style="margin: 1rem 0 0 0;">
					<label>计划名称</label>
					<div class="input-wrap input-wrap-planName box-f-1">
						<input v-model.trim="alias" type="text" placeholder="请输入(选填)" @focus="hideKeyboard" @blur="showKeyboard">
						<div class="form-clear-icon" v-show="alias != ''">
							<span class="mui-icon mui-icon-clear" @tap="alias = '' "></span>
						</div>
					</div>
				</div>
				<!--方案名称 end -->
				<!--投保人信息 begin -->
				<div class="BL-bg-fff prospect-info BL-mar-t-1">
					<div class="BL-pad-tb-1 BL-ub BL-ub-ac BL-rel BL-border-b title">
						<div class="BL-pad-lr-1_5 BL-col-3b9cf5">投保人信息</div>
						<button class="BL-btn-blue BL-abs BL-pad-lr-1 BL-ub BL-ub-ac" @tap="!edit2 && displace()">
						<span>投</span><i class="displace-icon"></i><span>被</span>
					</button>
					</div>
					<div class="BL-pad-lr-1_5 BL-pad-b-1 main">
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label>姓名</label>
							<div class="input-wrap">
								<input v-model.trim="appl.name" @change="checkName(appl.name, '投保人')" @focus="hideKeyboard" @blur="showKeyboard" :readonly="edit2 && plan_id == 1" type="text" placeholder="请输入真实姓名">
								<div class="form-clear-icon" v-show="appl.name != '' && !edit2">
									<span class="mui-icon mui-icon-clear" @tap="appl.name = '' "></span>
								</div>
							</div>
							<div class="right-orange-btn address-icon" @tap="!edit2 && communic('appl')"> </div>
						</div>
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label class="">年龄</label>
							<div class="input-wrap box-f-1 search-date" data-options='{"type":"date","beginYear":1900}'>
								<input v-model.lazy="appl.birthday" readonly type="text" placeholder="选择生日">
								<div class="ins-date-icon"></div>
							</div>
							<div class="input-wrap box-f-1  BL-mar-l-1">
								<input v-model.number.trim="appl.age" @change="checkAge(appl.age, '投保人')" @focus="hideKeyboard" @blur="appl.birthday = '', showKeyboard()" :readonly="edit2" type="number" placeholder="输入年龄">
								<div class="form-clear-icon" v-show="appl.age != '' && !edit2">
									<span class="mui-icon mui-icon-clear" @tap="appl.age = '' "></span>
								</div>
							</div>

						</div>
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label class="">性别</label>
							<div class="input-wrap box-f-1">
								<button :class="{'BL-btn-blue': appl.sex == true, 'BL-btn-black': appl.sex == false}" @tap="!edit2 && applSex(true)" :readonly="edit2 && plan_id == 1" v-model="appl.sex">男</button>
								<button :class="{'BL-btn-blue': appl.sex == false, 'BL-btn-black': appl.sex == true}" @tap="!edit2 && applSex(false)" :readonly="edit2 && plan_id == 1" v-model="appl.sex">女</button>
							</div>
						</div>
					</div>
				</div>
				<!--投保人信息 end -->
				<!--被保人信息 begin -->
				<div class="BL-bg-fff BL-mar-t-1 prospect-info">
					<div class="BL-pad-tb-1 BL-ub BL-ub-ac BL-rel BL-border-b title">
						<div class="BL-pad-lr-1_5 BL-col-3b9cf5">被保人信息</div>
						<button class="BL-btn-blue BL-abs BL-pad-lr-1 BL-ub BL-ub-ac" @tap="!edit2 && keepSame()">
						<span>同投保人</span>
					</button>
					</div>
					<div class="BL-pad-lr-1_5 BL-pad-b-1 main">
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label>姓名</label>
							<div class="input-wrap">
								<input v-model.trim="assu.name" @change="checkName(assu.name, '被保人')" @focus="hideKeyboard" @blur="showKeyboard" :readonly="edit2 && plan_id == 1" type="text" placeholder="请输入真实姓名">
								<div class="form-clear-icon" v-show="assu.name != '' && edit2 && plan_id != 1">
									<span class="mui-icon mui-icon-clear" @tap="assu.name = '' "></span>
								</div>
							</div>
							<div class="right-orange-btn address-icon" @tap="!edit2 && communic('assu')"></div>
						</div>
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label class="">年龄</label>
							<div class="input-wrap box-f-1 search-date" data-options='{"type":"date","beginYear":1900}'>
								<input v-model.lazy="assu.birthday" readonly type="text" placeholder="选择生日">
								<div class="ins-date-icon"></div>
							</div>
							<div class="input-wrap box-f-1  BL-mar-l-1">
								<input v-model.number.trim="assu.age" @change="checkAge(assu.age, '被保人')" @focus="hideKeyboard" @blur="assu.birthday = '', showKeyboard()" :readonly="edit2" type="number" placeholder="输入年龄">
								<div class="form-clear-icon" v-show="assu.age != '' && !edit2">
									<span class="mui-icon mui-icon-clear" @tap="assu.age = '', assu.birthday = '' "></span>
								</div>
							</div>

						</div>
						<div class="BL-ub BL-rel BL-mar-t-1 input-item">
							<label class="">性别</label>
							<div class="input-wrap box-f-1">
								<button :class="{'BL-btn-blue': assu.sex == true, 'BL-btn-black': assu.sex == false}" @tap="!edit2 && assuSex(true)" :readonly="edit2 && plan_id == 1" v-model="assu.sex">男</button>
								<button :class="{'BL-btn-blue': assu.sex == false, 'BL-btn-black': assu.sex == true}" @tap="!edit2 && assuSex(false)" :readonly="edit2 && plan_id == 1" v-model="assu.sex">女</button>
							</div>
						</div>
					</div>
				</div>
				<!--被保人信息 end -->
				<!--险种信息 begin -->
				<div class="BL-bg-fff BL-mar-t-1 prospect-info clearfloat" :class="{'BL-pad-b-3' : planList[plan_id].length > 0}">
					<div class="BL-pad-tb-1 BL-ub BL-ub-ac BL-rel BL-border-b title">
						<div class="BL-pad-lr-1_5 BL-col-3b9cf5">险种信息</div>
						<button class="BL-btn-blue BL-abs BL-pad-lr-1" @tap="addIns">添加险种</button>
					</div>
					<template v-if="planList&&planList[plan_id]" v-for="item1,index1 in planList[plan_id]" :key="index1">
						<div class="clearfloat" v-if="item1" v-for="item,index in item1" :key="index">
							<!--主险信息 begin -->
							<div class="BL-pad-lr-1_5 BL-pad-t-2 BL-bg-fff">
								<div class="BL-ub plans-total-content BL-pad-b-1">
									<div class="BL-ub-f4">
										<span class="BL-col-ff8201 plans-total-font BL-ftz-46" v-if="item.fj && item.safe_id !== 'LJYSMZ' && item.safe_id !== 'A47P'">[附加]</span>
										<span class="plans-total-font BL-ftz-46">{{item.name}}</span>
										<div class="plans-total-font BL-ftz-42">首年保费:{{item.period_money}}</div>
									</div>
									<div class="BL-ub-f1 BL-txt-r">
										<button class="BL-btn-white BL-ftz-42" @tap="del(index1, index, item.fj)">删除</button>
										<button class="BL-btn-blue BL-ftz-42" v-if="!item.fj" @tap="editIns(index1, item)">编辑</button>
									</div>
								</div>
								<ul class="BL-ul BL-col-999 BL-col-999 BL-ftz-42">
									<li>
										<span>保险金额</span>
										<span>保险期间</span>
										<span>缴费年限</span>
										<span>首年保费</span>
									</li>
									<li>
										<span v-if="item.money && item.safe_id !== 'DAR' && item.safe_id !== 'HI' && item.safe_id !== 'RP8P' && item.safe_id !== 'P005'">{{Number(item.money).toFixed(2)}}</span>
										<span v-else-if="item.safe_id == 'P005'">
											{{String(item.money).length > 3 ? '无社保'+String(item.money).substring(1, String(item.money).length) : '有社保' + item.money}}万
										</span>
										<span v-else>—</span>
										<span>{{item.safe_year , item.safe_id | safeYearFilter}}</span>
										<span>{{item.pay_year | payYearFilter}}</span>
										<span class="hm-color__red year_fee">{{item.period_money}}</span>
									</li>
								</ul>

							</div>
							<!--主险信息 end -->
						</div>
						<div class="clearfloat BL-pad-b-1">
							<button class="BL-btn-white BL-ftz-42 BL-mar-t-1 BL-pad-lr-2 prospect-info-button BL-hide">+添加附加险</button>
						</div>
					</template>
				</div>
				<!--险种信息 end -->
				<div style="width: 100%;height: 5.625rem;"></div>
			</div>
			<footer id="Js-footer" class="BL-footer BL-bg-fff BL-pad-tb-1 BL-Border-t" v-if="JsFooter">
				<div class="BL-ub BL-ub-ac BL-ub-f1">
					<div id="" class="BL-ub BL-ub-f1 BL-ub-ac BL-foot-selectAll">
						<div class="context" id="aaaa">
							总保费: <span class="BL-col-ff8201">{{count}}</span>
						</div>
					</div>
					<button class="BL-btn-white BL-pad-tb-1 BL-pad-lr-1 BL-mar-r-1 BL-ftz-46" v-if="!edit2" @tap="addPlan">新增方案</button>
					<button class="BL-btn-blue BL-pad-tb-1 BL-pad-lr-1 BL-mar-r-1 BL-ftz-46" v-if="!edit2" @tap="pushPlan">生成计划书</button>
					<button class="BL-btn-blue BL-pad-tb-1 BL-pad-lr-1 BL-mar-r-1 BL-ftz-46" v-else @tap="pushPlan">确认编辑</button>
				</div>
			</footer>
		</div>
	</body>
	<script src="js/mui.min.js" type="text/javascript"></script>
	<script src="js/vue.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/mui.picker.js"></script>
	<script src="js/mui.dtpicker.js"></script>
	<script type="text/javascript">
		var getAge;
		var count;
		var totalData;
		var parent_pl_id;
		var prospect = new Vue({
			el: '#prospect',
			data: {
				alias: '',
				max_id: 1, //id叠加
				plan_id: 1, //当前的数据
				plans: [{
					id: 1,
					ins: [],
					appl: {
						age: '',
						name: '',
						sex: true
					},
					assu: {
						age: '',
						name: '',
						sex: true
					}
				}],
				appl: {
					name: '',
					age: '',
					sex: true,
					birthday: ''
				},
				assu: {
					name: '',
					age: '',
					sex: true,
					birthday: ''
				},
				planList: { //保险计划的列表
					1: []
				},
				count: 0, //总保费
				planTime: {}, //临时保存的数据
				edit: false, //是不是编辑状态
				edit2: false, //是不是从编辑页面过来
				Communic: null, //通讯录
				clickNav: false, //没有点击nav
				editIndex: null, //是不是點擊了編輯按鈕
				JsFooter: true //頂部是不是隱藏
			},
			watch: {
				appl: {
					handler: function(val) {
						//更改了数据
						for(var i = 0; i < prospect.plans.length; i++) {
							if(prospect.plans[i].id == prospect.plan_id) {
								prospect.plans[i].appl = val
							}
						}
						this.appl.birthday && getAge(val.age, 0)
					},
					deep: true
				},
				assu: {
					handler: function(val) {
						for(var i = 0; i < prospect.plans.length; i++) {
							if(prospect.plans[i].id == prospect.plan_id) {
								prospect.plans[i].assu = val
								if(this.clickNav) { // 切换为未点击nav的状态
									this.clickNav = false
								} else { //未点击nav状态改变值
									prospect.plans[i].ins = [];
									prospect.planList[prospect.plan_id] = [];
									count()
								}
							}
						}
						this.assu.birthday && getAge(val.age)
					},
					deep: true
				}

			},
			filters: {
				safeYearFilter: function(value, safeid) {
					if(value > 999) {
						var i = String(value).substring(0, String(value).length - 2)
						return '至' + i + '周岁';
					} else if(value > 50 && value !== '999' && value !== 999 && value < 999) {
						return '至' + value + '周岁';
					} else if(value == 25 && safeid == '1166') {
						return '至25周岁';
					} else if(value < 50 && value > 0) {
						return value + '年';
					} else {
						return '终身';
					}
				},
				payYearFilter: function(value) {
					if(value === 1) {
						return '趸交';
					} else if(value < 60) {
						console.log('filter');
						return value + '年交';
					} else {
						return '至' + value + '岁';
					}
				},
				moneyFilter: function(value) {
					return value.toFixed(2)
				}
			},
			methods: {
				parseVueObj: function(Obj) {
					return JSON.parse(JSON.stringify(Obj))
				},
				toblur: function() {
					document.activeElement.blur();
					this.JsFooter = true
				},
				hideKeyboard: function() {
					this.JsFooter = false
				},
				showKeyboard: function() {
					this.JsFooter = true
				},
				deepClone: function(obj) {
					var newObj = obj instanceof Array ? [] : {};
					for(var i in obj) {
						newObj[i] = typeof obj[i] == 'object' ? deepClone(obj[i]) : obj[i];
					}
					return newObj;
				},
				applSex: function(i) {
					this.toblur()
					this.appl.sex = i
				},
				assuSex: function(i) {
					this.toblur()
					this.assu.sex = i
				},
				checkName: function(name, owner) { //校验姓名
					var toastText = false
					if(!name) {
						toastText = owner + '姓名不能为空'
					} else if(name.length > 20) {
						toastText = owner + '姓名长度不能超过20位'
					} else if(/[a-z]/i.test(name)) { // 英文
						if(name.replace(/\s/, '').length < 3) {
							toastText = owner + '姓名不小于3个字符'
						} else if(!/^[a-z]+[a-z\s]*[a-z]+$/i.test(name) || /(\s)\1/.test(name)) {
							toastText = owner + '姓名填写有误'
						}
					} else if(/[\u4e00-\u9fa5·]/i.test(name)) { // 中文
						if(name.length < 2) {
							toastText = owner + '姓名不小于2个汉字'
						} else if(!/^[\u4e00-\u9fa5]+[\u4e00-\u9fa5·]*[\u4e00-\u9fa5]+$/i.test(name) || /(·)\1/.test(name)) {
							toastText = owner + '姓名填写有误'
						}
					} else if(!/^[a-z]+[\sa-z]*[a-z]+$/i.test(name) && !/^[\u4e00-\u9fa5]+[\u4e00-\u9fa5·]*[\u4e00-\u9fa5]+$/i.test(name)) { // 中英文
						toastText = owner + '姓名填写有误'
					}
					if(toastText) {
						mui.toast(toastText);
						return false;
					} else {
						return true;
					}
				},
				checkAge: function(age, owner) { //校验年龄
					var toastText = false
					if(age == '' && age != 0) {
						toastText = owner + '年龄不能为空'
					} else if(Number(age) < 18 && owner == '投保人') {
						toastText = owner + '不能小于18周岁'
					}
					this.JsFooter = true
					if(toastText) {
						mui.toast(toastText);
						return false;
					} else {
						return true;
					}
				},
				keepSame: function() { //同投保人
					this.toblur()
					this.assu = this.deepClone(this.appl)
				},
				displace: function() { //投被保人替换
					this.toblur()
					var appl = this.appl
					var assu = this.assu
					if(!appl.name && !appl.age) {
						appl = this.plans[0].appl
						assu = this.plans[0].assu
					}
					this.appl = this.deepClone(assu)
					this.assu = this.deepClone(appl)
				},
				addIns: function() { //添加险种
					this.toblur()
					this.editIndex = null
					if(!this.checkName(this.appl.name, '投保人')) {
						return false;
					} else if(!this.checkAge(this.appl.age, '投保人')) {
						return false;
					} else if(!this.checkName(this.assu.name, '被保人')) {
						return false;
					} else if(this.assu.age === '') {
						mui.toast('被保人年龄不能为空')
						return false;
					} else {
						mui.openWindow({
							id: 'prospect_addIns',
							url: 'prospect-addIns.html',
							show: animateObj.aniDetal,
							extras: {
								appl: this.appl,
								assu: this.assu,
								plan_id: this.plan_id,
								planTime: this.planTime
							}
						});
					}
				},
				del: function(index1, index, fj) { //删除险种
					//找到plans对应的ins中的一个
					var ins;
					for(var i = 0; i < prospect.plans.length; i++) {
						if(this.plans[i].id == this.plan_id) {

							ins = this.plans[i].ins
						}
					}
					if(fj) { //附加
						this.$delete(ins[index1].addon, index)
						this.$delete(this.planList[this.plan_id][index1], index)
					} else { //主险
						ins.splice(index1, 1)
						this.$delete(this.planList[this.plan_id], index1)
					}
					count()
					this.$forceUpdate()
				},
				editIns: function(index1, item) { //编辑险种
					//找到plans对应的ins中的一个,险删掉当前的数据
					//					var ins;
					//					for(var i = 0; i < prospect.plans.length; i++) {
					//						if(this.plans[i].id == this.plan_id) {
					//							ins = this.plans[i].ins
					//						}
					//					}
					this.editIndex = index1
					//					ins.splice(index1, 1)
					//					this.$delete(this.planList[this.plan_id], index1)
					//打开ins把数据传过去
					mui.openWindow({
						id: 'prospect_addIns',
						url: 'prospect-addIns.html',
						show: animateObj.aniDetal,
						extras: {
							appl: this.appl,
							assu: this.assu,
							plan_id: this.plan_id,
							planTime: item
						}
					});
					this.$forceUpdate()
				},
				communic: function(type) {
					//通讯录
					this.toblur()
					this.Communic = type
					mui.openWindow({
						url: 'communic.html',
						id: 'communic',
						show: animateObj.aniDetal,
						extras: {
							pageid: 'prospect_product',
							tip: 1,
							flag: 'onlineIns'
						}
					})
				},
				removePlan: function(index) { //删除方案
					if(this.plans.length < 2) {
						mui.toast('只剩一个方案，不能删除')
						return false
					}
					var data = {
						modalID: 'modal-config',
						formID: 'prospect_product',
						goIns_data: index
					}
					showPopu("popup-content.html", "popup_content", 'center', data);
					event.stopPropagation()
				},
				addPlan: function() {
					for(var i = 0; i < prospect.plans.length; i++) {
						var planIns = prospect.plans[i].ins
						if(prospect.plans[i].ins.length < 1) {
							mui.toast('请先完成当前方案')
							return false;
						}
					}
					prospect.max_id++;
					var data = {
						id: prospect.max_id,
						ins: [],
						appl: {
							name: prospect.plans[0].appl.name,
							age: prospect.plans[0].appl.age,
							sex: prospect.plans[0].appl.sex,
							birthday: prospect.plans[0].appl.birthday
						},
						assu: {
							name: prospect.plans[0].assu.name,
							age: prospect.plans[0].assu.age,
							sex: prospect.plans[0].assu.sex,
							birthday: prospect.plans[0].assu.birthday
						}
					}
					prospect.plans.push(data);
					prospect.planList[prospect.max_id] = [];
					prospect.$forceUpdate();
					setTimeout(function() {
						var btn = document.getElementById('plan' + prospect.max_id);
						//监听点击事件
						btn.addEventListener("tap", function() {
							var c = document.querySelector(".plans-nav.mui-active");
							if(c) {
								c.classList.remove("mui-active");
							}
							this.classList.add("mui-active");
							var wid = this.getAttribute("data-wid");
							var id = this.getAttribute("data-id");
							var index = this.getAttribute("data-index");
							if(id) {
								var data;
								for(var i = 0; i < prospect.plans.length; i++) {
									if(prospect.plans[i].id == id) {
										data = prospect.plans[i]
										prospect.appl = prospect.plans[i].appl
										prospect.assu = prospect.plans[i].assu
									}
								}
								prospect.plan_id = id
							}
						});
						mui.trigger(btn, 'tap');
					}, 100)
				},
				pushPlan: function() {
					//点击生成计划书，弹框判断是否要添加方案
					//					var data = {
					//						modalID: 'modal-plan',
					//						formID: 'prospect_product'
					//					}
					//					showPopu("popup-content.html", "popup_content", 'center', data);
					var data = []
					var fristChild = []
					var otherChild = []
					for(var i = 0; i < prospect.plans.length; i++) {
						var id = prospect.plans[i].id
						var planIns = prospect.plans[i].ins

						for(var j = 0; j < planIns.length; j++) {
							if(!planIns[j]) continue
							var item = prospect.parseVueObj(planIns[j])
							item.main.alias = prospect.alias
							item.main.is_save = 1
							item.main.warranty_year = 105
							item.main.need_packet = 1
							item.main.check = 0
							item.main.flag = item.main.flag ? item.main.flag : 0
							data.push(item.main)
							if(i === 0 && id === 1 && j === 0) {
								fristChild.push(item.main)
							} else {
								otherChild.push(item.main)
							}
							for(var k in item.addon) {
								if(!item.addon[k]) continue
								item.addon[k].alias = prospect.alias
								item.addon[k].is_save = 1
								item.addon[k].warranty_year = 105
								item.addon[k].need_packet = 1
								item.addon[k].check = 0
								item.addon[k].flag = item.addon[k].flag ? item.addon[k].flag : 0
								data.push(item.addon[k])
								if(i === 0 && id === 1 && j === 0) {
									fristChild.push(item.addon[k])
								} else {
									otherChild.push(item.addon[k])
								}
							}
						}
						if(prospect.edit2 && prospect.edit && i === 0 && id === 1) { // 编辑接口 第一个是默认编辑
							luckyAjax({
								data: {
									server: 'Proposal.edit',
									data: JSON.stringify({
										pl_id: totalData.pl_id,
										mode: 'edit',
										safes: JSON.stringify(fristChild)
									})
								},
								success: function(res) {
									if(res.code == 1) {
										console.log('111')
									}
								}
							});
						}
					}
					if(data.length < 1 && fristChild.length < 1) {
						mui.toast('请先完成一个方案')
						return false;
					}
					if(prospect.edit) { // 编辑添加接口 新添加的险种
						if(!prospect.edit2) {
							otherChild = data
						}
						luckyAjax({
							data: {
								server: 'Proposal.edit',
								data: JSON.stringify({
									pl_id: parent_pl_id,
									mode: 'add',
									safes: JSON.stringify(otherChild)
								})
							},
							success: function(res) {
								if(res.code == 1) {
									var wobj = plus.webview.getWebviewById("member_plans_detail");
									var wobjTotal = plus.webview.getWebviewById("member_plans_total");
									var wobjAlone = plus.webview.getWebviewById("member_plans_alone");
									plus.webview.close('prospect_product')
									wobj.reload(true);
									wobjTotal.reload(true);
									plus.webview.close("member_plans_alone")
									//									wobjAlone.reload(true);

									mui.back()
								}
							}
						});
					} else {
						luckyAjax({
							data: {
								server: 'Proposal.add',
								data: JSON.stringify({
									safes: JSON.stringify(data)
								})
							},
							success: function(res) {
								if(res.code == 1) {
									var id = res.data.data[0].pl_id
									mui.openWindow({
										id: 'member_plans_detail',
										url: 'member-plans-detail.html',
										show: animateObj.aniDetal,
										extras: {
											pl_id: id //pl_id
										}
									});
									prospect.alias = '';
									prospect.max_id = 1; //id叠加
									prospect.plan_id = 1; //当前的数据
									prospect.plans = [{
										id: 1,
										ins: [],
										appl: {
											age: '',
											name: '',
											sex: true
										},
										assu: {
											age: '',
											name: '',
											sex: true
										}
									}];
									prospect.appl = {
										name: '',
										age: '',
										sex: true,
										birthday: ''
									};
									prospect.assu = {
										name: '',
										age: '',
										sex: true,
										birthday: ''
									};
									prospect.planList = { //保险计划的列表
										1: []
									};
									prospect.count = 0; //总保费
									prospect.planTime = {}; //临时保存的数据
									prospect.edit = false //是不是从编辑页面过来
									prospect.edit2 = false //是不是从编辑状态
								}
								//								plus.webview.close('prospect_product')
								plus.webview.close("member_plans_alone")
							}
						});
					}
				}
			}
		})

		mui.init();

		mui.plusReady(function() {
			//			plus.webview.close("member_plans_alone");
			statusbar();
			var winH = window.innerHeight;
			var topHeight = document.querySelector('#Js-header').offsetHeight;
			var fotHeight = document.querySelector('#Js-footer').offsetHeight;
			document.querySelector('#Js-content').style.height = winH - topHeight - fotHeight + 'px';
			//汇总过来页面会带来totalData，不然没有
			totalData = plus.webview.currentWebview().totalData
			parent_pl_id = plus.webview.currentWebview().parent_pl_id
			if(totalData && totalData != 'addPlan') {
				prospect.edit = true;
				prospect.edit2 = true;
				prospect.appl.name = totalData.applicant;
				prospect.appl.sex = totalData.appl_sex == 1 ? true : false;
				prospect.appl.age = totalData.appl_age;
				prospect.assu.name = totalData.assured;
				prospect.assu.sex = totalData.assu_sex == 1 ? true : false;
				prospect.assu.age = totalData.assu_age;
			} else if(totalData && totalData == 'addPlan') {
				prospect.edit = true;
				prospect.edit2 = false;
			}

			mui(".mui-scroll").on("tap", ".plans-nav ", function(e) {
				prospect.clickNav = true; // 点击变为true
				var c = document.querySelector(".plans-nav.mui-active");
				if(c) {
					c.classList.remove("mui-active");
				}
				this.classList.add("mui-active");
				var wid = this.getAttribute("data-wid");
				var id = this.getAttribute("data-id");
				var index = this.getAttribute("data-index");
				if(id) {
					var data;
					for(var i = 0; i < prospect.plans.length; i++) {
						if(prospect.plans[i].id == id) {
							data = prospect.plans[i]
							prospect.appl = prospect.plans[i].appl
							prospect.assu = prospect.plans[i].assu
						}
					}
					prospect.plan_id = id
				}
			});

			// 日期选择插件
			var dates = mui('.search-date');
			dates.each(function(i, d) {
				d.addEventListener('tap', function() {
					if(prospect.edit2) {
						return false;
					}
					prospect.toblur()
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var _this = this
					var picker = new mui.DtPicker(options);
					picker.show(function(rs) {
						if(i == 0) {
							prospect.appl.birthday = rs.text
						} else {
							prospect.assu.birthday = rs.text
						}
						picker.dispose();
						getAge(rs.text, i, 'picker')
					});
				}, false);
			});
			//时间
			getAge = function(birthday, i, type) {
				var age
				if(type) {
					var now = new Date()
					var year = now.getFullYear()
					var month = now.getMonth() + 1
					var day = now.getDate()
					var r = birthday.split('-').map(function(item) {
						return parseInt(item)
					})
					age = year - r[0]
					if(r[1] > month || (r[1] === month && r[2] > day)) { // 当月
						age -= 1
					}
				} else {
					age = birthday
				}

				if(i == 0 && age < 18) {
					mui.toast('投保人年龄不能小于18周岁')
					prospect.appl.birthday = ''
				} else if(i == 0 && age > 18) {
					prospect.appl.age = age
				} else if(age < 0) {
					mui.toast('被保人年龄不能小于28天')
					prospect.assu.birthday = ''
				} else {
					prospect.assu.age = age
				}
			};
			count = function() {
				//算总保费
				var count = 0;
				for(var i in prospect.planList) {
					var item = prospect.planList[i]
					for(var j = 0; j < item.length; j++) {
						for(var k in item[j]) {
							count += Number(item[j][k].period_money)
						}
					}
				}
				prospect.count = count.toFixed(2)
			};

			//通讯录回传信息
			window.addEventListener('getMemberId', function(event) {
				var memberid = event.detail.id
				luckyAjax({
					data: {
						server: 'team.getContactsInfo',
						data: JSON.stringify({
							card_no: memberid
						})
					},
					success: function(data) {
						if(data.code) {
							var info = data.data;
							if(prospect.Communic == 'appl') {
								prospect.appl.name = info.user_name;
								prospect.appl.sex = info.sex == '男' ? true : false;
								prospect.appl.birthday = info.birthday
								getAge(info.birthday, 0, 'picker')
							} else {
								prospect.assu.name = info.user_name;
								prospect.assu.sex = info.sex == '男' ? true : false;
								prospect.assu.birthday = info.birthday
								getAge(info.birthday, 1, 'picker')
							}

						}
					}
				});
			})

			//确定添加方案
			//			window.addEventListener('addPlan', function(event) {
			//				prospect.max_id++;
			//				var data = {
			//					id: prospect.max_id,
			//					ins: [],
			//					appl: {
			//						name: '',
			//						name: '',
			//						age: '',
			//						sex: true,
			//						birthday: ''
			//					},
			//					assu: {
			//						name: '',
			//						age: '',
			//						sex: true,
			//						birthday: ''
			//					}
			//				}
			//				prospect.plans.push(data);
			//				prospect.planList[prospect.max_id] = [];
			//				prospect.$forceUpdate();
			//				setTimeout(function() {
			//					var btn = document.getElementById('plan' + prospect.max_id);
			//					//监听点击事件
			//					btn.addEventListener("tap", function() {
			//						var c = document.querySelector(".plans-nav.mui-active");
			//						if(c) {
			//							c.classList.remove("mui-active");
			//						}
			//						this.classList.add("mui-active");
			//						var wid = this.getAttribute("data-wid");
			//						var id = this.getAttribute("data-id");
			//						var index = this.getAttribute("data-index");
			//						if(id) {
			//							var data;
			//							for(var i = 0; i < prospect.plans.length; i++) {
			//								if(prospect.plans[i].id == id) {
			//									data = prospect.plans[i]
			//									prospect.appl = prospect.plans[i].appl
			//									prospect.assu = prospect.plans[i].assu
			//								}
			//							}
			//							prospect.plan_id = id
			//						}
			//					});
			//					mui.trigger(btn, 'tap');
			//				}, 100)
			//			});
			//确认删除
			window.addEventListener('sure', function(event) {
				var index = event.detail.data
				//					alert(JSON.stringify(prospect.plans))
				//					alert(prospect.plans[index].id)
				//					alert(JSON.stringify(prospect.planList))
				prospect.planList[prospect.plans[index].id] = []
				prospect.plans.splice(index, 1)
				//					alert(JSON.stringify(prospect.plans))
				//					alert(JSON.stringify(prospect.planList))
				count();
				setTimeout(function() {
					var btn = document.getElementById('plan' + prospect.plans[0].id);
					//监听点击事件
					btn.addEventListener("tap", function() {
						var c = document.querySelector(".plans-nav.mui-active");
						if(c) {
							c.classList.remove("mui-active");
						}
						this.classList.add("mui-active");
						var wid = this.getAttribute("data-wid");
						var id = this.getAttribute("data-id");
						var index = this.getAttribute("data-index");
						if(id) {
							var data;
							for(var i = 0; i < prospect.plans.length; i++) {
								if(prospect.plans[i].id == id) {
									data = prospect.plans[i]
									prospect.appl = prospect.plans[i].appl
									prospect.assu = prospect.plans[i].assu
								}
							}
							prospect.plan_id = id
						}
					});
					mui.trigger(btn, 'tap');
				}, 100)
			});
			//接收险种数据
			window.addEventListener('SET_INS', function(event) {
				var id = event.detail.plan_id
				var data = event.detail.ins
				var safeid = event.detail.safeid
				var planList = event.detail.planList
				var ins;
				for(var i = 0; i < prospect.plans.length; i++) {
					if(prospect.plans[i].id == id) {
						prospect.plans[i].ins.push(data)
						ins = prospect.plans[i].ins
					}
				}

				if(prospect.editIndex != null) {
					ins.splice(prospect.editIndex, 1)
					prospect.$delete(prospect.planList[id], prospect.editIndex)
					prospect.editIndex = null

				}
				prospect.planList[id] = prospect.planList[id].concat(event.detail.planList)
				count();
				prospect.planTime = {}
				prospect.$forceUpdate()
				//				alert(JSON.stringify(prospect.plans))
				//				alert(JSON.stringify(prospect.planList))
			});
			//接收没有完成的险种数据
			window.addEventListener('SET_TIME', function(event) {
				var data = event.detail.ins
				prospect.planTime = data
				//				alert(JSON.stringify(prospect.planTime))
			});
			//不添加，即生成
			//			window.addEventListener('pushPlan', function(event) {
			//				
			//			});
		});
	</script>

</html>