<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title></title>
	<link href="css/mui.css" rel="stylesheet"/>
	<link href="css/common.css" rel="stylesheet"/>
	<link href="css/module.css" rel="stylesheet"/>
	<link href="css/product.css" rel="stylesheet"/>
	<script src="js/config.js" type="text/javascript"></script>
</head>

<body class="BL-bg-f2f">
<header id="Js-header" class="BL-bg-fff">
	<div class="BL-mod-headbar BL-mod-headbar-pos">
		<a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
		<h1 class="BL-title">快速投保</h1>
		<a class="BL-icon BL-icon-search"></a>
	</div>
</header>

<div id="Js-content" class="mui-content product" v-cloak>
	<!------------条件筛选 begin------------->
	<div id="Js-productFilter" class="product-filter">

		<!--分类栏目 begin-->
		<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted BL-segmented-control">
			<div class="mui-scroll">
				<div class="pro-control-item" :class="{'mui-active':current_instype===0}"
					 @click="current_instype=0,page=0">
					全部
				</div>
				<div class="pro-control-item" :class="{'mui-active':current_instype==='LBI0016'}"
					 @click="current_instype='LBI0016',page=0">
					意外险
				</div>
				<div class="pro-control-item" :class="{'mui-active':current_instype==='LBI0013'}"
					 @click="current_instype='LBI0013',page=0">
					医疗险
				</div>
				<div class="pro-control-item" :class="{'mui-active':current_instype==='LBI0001'}"
					 @click="current_instype='LBI0001',page=0">
					疾病保障
				</div>
				<div class="pro-control-item" :class="{'mui-active':current_instype==='LBI0008'}"
					 @click="current_instype='LBI0008',page=0">
					年金理财
				</div>
			</div>
		</div>
		<!--分类栏目 end -->

		<!--状态筛选 begin-->
		<div class="filter-state">
			<div class="BL-ub BL-ub-ac state-select">
				<div class="mui-col-sm-4 mui-col-xs-4 item"
					 :class="{'item-active-down':ordertype===2,'item-active-up':ordertype===1}"
					 @click="ordertype===1?ordertype=2:ordertype=1,companyId=''">
					<div class="BL-ub BL-ub-ac BL-ub-pc">
						<div class="text">
							价格排序
						</div>
						<div class="BL-ub BL-ub-ver">
							<a class="item-control item-control-up"></a>
							<a class="item-control item-control-down"></a>
						</div>
					</div>
				</div>
				<div class="mui-col-sm-4 mui-col-xs-4 item" :class="{'mui-active': ordertype===3}"
					 @click="ordertype=3,companyId=''">
					销量排序
				</div>
				<div class="mui-col-sm-4 mui-col-xs-4 item" :class="{'mui-active': ordertype===4&&companyId}">
					<div class="BL-ub BL-ub-ac BL-ub-pc a-link" href="quickly-filter.html" data-wid="quickly_filter"
						 :data-cid="companyId" @click="ordertype=5">
						<div class="text">
							筛选
						</div>
						<div class="BL-ub BL-ub-ver">
							<div class="item-control item-control-filter"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--状态筛选 end -->

	</div>
	<!------------条件筛选 end  ------------->

	<!------------产品列表 begin------------->
	<div id="Js-productList" class="product-list">
		<div class="mui-content mui-scroll-wrapper BL-bg-f2f">
			<div class="mui-scroll">
				<!--活动中，数据列表-->
				<ul class="mui-table-view product-list-cell">
					<li class="cItem" v-for="(item,index) in listdata" :key="index" v-if="listdata">
						<div class="BL-ub BL-ub-f1 pro-content" :class="{'pro-icon-new':item.product_sign==='LBF0002','pro-icon-hot':item.product_sign==='LBF0003'}">
							<div class="img a-link" :data-id="item.id" data-wid="product_detail" href="product-detail.html">
								<img :src="item.image_url" @error="item.image_url='images/pic/p6.jpg'"/>
							</div>
							<div class="context BL-ub BL-ub-ver BL-ub-f1">
								<h1 class="tit mui-ellipsis a-link" :data-id="item.id" data-wid="product_detail" href="product-detail.html">{{item.product_name}}</h1>
								<div class="text" v-html="item.shining_point"></div>
								<div class="fd">
									<div class="BL-ub BL-ub-ac BL-ub-pj">
										<div class="fd-price">
											{{item.price | priceFilter}}元起
										</div>
										<a data-wid="hd_insurance-index" href="hd_ins/insurance-index.html" class="fd-btn a-link" v-show="item.company_id===19">
											快速投保
										</a>
										<a data-wid="pa_insurance-index" href="paehis/pa-healthinfo.html" class="fd-btn a-link" v-show="item.company_id===8&&item.online_insure">
											快速投保
										</a>
										<a data-wid="gh_insurance-index" href="gh_ins/insurance-index.html" class="fd-btn a-link" v-show="item.company_id===2&&item.online_insure">
										<a data-wid="zs_insurance-index" href="zs_ins/insurance-index.html" class="fd-btn a-link" v-show="item.company_id===85&&item.online_insure">
											快速投保
										</a>
										<a @tap="xtIns()" class="fd-btn" v-show="item.company_id===12&&item.online_insure">
											快速投保
										</a>
									</div>
								</div>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!------------产品列表 end  ------------->
</div>

</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var self;
    var user_id;
    var product = new Vue({
        el: '#Js-content',
        data: {
            keywords: '',
            current_instype: 0, //险种类别id
            ordertype: '', //1按价格上升 2按价格下降 3按销量 4保险公司
            page: 0,
            companyId: '',
            listdata: [],
            instype: []
        },
        //过滤器
        filters: {
            //保障期间
            priceFilter: function (value) {
                return parseInt(value)
            }
        },
        watch: {
            ordertype: {
                handler: function (val) {
                    if (val && val !== 4) {
                        this.page = 0;
                        mui('#Js-productList .mui-scroll-wrapper')[0].setAttribute('data-scroll', '');
                        loaddata(1,true);
                    }
                }
            },
            current_instype: {
                handler: function () {
                    this.page = 0;
                    mui('#Js-productList .mui-scroll-wrapper')[0].setAttribute('data-scroll', '');
                    loaddata(1,true);
                }
            }
        },
        methods: {
			xtIns: function(){
				mui.openWindow({
					id: 'XT_ins',
					url: 'XT_ins.html',
					show: animateObj.aniDetal,
					extras:{
						video_url:  config.domain + '/xtins/XT_ins.html?user_id='+user_id
					}
				});
				}
			}
    });

    (function ($) {
        //阻尼系数
        var deceleration = mui.os.ios ? 0.003 : 0.0009;
        $('#Js-productList .mui-scroll-wrapper').scroll({
            bounce: false,
            indicators: false, //是否显示滚动条
            deceleration: deceleration
        });
        $.plusReady(function () {
            statusbar();
            var winH = window.innerHeight;
            var titHeight = document.querySelector('#Js-header').offsetHeight;
            var divHeight = document.querySelector('#Js-productFilter').offsetHeight;
            document.querySelector('#Js-productList').style.height = winH - titHeight - divHeight + 'px';
            user_id = JSON.parse(plus.storage.getItem("userinfo")).id;

            //循环初始化所有下拉刷新，上拉加载。
            $('#Js-productList .mui-scroll').pullToRefresh({
                up: { // 上拉加载更多
                    auto: true, // 自动上拉一次
                    callback: function () {
                        self = this
                        loaddata(1);
                    }
                },
                down:{
                    callback: function() {
                        self = this
                        product.page = 0;
                        loaddata(2,true);
                    }
                }
            });
        });

    }(mui));
    //加载险种列表
    var loaddata = function (type,e) {
        product.page++;
//      console.log(product.page)
        var basedata = {
            page: product.page,
            row: 10,
            is_primary: 1,
			online: 1,
			state: 1
        };
        if (product.current_instype) {
            basedata.ins_type = product.current_instype
        }
        if (product.companyId) {
            basedata.company_id = product.companyId
        }
        if (product.ordertype === 1) {
            basedata.order = 'price asc';
        } else if (product.ordertype === 2) {
            basedata.order = 'price desc';
        } else if (product.ordertype === 3) {
            basedata.order = 'sale_num desc';
        } else if (product.ordertype === 4 && product.companyId) {
            basedata.company_id = product.companyId;
        }
        //plus.nativeUI.showWaiting();
        luckyAjax({
        	closeWaiting:  type == 2 ? true:false, 
            data: {
                server: 'lifeProduct.getProductList',
                data: JSON.stringify(basedata)
            },
            success: function (data) {
                if (data.code) {
                    if (product.page >= data.data.totalPage) {
                        if (type === 1) {
                            self.endPullUpToRefresh(true);
                        } else if (type === 2) {
                        	mui.toast('更新完成', {duration: 'short', type: 'div'})
                            self.endPullDownToRefresh(true);
                        }
                    } else {
                        if (type === 1) {
                            self.endPullUpToRefresh();
                        } else if (type === 2) {
                        	mui.toast('更新完成', {duration: 'short', type: 'div'})
                            self.endPullDownToRefresh();
                        }
                    }
                    if (e) {
                        product.listdata = data.data.list;
                    } else {
                        var list = data.data.list;
                        mui.each(list, function (index, item) {
                            product.listdata.push(item);
                        });
                    }
                } else {
                    mui.toast(data.msg, {duration: 'short', type: 'div'});
                    return false;
                }
            }
        });
    };

    //主列表点击事件
    var extras = null;
    var detailPage = null;
    mui('body').on('tap', '.a-link', function () {
        var href = this.getAttribute('href');
        var id = this.getAttribute("data-wid");
        var pid = this.getAttribute('data-id');
        var cid = this.getAttribute('data-cid');

        //非plus环境，直接走href跳转
        if (!mui.os.plus) {
            location.href = href;
            return;
        }

        if (href && ~href.indexOf('.html')) {
            //判断窗口是否存在
            if (!detailPage) {
                detailPage = plus.webview.getWebviewById(id);
            }
            if (pid) {
                extras = {product_id: pid};
            }
            if (cid) {
                extras = {company_id: cid};
            }
            //打开新窗口
            mui.openWindow({
                url: href,
                id: id,
                show: animateObj.aniDetal,
                extras: extras
            });
        }
    });

    //接收筛选的公司id
    window.addEventListener('companyId', function (e) {
        product.companyId = e.detail.id;
        product.ordertype = 4;
        product.page = 0;
        loaddata(1,true);
    });
</script>

</html>