<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/member.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
</head>
<body class="BL-bg-f2f">
<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
        <h1 class="BL-title">教育金规划</h1>
    </div>
</header>
<div id="Js-content" class="mui-content BL-rel" style="background: rgba(59,156,245,0.8)" v-cloak>
    <div class="mui-scroll-wrapper">
        <div class="mui-scroll">
            <div class="member-card">
                <div class="member-card-header BL-bg-ebf5fe">
                    <p class="BL-bold BL-ftz-48 BL-col-333">总需教育金：<span class="BL-col-3b9cf5">￥{{ allTotal }}</span></p>
                </div>
                <div class="member-card-content">
                    <div class="mui-row">
                        <div class="mui-col-xs-4 card-dis">被保人年龄</div>
                        <div class="mui-col-xs-8 card-input">
                            <input type="number" placeholder="输入的年龄不超过18岁" v-model.lazy="age" @change="calculate">
                        </div>
                    </div>
                    <div class="mui-row">
                        <div class="mui-col-xs-4 card-dis">投资年限</div>
                        <div class="mui-col-xs-8 card-input" id="invest_years">
                            {{ invest_years_text }}
                            <div class="card-down-icon"></div>
                        </div>
                    </div>
                    <div class="mui-row">
                        <div class="mui-col-xs-4 card-dis">回报年限</div>
                        <div class="mui-col-xs-8 card-total"> {{ dataLine }}</div>
                    </div>
                    <div class="mui-row">
                        <div class="mui-col-xs-4 card-dis">收益率假设</div>
                        <div class="mui-col-xs-8 card-input" id="select_yields">
                            {{ select_yields_text }}
                            <div class="card-down-icon"></div>
                        </div>
                    </div>
                    <div class="mui-row">
                        <div class="mui-col-xs-4 card-dis">每年应存</div>
                        <div class="mui-col-xs-8 card-total BL-col-ff8201 BL-bold"> ￥ {{ realStorage }} </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer id="Js-footer" class="BL-footer BL-bg-fff">
        <a href="product.html" data-wid="product" data-tid="LBI0008" class="BL-ub BL-ub-ac BL-ub-pc BL-col-3b9cf5 BL-ftz-52" style="height: 100%; font-size: 1.78125rem">
            下一步
        </a>
    </footer>
</div>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.picker.js" type="text/javascript"></script>
<script src="js/mui.poppicker.js" type="text/javascript"></script>
<script src="js/mui.dtpicker.js" type="text/javascript"></script>
<script src="js/vue.min.js"></script>
<script type="text/javascript">
    mui.init();
    var educate = new Vue({
        el: '#Js-content',
        data: {
            allTotal: "", // 总教育金
            age: "", // 年龄
            dataLine: "", // 回报年限
            realStorage: "0.00", // 应存金额
            invest_years:  [
                {"text":"1","value":"1"},
                {"text":"3","value":"3"},
                {"text":"5","value":"5"},
                {"text":"8","value":"8"},
                {"text":"10","value":"10"},
                {"text":"15","value":"15"},
                {"text":"20","value":"20"}
            ],
            invest_years_value: "",
            invest_years_text: "请选择",
            select_yields: [
                {"text":"3%","value":"3"},
                {"text":"4%","value":"4"},
                {"text":"5%","value":"5"},
                {"text":"6%","value":"6"},
                {"text":"7%","value":"7"},
                {"text":"8%","value":"8"},
                {"text":"9%","value":"9"},
                {"text":"10%","value":"10"}
            ],
            select_yields_value: "",
            select_yields_text: "请选择",
        },
        watch: {
            // 投资年限
            invest_years_value: function (val) {
                if (!this.checkAge()) {
                    return false
                }
                this.calculate()
            },
            // 收益率假设
            select_yields_value: function(val){
                if (!this.checkAge()) {
                    return false
                }
                this.calculate()
            }
        },
        methods: {
            checkAge: function () {
//                var age = parseInt(this.age);
                var reg = new RegExp("^[0-9]*$");
                if (this.age == "") {
                    mui.toast('请输入被保人年龄', {duration: 'short', type: 'div'});
                    return false;
                } else if(!reg.test(this.age)){
                    mui.toast('年龄输入错误，请重新输入', {duration: 'short', type: 'div'});
                    return false;
                }else{
                    if(this.age >= 18){
                        mui.toast('输入年龄不能大于18岁', {duration: 'short', type: 'div'});
                        return false;
                    } else {
                        return true
                    }
                }
            },
            calculate: function () {
                if (!this.checkAge()) {
                    return false
                }
                this.dataLine = ((18 - this.age) > 0 ? (18 - this.age) : "")
                if (this.invest_years_value != "" && this.select_yields_value != "") {
                    var rate = parseInt(this.select_yields_value) /100;
                    var nper = parseInt(this.dataLine) - this.invest_years_value
                    this.realStorage = this.RealStorage(this.allTotal, nper, rate,this.invest_years_value)
                } else {
                    this.realStorage = "0.00"
                }

            },
            //每年应存金额
            RealStorage: function (balance, nper, rate, year) {
                var sum = 0;
                var total = 0; // 保证收益账户 / Math.pow((1+rate),(回报年限 - 准备年数))
                for(var k=0;k<=year;k++){
                    if(year - k > 0 ){
                        sum += Math.pow(1 + rate, year - k);
                    }
                }
                var real =  balance / Math.pow(1 + rate, nper);
                real = (real / sum).toFixed(2);
                return real;

            }
        }
    });
    mui('.mui-scroll-wrapper').scroll({
        scrollY: true, //是否竖向滚动
        scrollX: false, //是否横向滚动
        startX: 0, //初始化时滚动至x
        startY: 0, //初始化时滚动至y
        indicators: false, //是否显示滚动条
        deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
        bounce: true //是否启用回弹
    });

    mui.plusReady(function() {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;
        var fotHeight = document.querySelector('#Js-footer').offsetHeight;
        document.querySelector('#Js-content').style.height = winH - titHeight - fotHeight  + 'px';

        educate.allTotal = plus.webview.currentWebview().total;
        //收益率假设选择
        var select_yields = new mui.PopPicker();
        select_yields.setData(educate.select_yields);
        document.querySelector('#select_yields').addEventListener('tap', function () {
            document.activeElement.blur();
            select_yields.show(function (items) {
                educate.select_yields_value = items[0].value;
                educate.select_yields_text = items[0].text;
            })
        })

        //投资年限选择
        var invest_years = new mui.PopPicker();
        invest_years.setData(educate.invest_years);
        document.querySelector('#invest_years').addEventListener('tap', function () {
            document.activeElement.blur();
            invest_years.show(function (items) {
                educate.invest_years_value = items[0].value;
                educate.invest_years_text = items[0].text;
            })
        })

        // 下一步
        //跳转养老年金
        mui('#Js-footer').on('tap', 'a', function(){
            document.activeElement.blur();
            var extras = null;
            var href = this.getAttribute('href');
            var id = this.getAttribute("data-wid");
            var tid = this.getAttribute("data-tid");

            if (tid) {
                extras = {instype_id: tid};
            }
            setTimeout(function(){
                //非plus环境，直接走href跳转
                if(!mui.os.plus) {
                    location.href = href;
                    return;
                };

                if(href && ~href.indexOf('.html')) {
                    mui.openWindow({
                        url: href,
                        id: id,
                        show: animateObj.aniDetal,
                        extras: extras,
                        waiting: {
                            autoShow: false
                        }
                    });
                }
            },500)
        });
    });
</script>
</html>