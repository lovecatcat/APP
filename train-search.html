<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>云课堂搜索</title>
    <link href="css/mui.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/module.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <link href="css/news.css" rel="stylesheet" />
    <script src="js/config.js" type="text/javascript"></script>
    <style>
        .hot-search{
            display: block;
            float: left;
            border: 1px solid #999999;
            padding: 0rem .8rem;
            font-size: 1.4375rem;
            border-radius: .5rem;
            margin-right: .8rem;
            margin-bottom: 1rem;
            background: #f7f7f7;
            height: 3rem;
            line-height: 3rem;
        }
    </style>
</head>
<body class="BL-bg-f2f">
<div id="Js-main">
    <header id="Js-header" class="BL-bg-fff">
        <div class="BL-mod-headbar">
            <div class="BL-ub BL-ub-ac headbar-search">
                <a class="mui-action-back mui-icon-left-nav BL-icon BL-icon-left"></a>
                <div class="search search-pro BL-ub BL-ub-ac BL-ub-f1">
                    <input type="search" placeholder="请输入关键字" class="BL-ub BL-ub-f1" v-model="keyword" @keyup.enter="query" />
                    <div class="button" @click="query">
                        <span class="BL-bimg-contain">&nbsp;</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY" v-cloak>
        <div v-show="list">
            <div v-show="list&&list.length>0" class="mui-content mui-scroll-wrapper">
                <div class="mui-scroll">
                    <ul class="mui-table-view train-list-cell">
                        <li class="nItem BL-pad-tb-1_5" v-for="(item,index) in list" @tap="OpenLessonDetail(item.media_type,item.id)">
                            <a class="BL-ub BL-ub-f1" :data-type="item.media_type" :data-id="item.id">
                                <div class="list_img">
                                    <img :src="item.img | setImg"/>
                                </div>
                                <div class="context BL-ub BL-ub-ver BL-ub-f1">
                                    <h1 class="tit">
                                        <span class="tit-badg" v-if="item.media_type == 1" :class="{'tit-badg-tv': item.media_type == 1}">视频</span>
                                        <span class="tit-badg" v-if="item.media_type == 2" :class="{'tit-badg-ad': item.media_type == 2}">音频</span>
                                        {{ item.title }}
                                    </h1>
                                    <div class="remarks BL-ub BL-ub-ac">
                                        <i class="ico-remarks" :class="{'ico-picture': item.media_type == 0,'ico-tv': item.media_type == 1,'ico-ad': item.media_type == 2}"></i>
                                        <span>{{ item.play_count }}</span>
                                        <span>{{ item.date }}</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div v-show="list&&list.length==0" class="BL-col-999 BL-txt-c BL-pad-tb-1 BL-ftz-46">搜索不到相关数据</div>
        </div>
        <div v-show="!list && hot_search.length>0" class="BL-bg-fff">
            <div class="form-notice BL-col-999">热门搜索</div>
            <div class="BL-pad-lr-1_5 BL-pad-tb-1" style="overflow:hidden;">
                <span class="hot-search" v-for="item in hot_search" @click="select(item)">{{ item }}</span>
            </div>
        </div>
        <div v-show="!list && storage_search.length>0" class="BL-bg-fff BL-mar-t-07">
            <div class="form-notice BL-col-999">搜索历史</div>
            <div class="BL-pad-lr-1_5 BL-pad-tb-1_5">
                <ul class="BL-ftz-48">
                    <li class="BL-mar-b-1 BL-ellipsis" v-for="item in storage_search" @click="select(item)">{{ item }}</span> </li>
                </ul>
                <div class="BL-mar-t-07 BL-txt-c">
                    <span class="BL-col-999 BL-ftz-46" @click="clear">清除搜索历史</span>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="js/mui.min.js" type="text/javascript"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var train = new Vue({
        el: '#Js-main',
        data: {
            keyword: "",    // 关键字
            cate_id: "",  // 类别
            page: 0,    // 当前页
            list: null,   // 搜索列表
            hot_search: [],    // 热门搜索
            storage_search: []   // 搜索历史
        },
        //过滤器
        filters: {
            setTime: function (timestamp) {
                var time = new Date(timestamp*1000)   // 时间戳转成日期
                var timeFormat = time.Format('yyyy-MM-dd')
                return timeFormat
            },
            setImg: function(val) {
                return config.domain + val
            }
        },
        methods: {
            toblur: function () {
                document.activeElement.blur();
            },
            query: function () {
                this.toblur()
                this.page = 0
                if (!this.keyword) {
                    mui.toast('关键词不能为空', {duration: 'short', type: 'div'});
                    return
                }
                // 本地存储搜索关键字
                this.storage_search = this.unique(this.storage_search, this.keyword)
                plus.storage.setItem('train_search_keyword', JSON.stringify(this.storage_search))
                // 搜索ajax
                loadSearchList()
            },
            select: function (val) {
                this.keyword = val
                this.query()
            },
            //去重返回
            unique: function (arr, value) {
                if (arr.length == 0) {
                    arr.push(value);
                } else {
                    for (var i = 0, len = arr.length; i < len; i++) {
                        if (arr.indexOf(value) == -1) {//若新数组中未包含该项则将其存入新数组
                            arr.push(value);
                        }
                    }
                }

                if (arr.length > 5) {
                    return arr.slice(-5)
                } else {
                    return arr
                }

            },
            //清除
            clear: function () {
                plus.storage.removeItem('train_search_keyword')
                train.storage_search = []
            },
            // 打开课程详情页面
            OpenLessonDetail: function (type, wid) {
                var href = '', id = '';
                // 课程详情ID保存在本地
                plus.storage.setItem('LessonInfo', JSON.stringify({id: wid}));

                if (type == 0) {
                    href = 'train-article.html'
                    id = 'train_article'
                } else if (type == 1) {
                    href = 'train-video.html'
                    id = 'train_video'
                } else if (type == 2) {
                    href = 'train-audio.html'
                    id = 'train_audio'
                }
                //打开新窗口
                mui.openWindow({
                    url: href,
                    id: id,
                    show: animateObj.aniDetal
                });
            }
        }
    });
    (function($){
        //阻尼系数
        var deceleration = mui.os.ios ? 0.003 : 0.0009;
        $('#Js-content .mui-scroll-wrapper').scroll({
            bounce: true,
            indicators: false, //是否显示滚动条
            deceleration: deceleration
        });

        $.plusReady(function() {
            // 设置内容区域
            statusbar();
            var winH = window.innerHeight;
            var titHeight = document.querySelector('#Js-header').offsetHeight;
            document.querySelector('#Js-content').style.height = (winH - titHeight) +'px';

            $('#Js-content .mui-scroll').pullToRefresh({
                up: { // 上拉加载更多
                    auto: false, // 自动上拉一次
                    contentrefresh: '正在加载...',
                    contentnomore:'没有更多数据了',// 可选，请求完毕若没有更多数据时显示的提醒内容；
                    callback: function() {
                        loadSearchList(1)
                    }
                }
            });

            train.cate_id = plus.webview.currentWebview().cate_id;
            // 获取热门搜索关键字
            luckyAjax({
                data: {
                    server: 'videoLearn.getHotSearch'
                },
                success:function(res){
                    if (res.code == 1) {
                        train.hot_search = res.data.list
                    } else {
                        train.hot_search = []
                    }
                }
            });
            // 获取本地存储的搜索历史关键字（取前五个）
            train.storage_search = JSON.parse(plus.storage.getItem('train_search_keyword'))
            if (!train.storage_search) {
                train.storage_search = []
            }
        });
    }(mui));
    //加载品牌列表
    var loadSearchList = function (type,e) {
        train.page++
        luckyAjax({
            data: {
                server: 'videoLearn.searchList',
                data: JSON.stringify({
                    cate_id: train.cate_id,
                    keyword: train.keyword,
                    page: train.page,
                    row: 10
                })
            },
            success:function(res){
                if (res.code == 1) {
                    train.$nextTick(function () {
                        if (train.page >= res.data.page) {
                            train.list = res.data.list
                            mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(true)
                        } else {
                            train.list = train.list.concat(res.data.list)
                            mui('#Js-content .mui-scroll').pullToRefresh().endPullUpToRefresh(false)
                        }
                    })
                } else {
                    mui.toast(res.msg, {duration: 'short', type: 'div'});
                }
            }
        });
    };
</script>
</html>
