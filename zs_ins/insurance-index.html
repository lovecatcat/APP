<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body class="BL-bg-f2f">

<header id="Js-header" class="BL-bg-fff">
    <div class="BL-mod-headbar BL-mod-headbar-pos">
        <a class="mui-icon-left-nav BL-icon BL-icon-left" id="backto"></a>
        <h1 class="BL-title">招商仁和在线投保</h1>
        <div class="control">
            <a type="button" class="BL-col-3b9cf5" id="resetData">重置</a>
        </div>
    </div>
</header>
<div id="Js-content" class="mui-content BL-rel BL-overFlow-autoY">
    <form class="mui-input-group BL-mar-t-1">
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(1)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':applicant}">投保人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(2)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':assured}">被保人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(3)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':beneficiary}">受益人信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(4)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':safegoods}">险种信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(5)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':healthinfo}">健康告知信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(6)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':bank}">付款信息</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(7)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':upload}">上传证件</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
        <div class="mui-input-row mui-checkbox ins-checkbox-right" @tap="showpop(8)">
            <label class="ins-font-md" :class="{'BL-col-3b9cf5':agent}">代理人告知</label>
            <div class="form-list-icon">
                <div class="mui-icon mui-icon-arrowright"></div>
            </div>
        </div>
    </form>
    <div class="BL-mar-t-3 BL-pad-lr-1_5">
        <a type="button" id="ins-save" class="form-btn blue">核保</a>
    </div>
    <br><br>
    <div class="BL-mar-t-3 BL-pad-lr-1_5" style="display: none;">
        <a type="button" id="temppop" class="form-btn blue">签名</a>
    </div>
</div>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="../js/IDValidator.min.js"></script>
<script src="method.js"></script>
<!--<script type="text/babel">-->
<script type="text/javascript">
    mui.init();
    mui.plusReady(function () {
        statusbar();
        var winH = window.innerHeight;
        var titHeight = document.querySelector('#Js-header').offsetHeight;
        document.querySelector('#Js-content').style.height = winH - titHeight + 'px';
        var itemName = ['zhaos_applicant','zhaos_assured','zhaos_beneficiary','zhaos_safegoods','zhaos_healthinfo','zhaos_bank','zhaos_upload','zhaos_agent','zhaos_ids','userinfo'];
        var subpages = ["insurance-applicant", "insurance-assured", "insurance-beneficiary", "insurance-safegoods", "insurance-healthinfo", "insurance-bank", "insurance-upload","insurance-agent"];

        var index = new Vue({
            el: '#Js-content',
            data: function() {
                return {
                    loading: false,
                    pid: '',
                    userinfo: '',
                    init: {},
                    ids: '',
                    applicant: '',
                    assured: '',
                    beneficiary: '',
                    safegoods: '',
                    healthinfo: '',
                    bank: '',
                    sign: '',
                    upload: '',
                    agent: ''
                }
            },
            created:function(){
                console.log('index-created')
                //编辑保单
                var openerId = plus.webview.currentWebview().opener().id
//                if (openerId !== 'quickly' && openerId !== 'member_life_order') {
//                    console.log('begin-clear')
//                    this.clearItem()
//                }
                var pid = plus.webview.currentWebview().policy_id;
                console.log(pid)
                if (pid) {
                    document.getElementById('resetData').style.display = 'none'
                    this.pid = pid
                    plus.storage.setItem('zhaos_ids', JSON.stringify({policy_id: pid}));
                    checkStatus(pid)
                } else {
                    if (plus.storage.getItem('zhaos_ids')) {
                        this.clearItem()
                    }
                    this.getReadyItem();
                }
                //
            },
            methods:{
                //清除localstorage
                clearItem: function (back, timeout) {
                    for (var i = 0; i < 9; i++) {
                        plus.storage.removeItem(itemName[i])
                    }
                    this.ids = ''
                    this.applicant = ''
                    this.assured = ''
                    this.beneficiary = ''
                    this.safegoods = ''
                    this.healthinfo = ''
                    this.bank = ''
                    this.sign = ''
                    this.upload = ''
                    this.agent = ''
                    if (back && timeout) {
                        setTimeout(function () {
                            mui.back();
                        }, 1000)
                    } else if (back && !timeout) {
                        mui.back();
                    }
                },
                getReadyItem: function () {
                    var dataName = ['applicant', 'assured', 'beneficiary', 'safegoods', 'healthinfo', 'bank', 'upload','agent', 'ids', 'userinfo'];
                    for (var i = 0; i < itemName.length; i++) {
                        this.getItem(itemName[i], dataName[i]);
                    }
                    this.$forceUpdate();
                },
                //获取存储数据
                getItem: function (item, data) {
                    console.log('getItem:' + item + '===' + data)
                    this[data] = plus.storage.getItem(item) ? JSON.parse(plus.storage.getItem(item)) : ''
                    this.$forceUpdate();
                },
                //编辑保单数据赋值
                getWarranty: function (pid) {
                    console.log('赋值')
                    const vm = this
                    var appl_data = {}
                    var assu_data = {}
                    var bene_data = null
                    var safe_data = []
                    var health_data = []
                    var bank_data = {}
                    var upload_data = {}
                    var agent_data = {}
                    luckyAjax({
                        data: {
                            data: JSON.stringify({'policy_id': pid}),
                            server: 'PolicyIns.edit'
                        },
                        success: function (res) {
                            if (res.code) {
                                var da = res.data
                                //投保人
                                appl_data.holder_name = da.insData.holder_name
                                appl_data.holder_ID_type = da.insData.holder_ID_type //证件类型
                                appl_data.holder_ID_type_name = da.insData.holder_ID_type_text //证件类型名
                                appl_data.holder_ID_no = da.insData.holder_ID_no //证件号码
                                appl_data.holder_birthday = da.insData.holder_birthday //出生日期
                                appl_data.holder_ID_expire_end = da.insData.holder_ID_expire_end //证件有效期
                                appl_data.holder_gender = da.insData.holder_gender//性别  1男  2女
                                appl_data.holder_mobile = da.insData.holder_mobile//手机号
                                appl_data.holder_email = da.insData.holder_email//邮箱
                                appl_data.holder_height = parseInt(da.insData.holder_height)//身高
                                appl_data.holder_weight = da.insData.holder_weight//体重
                                appl_data.holder_nation = da.insData.holder_nation//国籍
                                appl_data.holder_nation_name = da.insData.holder_nation_text//国籍
                                appl_data.holder_company = da.insData.holder_company //工作单位
                                appl_data.holder_salary_from = da.insData.holder_salary_from//收入来源
                                appl_data.holder_salary_from_name = da.insData.holder_salary_from_text//收入来源名
                                appl_data.holder_salary_avg = parseInt(da.insData.holder_salary_avg)//年收入

                                appl_data.holder_home_province = da.insData.holder_home_province//现在住址【省】
                                appl_data.holder_home_province_name = da.insData.holder_home_province_text//现在住址【省】
                                appl_data.holder_home_city = da.insData.holder_home_city//现在住址【市】
                                appl_data.holder_home_city_name = da.insData.holder_home_city_text//现在住址【市】
                                appl_data.holder_home_district = da.insData.holder_home_district//现在住址【区】
                                appl_data.holder_home_district_name = da.insData.holder_home_district_text//现在住址【区】名称
                                appl_data.holder_home_zip = da.insData.holder_home_zip//现在住址【邮编】
                                appl_data.holder_home_address = da.insData.holder_home_address //现在住址【地址详情】
                                appl_data.holder_home_ssq_name = da.insData.holder_home_province_text + ' ' + da.insData.holder_home_city_text + ' ' + da.insData.holder_home_district_text //现在住址【地址详情】

                                appl_data.mail_addr_type =  da.insData.extend_items.mail_addr_type//（通讯地址）是否同现在住址

                                appl_data.holder_contact_province = da.insData.holder_contact_province//通讯地址【省】
                                appl_data.holder_contact_province_name = da.insData.holder_contact_province_text//通讯地址【省】
                                appl_data.holder_contact_city = da.insData.holder_contact_city//通讯地址【市】
                                appl_data.holder_contact_city_name = da.insData.holder_contact_city_text//通讯地址【市】
                                appl_data.holder_contact_district = da.insData.holder_contact_district//通讯地址【区】
                                appl_data.holder_contact_district_name = da.insData.holder_contact_district_text//通讯地址【区】名称
                                appl_data.holder_contact_zip = da.insData.holder_contact_zip//通讯地址【邮编】
                                appl_data.holder_contact_address = da.insData.holder_contact_address //通讯地址【地址详情】
                                appl_data.holder_contact_ssq_name = da.insData.holder_contact_province_text + ' ' + da.insData.holder_contact_city_text + ' ' + da.insData.holder_contact_district_text //通讯地址【地址详情】

                                appl_data.holder_has_SSID = da.insData.holder_has_SSID === has_social_security ? true : false//是否有社保
                                appl_data.holder_marriage = da.insData.holder_marriage//婚姻状况
                                appl_data.holder_job_code = da.insData.holder_job_code//职业
                                appl_data.temp_holder_job_code = da.insData.holder_job_code_code//职业代码
                                appl_data.holder_job_name = da.insData.holder_job_code_text//职业名称
                                appl_data.holder_job_cate = da.insData.holder_job_category.extend.life_insurance//职业分类
                                appl_data.holder_isTaxResidents = TAXTYPE //税收标识
                                appl_data.resident_type = da.insData.extend_items.resident_type //居民类型
                                console.log(JSON.stringify(appl_data))
                                //被保人
                                assu_data.rel_holder_insured = da.insured.rel_holder_insured
                                assu_data.addr_type = da.insData.extend_items.addr_type
                                if (da.insured.rel_holder_insured === ISASSURED) {//被保人为本人
                                    RSChanged(assu_data, appl_data)
                                } else {
                                    assu_data.insured_name = da.insured.insured_name //姓名
                                    assu_data.insured_ID_type = da.insured.insured_ID_type //证件类型
                                    assu_data.insured_ID_type_name = typename[da.insured.insured_ID_type] //证件类型名
                                    assu_data.insured_ID_no = da.insured.insured_ID_no //证件号码
                                    assu_data.insured_birthday = da.insured.insured_birthday //出生日期
                                    assu_data.insured_ID_expire_end = da.insured.insured_ID_expire_end //证件有效期
                                    assu_data.insured_gender = da.insured.insured_gender //性别  1男  2女
                                    assu_data.insured_mobile = da.insured.insured_mobile//手机号
                                    assu_data.insured_email = da.insured.insured_email//邮箱
                                    assu_data.insured_height = parseInt(da.insured.insured_height)//身高
                                    assu_data.insured_weight = da.insured.insured_weight//体重
                                    assu_data.insured_nation = da.insured.insured_nation//国籍
                                    assu_data.insured_nation_name = da.insured.insured_nation_text//国籍
                                    assu_data.insured_company = da.insured.insured_company //工作单位
                                    assu_data.insured_salary_from = da.insured.insured_salary_from//收入来源
                                    assu_data.insured_salary_from_name = da.insured.insured_salary_from_text//收入来源名
                                    assu_data.insured_salary_avg = parseInt(da.insured.insured_salary_avg)//年收入

                                    assu_data.insured_home_province = da.insured.insured_home_province//现在住址【省】
                                    assu_data.insured_home_province_name = da.insured.insured_home_province_text//现在住址【省】
                                    assu_data.insured_home_city = da.insured.insured_home_city//现在住址【市】
                                    assu_data.insured_home_city_name = da.insured.insured_home_city_text//现在住址【市】
                                    assu_data.insured_home_district = da.insured.insured_home_district//现在住址【区】
                                    assu_data.insured_home_district_name = da.insured.insured_home_district_text//现在住址【区】名称
                                    assu_data.insured_home_address = da.insured.insured_home_address //现在住址【地址详情】
                                    assu_data.insured_home_zip = da.insured.insured_home_zip//现在住址【邮编】
                                    assu_data.insured_home_ssq_name = da.insured.insured_home_province_text + ' ' + da.insured.insured_home_city_text + ' ' + da.insured.insured_home_district_text//现在住址【邮编】

                                    assu_data.insured_contact_province = da.insured.insured_contact_province//通讯地址【省】
                                    assu_data.insured_contact_province_name = da.insured.insured_contact_province_text//通讯地址【省】
                                    assu_data.insured_contact_city = da.insured.insured_contact_city//通讯地址【市】
                                    assu_data.insured_contact_city_name = da.insured.insured_contact_city_text//通讯地址【市】
                                    assu_data.insured_contact_district = da.insured.insured_contact_district//通讯地址【区】
                                    assu_data.insured_contact_district_name = da.insured.insured_contact_district_text//通讯地址【区】名称
                                    assu_data.insured_contact_address = da.insured.insured_contact_address //通讯地址【地址详情】
                                    assu_data.insured_contact_zip = da.insured.insured_contact_zip//通讯地址【邮编】
                                    assu_data.insured_contact_ssq_name = da.insured.insured_contact_province_text + ' ' + da.insured.insured_contact_city_text + ' ' + da.insured.insured_contact_district_text//通讯地址【邮编】


                                    assu_data.insured_has_SSID = da.insured.has_insured_SSID === has_social_security ? true : false//是否有社保
                                    assu_data.insured_marriage = da.insured.insured_marriage//婚姻状况
                                    assu_data.insured_job_code = da.insured.insured_job_code//职业
                                    assu_data.temp_insured_job_code = da.insured.insured_job_code_code//职业代码
                                    assu_data.insured_job_name = da.insured.insured_job_code_text//职业名称
                                    assu_data.insured_job_cate = da.insured.insured_job_category.extend.life_insurance//职业分类
                                    assu_data.insured_isTaxResidents = TAXTYPE//税收标识
                                }
                                console.log(JSON.stringify(assu_data))
                                //受益人
                                if (da.insData.is_legal_benefic) {
                                    bene_data = 1
                                } else {
                                    if (!da.beneficList.length) {
                                        bene_data = ''
                                        plus.storage.removeItem('zhaos_beneficiary')
                                    } else {
                                        var bitem = {}
                                        bene_data = []
                                        for(var b in da.beneficList){
                                            console.log(b)
                                            bitem = da.beneficList[b]
                                            bene_data.push({
                                                beneficiary_is_insured: bitem.beneficiary_is_insured,//与被保人关系
                                                fullname: bitem.fullname,//姓名
                                                ID_type: bitem.ID_type,//证件类型
                                                ID_no: bitem.ID_no,//证件号码
                                                ID_expire_end: bitem.ID_expire_end,//证件有效期
                                                gender: bitem.gender,//性别
                                                birthday: bitem.birthday,//出生日期
                                                sort_order: bitem.sort_order,//受益顺序
                                                rate: bitem.rate,//受益比例
                                                type: SY_TYPE,//受益类型：身故
                                                ID_type_name: typename[bitem.ID_type]//证件类型名称
                                            })
                                        }
                                    }
                                }
                                //险种信息
                                if (!da.contentList.length) {
                                    safe_data = ''
                                    plus.storage.removeItem('zhaos_safegoods');
                                } else {
                                    var sitem = {}
                                    for (var s in da.contentList) {
                                        sitem = da.contentList[s]
                                        console.log(JSON.stringify(sitem))
                                        var pdata = {}
                                        pdata = {
                                            is_main: sitem.is_main,
                                            safe_id: sitem.product_id,
                                            code: sitem.code,
                                            safe_year: sitem.period_guanantee,
                                            pay_year: sitem.period_payment,
                                            money: sitem.amount, // 基本保险金额
                                            period_money: sitem.fee, // 年交保费
                                            name: sitem.product_name
                                        }
                                        if (sitem.is_main) {
                                            pdata.bcestype = da.insData.extend_items.bcestype//生存金领取方式 累计生息 现金领取
                                            pdata.BonusGetMode = sitem.extend_items.BonusGetMode//分红领取方式 累计生息 保额分红 现金领取
                                            pdata.autoApl = sitem.extend_items.autoApl === '1' ? true : false //是否自动垫交
                                        }
                                        safe_data.push(pdata)
                                    }
                                }
                                console.log()
                                //健康告知
                                if (!da.matterList.length) {
                                    health_data = ''
                                    plus.storage.removeItem('zhaos_healthinfo');
                                } else {
                                    var hitem = {}
                                    for(var h in da.matterList) {
                                        hitem = da.matterList[h]
                                        health_data.push({
                                            mv_id: hitem.mv_id,
                                            insured_answer: hitem.insured_answer.toString(),
                                            holder_answer: hitem.holder_answer.toString(),
                                            insured_fields: hitem.insured_fields,
                                            holder_fields: hitem.holder_fields
                                        })
                                    }
                                }
                                //银行信息
                                bank_data.agree = true
                                bank_data.bank_holder = da.insData.holder_name //户名
                                bank_data.bank_name = da.insData.bank_name //开户行
                                bank_data.temp_bank_name = da.insData.bank_name_text //开户行名称
                                bank_data.bank_type = da.insData.bank_type //账户类型
                                bank_data.temp_bank_type = da.insData.bank_type_text //账户类型名称
                                bank_data.bank_no = da.insData.bank_no//卡号
                                bank_data.bank_province = da.insData.bank_province
                                bank_data.bank_province_name = da.insData.bank_province_text
                                bank_data.bank_area = da.insData.bank_area
                                bank_data.bank_area_name = da.insData.bank_area_text
                                bank_data.bank_ss_name = da.insData.bank_province_text + ' ' + da.insData.bank_area_text
                                console.log(JSON.stringify(bank_data))
                                //证件照
                                for (var i in da.insData.img_json) {
                                    upload_data[i] = config.domain + da.insData.img_json[i]
                                }
                                //代理人告知
                                agent_data.applyProcessCode =  da.insData.extend_items.applyProcessCode
                                agent_data.process_name =  da.insData.apply_process_code_text
                                agent_data.durationType =  da.insData.extend_items.durationType //投保目的
                                agent_data.duration_name =  da.insData.duration_type_text
                                agent_data.insuredBadHabits =  da.insData.extend_items.insuredBadHabits === 'Y' ? true : false
                                agent_data.insuredPartTime =  da.insData.extend_items.insuredPartTime === 'Y' ? true : false
                                agent_data.insuredBodyAbnormity =  da.insData.extend_items.insuredBodyAbnormity === 'Y' ? true : false
                                agent_data.insuredBodyAbnormityDesc =  da.insData.extend_items.insuredBodyAbnormityDesc
                                agent_data.insuredSpecialAffinity =  da.insData.extend_items.insuredSpecialAffinity === 'Y' ? true : false
                                agent_data.otherRisk =  da.insData.extend_items.otherRisk === 'Y' ? true : false
                                agent_data.otherRiskDesc =  da.insData.extend_items.otherRiskDesc
                                agent_data.reasons =  da.insData.extend_items.reasons === 'Y' ? true : false
                                //存
                                plus.storage.setItem('zhaos_applicant',JSON.stringify(appl_data));
                                plus.storage.setItem('zhaos_assured',JSON.stringify(assu_data));
                                if (bene_data === 1) {
                                    plus.storage.setItem('zhaos_beneficiary', '1');
                                } else {
                                    bene_data && plus.storage.setItem('zhaos_beneficiary', JSON.stringify(bene_data));
                                }
                                safe_data && plus.storage.setItem('zhaos_safegoods', JSON.stringify(safe_data));
                                health_data && plus.storage.setItem('zhaos_healthinfo', JSON.stringify(health_data));
                                plus.storage.setItem('zhaos_bank', JSON.stringify(bank_data));
                                plus.storage.setItem('zhaos_upload', JSON.stringify(upload_data));
                                plus.storage.setItem('zhaos_agent', JSON.stringify(agent_data));
                                console.log('edit-over')
                                vm.getReadyItem();
                            }
                        }
                    })
                },
                //弹窗
                showpop:function(e) {
                    if (e === 2 && !this.applicant) {
                        mui.toast('请填写投保人信息', {duration: 'short', type: 'div'});
                        return false
                    } else if (e === 3 && !this.assured) {
                        mui.toast('请填写被保人信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 4 && !this.beneficiary) {
                        mui.toast('请填写受益人信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 5 && !this.safegoods) {
                        mui.toast('请填写险种信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 6 && !this.healthinfo) {
                        mui.toast('请填写健康告知信息', {duration: 'short', type: 'div'})
                        return false
                    } else if (e === 7 && !this.bank) {
                        mui.toast('请填写付款信息', {duration: 'short', type: 'div'})
                        return false
                    }
                    if (e === 5) {
                        plus.nativeUI.showWaiting();
                    }
                    showPopu(subpages[e-1] + '.html', 'zs-'+subpages[e-1], "bottom", index.init);
                }
            }
        });
        //保存数据更新
        window.addEventListener('saveFlag', function (e) {
            console.log('saveFlag')
            if (e.detail.clear) {
                plus.storage.removeItem('zhaos_safegoods')
                plus.storage.removeItem('zhaos_healthinfo')
                plus.storage.removeItem('zhaos_upload')
                index.getItem('zhaos_safegoods', 'safegoods')
                index.getItem('zhaos_healthinfo', 'healthinfo')
                index.getItem('zhaos_upload', 'upload')
            }
            index.getItem(e.detail.item,e.detail.data)

        });
        //整理下拉框需要的数据
        function dataToselect(data, type) {
            var arr = [];
            mui.each(data, function (ind, ite) {
                arr.push({
                    text: type ? ite.name : ite.enum_name,
                    value: ite.id
                });
            });
            return arr;
        }

        //初始化下拉数据获取
        luckyAjax({
            data: {
                data: JSON.stringify({'supplier_id': SCID}),
                server: 'PolicyIns.initPolicyField'
            },
            success: function (data) {
                if (data.code) {
                    var res = {}
                    var data = data.data;
                    mui.each(data, function (index, item) {
                        var itemdata = item.child;
                        if (item.cate === 'AA') {
                            res.ID_type = dataToselect(itemdata); //证件类型
                        } else if (item.cate === 'AB') {
                            res.gender = dataToselect(item.child); //性别
                        } else if (item.cate === 'BK') {
                            res.is_assured = dataToselect(item.child); //与投保人关系
                        } else if (item.cate === 'AD') {
                            res.marriage = dataToselect(item.child); //婚姻状况
                        } else if (item.cate === 'AE') {
                            res.occupation = dataToselect(item.child); //职业
                        } else if (item.cate === 'AF') {
                            res.annual_source = dataToselect(item.child);//收入来源
                        } else if (item.cate === 'AG') {
                            res.social_security = dataToselect(item.child); //是否有社保
                        } else if (item.cate === 'AH') {
                            res.tax_type = dataToselect(item.child); //税收类型
                        } else if (item.cate === 'AI') {
                            res.nation = dataToselect(item.child); //国籍
                        } else if (item.cate === 'AJ') {
                            res.drving_type = dataToselect(item.child); //驾照类型
                        } else if (item.cate === 'AL') {
                            res.resident_type = dataToselect(item.child); //居民类型
                        } else if (item.cate === 'AM') {
                            res.education = dataToselect(item.child); //学历
                        } else if (item.cate === 'AN') {
                            res.relation_beneficiary = dataToselect(item.child); //受益人与被保人关系
                        } else if (item.cate === 'AO') {
                            res.beneficiary_type = dataToselect(item.child); //受益人类型 法定 指定
                        } else if (item.cate === 'AP') {
                            res.benefit_type = dataToselect(item.child); //受益类型 身故
                        } else if (item.cate === 'AU') {
                            res.account_type = dataToselect(item.child); //银行卡账号类型
                        } else if (item.cate === 'AV') {
                            res.bank_code = dataToselect(item.child); //银行代码
                        } else if (item.cate === 'area') {
                            res.province = dataToselect(item.child, true); //省
                        } else if (item.cate === 'BA') {
                            res.sc_get_type = dataToselect(item.child); //生存金领取方式
                        } else if (item.cate === 'AZ') {
                            res.hl_get_type = dataToselect(item.child); //红利领取方式
                        }
                    });
                    index.init = res;
                }
            }
        });
        function checkStatus(war_id) {
            luckyAjax({
                data: {
                    data: JSON.stringify({policy_id: war_id}),
                    server: 'PolicyIns.policyDetails',
                    device: 'mobile'
                },
                success: function (res) {
                    console.log(JSON.stringify(res))
                    if (res.code) {
                        if (res.data.policyInfo.progress <= 1) {
                            index.getWarranty(war_id);
                        } else if (res.data.policyInfo.progress === 2) {
                            mui.toast('此单已承保，不能再次编辑', {duration: 'long', type: 'div'})
                            index.clearItem(true);
                            return false
                        }
                    } else {
                        mui.toast('保单不存在', {duration: 'short', type: 'div'})
                        index.clearItem()
                        return false
                    }
                }
            })
        }
        //返回
        document.querySelector('#backto').addEventListener('tap', function () {
            plus.webview.getWebviewById('member_life_order') && mui.fire(plus.webview.getWebviewById('member_life_order'), 'reload');
            if (index.pid) {
                index.clearItem(true);
            } else {
                mui.back();
            }
        })
        //重置
        document.querySelector('#resetData').addEventListener('tap', function () {
            index.$nextTick(function () {
                index.clearItem()
            })
        })
        //提交
        var i = 0;
        var pushdata = {};
        document.querySelector('#ins-save').addEventListener('click', function () {
            i = 0;
            index.loading = false;
            var war_id = index.ids ? Number(index.ids.policy_id) : ''
            setPushData(war_id);

        });

        var totalfee = 0
        //核保数据整理
        function setPushData(war_id) {
            console.log(JSON.stringify(index.applicant))
            plus.nativeUI.showWaiting();
            if (index.loading) {
                console.log('again')
                return false;
            }
            setTimeout(function () {
                plus.nativeUI.closeWaiting();
                index.loading = false;
                i = 0;
                index.getItem('zhaos_ids', 'ids');
            }, 15000)
            var toast_text = null
            if (!war_id) {
                war_id = ''
            }
            //保存前再次校验
            if (!index.applicant) {
                mui.toast('请填写投保人信息', {duration: 'short', type: 'div'});
                plus.nativeUI.closeWaiting();
                return false;
            }
            if (!checkAppl(index.applicant)) {
                plus.nativeUI.closeWaiting();
                return false;
            }
            if (!index.assured) {
                mui.toast('请填写被保人信息', {duration: 'short', type: 'div'});
                plus.nativeUI.closeWaiting();
                return false;
            }
            if (!RSChanged(index.assured, index.applicant)) {
                plus.nativeUI.closeWaiting();
                return false
            }
            if (!checkAssured(index.assured)) {
                plus.nativeUI.closeWaiting();
                return false
            }

            if (!index.beneficiary) {
                plus.nativeUI.closeWaiting();
                mui.toast('请填写受益人信息', {duration: 'short', type: 'div'});
                return false;
            }
            //
            if (!index.safegoods) {
                toast_text = '请填写险种信息';
            } else if (!index.healthinfo) {
                toast_text = '请填写健康告知信息';
            } else if (!index.bank) {
                toast_text = '请填写付款信息';
            } else if (!index.upload) {
                toast_text = '请上传证件';
            } else if (!index.agent) {
                toast_text = '请填写代理人告知';
            }
            if(toast_text){
                plus.nativeUI.closeWaiting();
                mui.toast(toast_text, {duration: 'short', type: 'div'});
                return false;
            }
            //
            index.loading = true;

            pushdata.id = war_id
            pushdata.supplier_id = SCID
            pushdata.ins_area = '323' //深圳
            pushdata.sales_channel = '2'
            pushdata.is_first = '1'
            pushdata.user_id = index.userinfo.id
            //投保人信息
            var applfieldFilter = ['holder_has_SSID', 'resident_type', 'temp_holder_job_code', 'mail_addr_type', 'holder_ID_type_name', 'holder_nation_name', 'holder_home_ssq_name', 'holder_home_province_name', 'holder_home_city_name', 'holder_home_district_name', 'holder_contact_ssq_name', 'holder_contact_province_name', 'holder_contact_city_name', 'holder_contact_district_name', 'holder_job_name', 'holder_isTaxResidents','sameToHome']
            for (var i in index.applicant) {
                if (applfieldFilter.indexOf(i) === -1) {
                    pushdata[i] = index.applicant[i]
                }
            }
            pushdata.holder_has_SSID = index.applicant.holder_has_SSID ? has_social_security : no_social_security
            //被保人信息
            var insured = {}
            insured.id = ''
            var assufieldFilter = ['insured_has_SSID', 'insured_temp_job_code', 'addr_type', 'insured_isTaxResidents', 'insured_job_name', 'insured_ID_type_name', 'insured_nation_name', 'insured_home_district_name', 'insured_home_ssq_name', 'insured_home_province_name', 'insured_home_city_name', 'insured_home_district_name', 'insured_contact_ssq_name', 'insured_contact_province_name', 'insured_contact_city_name', 'insured_contact_district_name']
            for (var i in index.assured) {
                if (assufieldFilter.indexOf(i) === -1) {
                    insured[i] = index.assured[i]
                }
            }
            insured.has_insured_SSID = index.assured.insured_has_SSID ? has_social_security : no_social_security
            pushdata.insured = insured
            //代理人告知
            var extend_items = {}
            var agentFilter = ['process_name', 'duration_name']
            for (var i in index.agent) {
                if (agentFilter.indexOf(i) === -1) {
                    if (index.agent[i] === true) {
                        extend_items[i] = 'Y'
                    } else if (index.agent[i] === false) {
                        extend_items[i] = 'N'
                    } else {
                        extend_items[i] = index.agent[i]
                    }
                }
            }
            //险种信息
            var content = []
            totalfee = 0
            mui.each(index.safegoods, function (index, item) {
                var safeitem = {}
                safeitem.is_main = item.is_main ? '1' : '0' //是主险
                safeitem.product_id = item.safe_id
                safeitem.period_payment = item.pay_year
                safeitem.period_guanantee = item.safe_year
                safeitem.fee = item.period_money
                safeitem.amount = item.money
                totalfee += Number(item.period_money)

                safeitem.extend_items = {
                    BonusGetMode: item.BonusGetMode,
                    level: ''
                }
                if (item.is_main) {
                    extend_items.bcestype = item.bcestype
                }
                console.log(item.code)
                if (item.code === hmzj) {
                    safeitem.extend_items.level = '1'
                }
                content.push(safeitem)
            })

            pushdata.total = totalfee.toFixed(2) //总保费
            pushdata.content = content
            //受益人信息
            pushdata.beneficiary = []
            if (index.beneficiary === 1) {
                pushdata.is_legal_benefic = '1'
            } else {
                pushdata.is_legal_benefic = '0'
                var benefieldFilter = ['ID_type_name', 'address_select'];
                for (var i in index.beneficiary) {
                    if (benefieldFilter.indexOf(i) === -1) {
                        pushdata.beneficiary.push(index.beneficiary[i])
                    }
                }
            }
            //银行信息
            var bankFilter = ['temp_bank_name', 'temp_bank_name','bank_ss_name','bank_province_name','bank_area_name','temp_bank_type']
            for (var i in index.bank) {
                if (bankFilter.indexOf(i) === -1) {
                    pushdata[i] =index.bank[i]
                }
            }
            pushdata.bank_holder = index.applicant.holder_name
            //健康告知
            pushdata.matter = index.healthinfo
            //影像
            pushdata.img_json = index.upload
            //

            extend_items.resident_type = index.applicant.resident_type;
            extend_items.isTaxResidents = index.applicant.holder_isTaxResidents;
            extend_items.isTaxResidentsInsured = index.assured.insured_isTaxResidents;
            extend_items.mail_addr_type = index.applicant.mail_addr_type ? '1' : '0'
            extend_items.addr_type = index.assured.addr_type ? '1' : '0'
            pushdata.extend_items = extend_items

            console.log('==================')
            console.log(JSON.stringify(pushdata))

            if (war_id) {
                console.log('deleteItem')
                war_id && deleteItem(war_id, '', 'content')
                war_id && deleteItem(war_id, '', 'beneficiary')
                war_id && deleteItem(war_id, '', 'matter_value')
            } else {
                save_ins(pushdata);
            }
        };
        //删除保存的某条数据
        function deleteItem(war_id, itemId, type) {
            luckyAjax({
                data: {
                    data: JSON.stringify({"table": type, "id": itemId, "policy_id": war_id}),
                    server: 'PolicyIns.deleteInsInfo'
                },
                closeWaiting: true,
                success: function (res) {
                    if (res.code) {
                        console.log('删除成功')
                        i++;
                        console.log('i:'+i)
                        if (i === 3) {
                            save_ins(pushdata);
                        }
                    } else {
                        plus.nativeUI.closeWaiting();
                        index.loading = false;
                        mui.toast('保存失败', {duration: 'long', type: 'div'})
                        return false
                    }
                }
            });
        }

        //保存保单
        function save_ins(data) {
            luckyAjax({
                data: {data: JSON.stringify(data), server: 'PolicyIns.save'},
                closeWaiting: true,
                timeout: 10000,
                success: function (res) {
                    if (res.code) {
                        plus.storage.setItem('zhaos_ids',JSON.stringify(res.data));
                        index.getItem('zhaos_ids', 'ids');
//                        showPopu('insurance-sign.html', 'zs-insurance-sign', "bottom",res.data.policy_id);
                        online_ins(res.data.policy_id)
                    } else {
                        plus.nativeUI.closeWaiting();
                        index.loading = false;
                        mui.toast(res.msg, {duration: 'short', type: 'div'})
                    }
                }
            });
        };
        //01核保
        function online_ins(war_id) {
            console.log('核保')
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {policy_id: war_id},
                        company_code: 'ZhaoShang',
                        method: 'insure'
                    }),
                    closeWaiting: true,
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 20000,
                success: function (res) {
                    if (!res.code) {
                        plus.nativeUI.closeWaiting();
                        index.loading = false;
                        mui.toast(res.msg || '网络出错，请稍后再试', {
                            duration: 'long',
                            type: 'div'
                        })
                        return false
                    } else if (res.data) {
                        if (res.data.flag === 'Y') {
                            if (res.data.isRulePass === 'Y') {
                                var sumPrem = res.data.sumPrem
                                if (parseInt(sumPrem) != parseInt(totalfee)) {
                                    plus.nativeUI.closeWaiting();
                                    index.loading = false;
                                    mui.toast('保费不一致！', {duration: 'long', type: 'div'})
                                    return false
                                } else {
                                    mui.toast('保存成功，核保中', {duration: 'long', type: 'div'})
                                    upload_img(war_id)
                                }
                            } else {
                                mui.toast(JSON.stringify(res.data.uwNotPassProblem), {duration: 'long', type: 'div'})
                                return false
                            }
                        } else if (res.data.flag === 'N') {
                            plus.nativeUI.closeWaiting();
                            index.loading = false;
                            mui.toast(JSON.stringify(res.data.message), {duration: 'long', type: 'div'})
                            return false
                        }
                    } else {
                        plus.nativeUI.closeWaiting();
                        index.loading = false;
                        mui.toast('网络出错，请稍后再试', {
                            duration: 'long',
                            type: 'div'
                        })
                        return false
                    }
                }
            });
        };
        //02上传影像
        function upload_img(id) {
            luckyAjax({
                data: {
                    data: JSON.stringify({
                        msg: {policy_id: id},
                        company_code: 'ZhaoShang',
                        method: 'update_img'
                    }),
                    server: 'PolicyIns.onlineInsured',
                    device: 'mobile'
                },
                timeout: 10000,
                success: function (res) {
                    if (!res.code) {
                        mui.toast(res.msg || '网络出错，请稍后再试', {
                            duration: 'long',
                            type: 'div'
                        })
                        return false
                    } else {
                        if (res.data.flag === 'Y') {
                            if (res.data.isUWPass === 'Y') {
                                mui.toast('自核通过', {duration: 'short', type: 'div'})
                                showPopu('insurance-sign.html', 'zs-insurance-sign', "bottom", {
                                    id: id,
                                    ispass: true,
                                    appSignAddress: res.data.appSignAddress,
                                    insuredSignAddress: res.data.insuredSignAddress ? res.data.insuredSignAddress : ''
                                });
                            } else if (res.data.isUWPass === 'N') {
                                mui.toast('进入人工核保', {duration: 'long', type: 'div'})
                                showPopu('insurance-sign.html', 'zs-insurance-sign', "bottom", {
                                    id: id,
                                    ispass: false,
                                    appSignAddress: res.data.appSignAddress,
                                    insuredSignAddress: res.data.insuredSignAddress ? res.data.insuredSignAddress : ''
                                });
                            }
                        } else if (res.data.flag === 'N') {
                            mui.toast(res.data.message, {duration: 'long', type: 'div'})
                            return false
                        } else {
                            mui.toast(res.data.message, {duration: 'long', type: 'div'})
                            return false
                        }
                    }
                }
            });
        };
        //
        document.querySelector('#temppop').addEventListener('click', function () {
            var war_id = index.ids ? Number(index.ids.policy_id) : ''
            showPopu('insurance-sign.html', 'zs-insurance-sign', "bottom", {
                id: war_id,
                appSignAddress: '',
                insuredSignAddress: ''
            });
        })
        //
        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            console.log('back')
            index.loading = false;
            i = 0;
            index.getItem('zhaos_ids', 'ids');
        });
        window.addEventListener('resetLoading', function () {
            index.loading = false;
            i = 0;
            index.getItem('zhaos_ids', 'ids');
        });

    })

</script>
</body>
</html>
