<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body>

<div id="Js-content" class="mui-content BL-rel">
    <!--弹窗 begin-->
    <div class="ins-dialog lg">
        <div class="dialog-header">
            <div class="mui-icon mui-icon-closeempty" id="close-ins-pop"></div>
            <p class="ins-font-md box-f-1">险种信息</p>
            <div class="header-btn-save">
                <button class="ins-btn sm-btn blue" id="saveGoods">保存</button>
            </div>
        </div>
        <div class="form-content margin-t-5_125 BL-pad-b-2" v-cloak>
            <div class="input-item BL-bg-fff">
                <div class="ins-lh-alone">总保费(元)</div>
                <div class="BL-ub BL-ub-pj BL-ub-f1">
                    <div class="input-wrap BL-ub-f1"></div>
                    <div class="ins-lh-alone BL-col-ff8201">{{totalFee}}</div>
                </div>
            </div>
            <div class="form-wrap">
                <div class="input-item">
                    <label class="">险种</label>
                    <div class="input-wrap box-f-1">
                        <div class="input" id="goods_type" @click="showType">
                            {{insurance.name}}
                        </div>
                        <div class="ins-down-icon"></div>
                    </div>
                </div>
            </div>
            <div class="BL-bg-fff BL-pad-b-1" v-show="insurance.safe_id">
                <div class="input-item ins-pd-r-0" style="margin-top: 0;" v-if="pay_year" v-cloak>
                    <label class="">交费期间</label>
                    <div class="input-wrap box-f-1 multi-btn">
                        <button class="ins-btn xs-btn" :class="{'blue':item.pay_year===insurance.pay_year}"
                                :disabled="item.pay_year===insurance.pay_year"
                                v-for="(item,index) in pay_year" @tap="insurance.pay_year=item.pay_year,resetMoney(),toblur()">
                            {{item.pay_year | payYearFilter}}
                        </button>
                    </div>
                </div>
                <div class="input-item ins-pd-r-0" v-if="safe_year" v-cloak>
                    <label class="">保险期间</label>
                    <div class="input-wrap box-f-1 multi-btn">
                        <button class="ins-btn xs-btn" :class="{'blue':item.year===insurance.safe_year}"
                                :disabled="item.year===insurance.safe_year"
                                v-for="(item,index) in safe_year"
                                @tap="insurance.safe_year=item.year,resetMoney(),toblur()">
                            {{item.year | safeYearFilter}}
                        </button>
                    </div>
                </div>
                <div class="input-item">
                    <label class="">基本保额(元)</label>
                    <div class="input-wrap box-f-1">
                        <input type="number" placeholder="请输入" v-model.number.lazy="insurance.money" @change="resetMoney()">
                    </div>
                </div>
                <div class="input-item">
                    <label class="">年缴保费(元)</label>
                    <div class="BL-ub BL-ub-pj BL-ub-f1">
                        <div class="input-wrap BL-ub-f1">
                            <input type="number" class="BL-col-ff8201" v-model.number.lazy=" insurance.period_money"
                                   readonly>
                        </div>
                        <div class="right-btn orange" @click="calMoney()">点击计算</div>
                    </div>
                </div>
            </div>

            <div class="form-wrap margin-t_875" v-show="hasAddons" v-for="(item,index) in Addons"
                 v-if="addonIns[index]">
                <div class="input-item box-f-1">
                    <div class="box-f-3 ins-font-sm">{{item.name}}</div>
                    <div class="form-switch-note">投保</div>
                    <div class="input-switch">
                        <input type="checkbox" class="switch" v-model="addonsSelected[index]" @change="chAddonState(index)"/>
                        <label></label>
                    </div>
                </div>
                <!--附加豁免保险费重大疾病保险-->
                <div class="mui-row form-bgc-eee BL-pad-a1" v-if="index==hmzj" v-show="addonsSelected[index]">
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保险金额(元)&nbsp;<span class="BL-col-ff8201">{{insurance.period_money}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保障期间(年)&nbsp;<span class="BL-col-ff8201">终身</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            交费期间(年)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].pay_year | payYearFilter}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            年缴保费(元)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].period_money}}</span>
                        </li>
                    </div>
                </div>
                <!--附加投保人豁免保险费定期寿险-->
                <div class="mui-row form-bgc-eee BL-pad-a1" v-if="index==tbrhmds" v-show="addonsSelected[index]">
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保险金额(元)&nbsp;<span class="BL-col-ff8201">{{insurance.period_money}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保障期间(年)&nbsp;<span class="BL-col-ff8201">终身</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            交费期间(年)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].pay_year | payYearFilter}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            年缴保费(元)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].period_money}}</span>
                        </li>
                    </div>
                </div>
                <!--附加投保人豁免保险费重大疾病保险-->
                <div class="mui-row form-bgc-eee BL-pad-a1" v-if="index==tbrhmzj" v-show="addonsSelected[index]">
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保险金额(元)&nbsp;<span class="BL-col-ff8201">{{insurance.period_money}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保障期间(年)&nbsp;<span class="BL-col-ff8201">终身</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            交费期间(年)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].pay_year | payYearFilter}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            年缴保费(元)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].period_money}}</span>
                        </li>
                    </div>
                </div>
                <!--附加爱倍护养老年金-->
                <div class="mui-row form-bgc-eee BL-pad-a1" v-if="index==ylnj" v-show="addonsSelected[index]">
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保险金额(元)&nbsp;<span class="BL-col-ff8201">{{insurance.period_money}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            保障期间(年)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].safe_year | safeYearFilter}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            交费期间(年)&nbsp;<span class="BL-col-ff8201">{{insurance.pay_year | payYearFilter}}</span>
                        </li>
                    </div>
                    <div class="mui-col-sm-6">
                        <li class="ins-font-xs">
                            年缴保费(元)&nbsp;<span class="BL-col-ff8201">{{addonIns[index].period_money}}</span>
                        </li>
                    </div>
                </div>
                <!--附加意外门急诊-->
                <template v-if="index==ywmjz">
                    <div class="input-item ins-pd-r-0">
                        <label class="">交费期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item ins-pd-r-0">
                        <label class="">保险期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">基本保额(元)</label>
                        <div class="input-wrap box-f-1">
                            <input type="number" placeholder="请输入" v-model.number.lazy="addonIns[index].money" @change="addonIns[index].period_money=''">
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">年缴保费(元)</label>
                        <div class="BL-ub BL-ub-pj BL-ub-f1">
                            <div class="input-wrap BL-ub-f1">
                                <input type="number" class="BL-col-ff8201"
                                       v-model.number.lazy="addonIns[index].period_money" readonly>
                            </div>
                            <div class="right-btn orange" @click="calMoney(index)">点击计算</div>
                        </div>
                    </div>
                </template>
                <!--附加住院每日补贴-->
                <template v-if="index==zybt">
                    <div class="input-item ins-pd-r-0">
                        <label class="">交费期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item ins-pd-r-0">
                        <label class="">保险期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">基本保额(元)</label>
                        <div class="input-wrap box-f-1">
                            <input type="number" placeholder="请输入" v-model.number.lazy="addonIns[index].money"
                                   @change="addonIns[index].period_money=''">
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">年缴保费(元)</label>
                        <div class="BL-ub BL-ub-pj BL-ub-f1">
                            <div class="input-wrap BL-ub-f1">
                                <input type="number" class="BL-col-ff8201"
                                       v-model.number.lazy="addonIns[index].period_money" readonly>
                            </div>
                            <div class="right-btn orange" @click="calMoney(index)">点击计算</div>
                        </div>
                    </div>
                </template>
                <!--附加住院补偿-->
                <template v-if="index==zybc">
                    <div class="input-item ins-pd-r-0">
                        <label class="">交费期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item ins-pd-r-0">
                        <label class="">保险期间</label>
                        <div class="input-wrap box-f-1">
                            <button class="ins-btn xs-btn blue" disabled>1年</button>
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">基本保额(元)</label>
                        <div class="input-wrap box-f-1">
                            <input type="number" placeholder="请输入" v-model.number.lazy="addonIns[index].money"
                                   @change="addonIns[index].period_money=''">
                        </div>
                    </div>
                    <div class="input-item">
                        <label class="">年缴保费(元)</label>
                        <div class="BL-ub BL-ub-pj BL-ub-f1">
                            <div class="input-wrap BL-ub-f1">
                                <input type="number" class="BL-col-ff8201"
                                       v-model.number.lazy="addonIns[index].period_money" readonly>
                            </div>
                            <div class="right-btn orange" @click="calMoney(index)">点击计算</div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
</div>
<!--弹窗 end-->

</div>
</body>
<script src="../js/mui.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="../js/mui.picker.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script src="../js/IDValidator.min.js"></script>
<script src="method.js"></script>
<script type="text/javascript">
    mui.init();
    var safegoods = new mui.PopPicker();

    var safe = new Vue({
        el: '#Js-content',
        data: function() {
            return {
                assu_age: '',
                appl_age: '',
                assured: {},
                applicant: {},
                init: {}, //初始化数据
                safegoods: null, //所有产品
                totalFee: 0,
                insurances: [], //保存的险种
                Addons: {}, //所有附加险
                hasAddons: false, //是否有附加险
                noSamePerson: true, //被保人非本人
                addonsSelected: {}, //附加险投保状态
                showAddonIns: {}, // 可投附加险
                addonIns: {},//附加险信息
                userinfo: {}, //用户信息
                pay_year: {}, //交费期间下拉数据
                safe_year: {},//保险期间下拉数据
                main_insurance: {},//主险信息
                insurance: { // 主险投保信息
                    is_main: 1,
                    name: '请选择',//主险名称
                    safe_id: '',//险种id
                    code: '', //险种代码
                    safe_year: '',
                    pay_year: '',
                    money: '', // 基本保险金额
                    period_money: '', // 年交保费
                    guarantee_term: '',//年金保障年限  20 30
                    draw_freq: '',//生存金领取方式 年领 月领
                    draw_age: '',//年金领取年龄
                    shareDrawType: '',//分红领取方式 累计生息 转入万能账户 现金领取
                    autoApl: false //是否自动垫交
                }
            }
        },
        //过滤器
        filters: {
            //保障期间
            safeYearFilter: function (value) {
                if (value > 50 && value !== '999' && value !== 999) {
                    return '至' + value + '周岁';
                } else if (value < 50 && value > 0) {
                    return value + '年';
                } else {
                    return '终身';
                }
            },
            //交费期间
            payYearFilter: function (value) {
                if (value === 1) {
                    return '趸交';
                } else if (value < 60) {
                    return value + '年交';
                } else {
                    return '至' + value + '周岁';
                }
            }
        },
        methods: {
            toblur:function(){
                document.activeElement.blur();
            },
            changeAddon: function (index, money) {
                this.addonIns[index].money = money
                this.addonIns[index].period_money = ''
                this.$forceUpdate()
            },
            // 重置主险信息
            resetMainIns: function () {
                this.insurance = {
                    is_main: 1,
                    safe_id: '',//险种id
                    code: '', //险种代码
                    safe_year: '',
                    pay_year: '',
                    money: '', // 基本保险金额
                    period_money: '', // 年交保费
                    guarantee_term: '',//年金保障年限
                    draw_freq: '',//生存金领取方式
                    draw_age: '',//年金领取年龄
                    shareDrawType: '',//分红领取方式
                    autoApl: false //是否自动垫交
                }
            },
            insChanged:function(init) {
                console.log('insChanged')
                const vm = this

                var safecode = vm.insurance.code
                //
                //保险期间
                var mainSyAttr = unique(vm.main_insurance.ratio, 'safe_year') // 去重
                // 排序
                mainSyAttr = mainSyAttr.sort(function (a, b) {
                    return a.safe_year - b.safe_year
                });

                //长度为1直接赋值，不为1置为空
                if (mainSyAttr.length === 1) {
                    vm.insurance.safe_year = mainSyAttr[0].year
                } else {
                    vm.insurance.safe_year = init ? vm.insurance.safe_year : ''
                }
                vm.safe_year = mainSyAttr;

                //交费期间
                var mainPyAttr = unique(vm.main_insurance.ratio, 'pay_year'); // 去重
                // 排序
                mainPyAttr = mainPyAttr.sort(function (a, b) {
                    return a.pay_year - b.pay_year;
                });
                if (mainPyAttr.length === 1) {
                    vm.insurance.pay_year = mainPyAttr[0].pay_year;
                } else {
                    vm.insurance.pay_year = init ? vm.insurance.pay_year : '';
                }
                vm.pay_year = mainPyAttr;
                //对应的附加险
                var child = vm.main_insurance.child
                var obj = {}
                for (var i in child) {
                    obj[child[i]['code']] = child[i]
                }
                vm.Addons = obj
                //
                if (init && vm.insurances.length > 0) {
                    console.log('初始化险种')
                    var insurance = vm.insurances[0]
                    console.log(JSON.stringify(vm.insurance))
                    if (safecode === insurance.code) {
                        vm.$nextTick(function(){
                            if (vm.insurances.length === 1) {
                                vm.calMoney()
                            }
                            vm.resetAddons(init)
                        })
                        return
                    }
                } else {
                    // 清除附加险
                    vm.resetMoney()
                }
            },
            //主险change
            showType: function () {
                var vm = this
                safegoods.show(function (items) {
                    vm.resetMainIns(); //重置主险信息
                    vm.insurance.safe_id = items[0].value;
                    vm.insurance.code = items[0].code;
                    vm.insurance.name = items[0].text;
                    vm.main_insurance = items[0];
                    vm.insChanged();
                });
            },
            resetAddons: function (init) {
                console.log('resetAddons' + init)
                var vm = this
                var safe_id = vm.insurance.code
                var money = vm.insurance.money
                var pay_year = vm.insurance.pay_year
                var period_money = vm.insurance.period_money
//                console.log('重置对应附加险' + safe_id + safe_year + pay_year + money + period_money);
                for (var a in vm.addonsSelected) {
                    vm.addonsSelected[a] = false
                }
                var tempdata = {}
                switch (safe_id) {
                    case abh: //爱倍护
                        tempdata[hmzj] = true //附加豁免保险费重大疾病保险
                        tempdata[tbrhmds] = vm.noSamePerson //附加投保人豁免保险费定期寿险
                        tempdata[tbrhmzj] = vm.noSamePerson //附加投保人豁免保险费重大疾病保险
                        tempdata[ylnj] = true //附加爱倍护养老年金
                        tempdata[zybc] = true //附加住院补偿
                        tempdata[zybt] = true //附加住院每日补贴
                        tempdata[ywmjz] = true //附加意外门急诊
                        vm.showAddonIns = tempdata
                        break
                }
                vm.$nextTick(function () {
                    return vm.setAddonsShow(init)
                });
            },
            setAddonsShow: function (init) {
                console.log('setAddonsShow')
                var vm = this
                var hasAddons = false
                for (var i in vm.showAddonIns) {
//                    console.log(i)
                    if (vm.showAddonIns[i] === true) {
//                        console.log('true')
                        hasAddons = true
                        if (vm.Addons[i]) {
                            vm.setAddons(i, init)
                        }
                    }
                }
                vm.hasAddons = hasAddons
                vm.$forceUpdate();
            },
            setAddons: function (i, init) {
                console.log('setAddons' + i + 'init:' + init)
                var vm = this
                var tml = {
                    safe_id: vm.Addons[i].id, //险种
                    code: i, //险种
                    safe_year: '', //保险期间
                    pay_year: '', //交费年期
                    money: '', //基本保险金额
                    period_money: '' //年缴保费
                }
                console.log(i + ', 是否初始化：' + init)
                if (hmx.indexOf(i) > -1) {
                    tml.pay_year = vm.insurance.pay_year - 1
                    vm.Addons[i].attr2 = unique(vm.Addons[i].ratio, 'safe_year')
                    if (i === tbrhmds) {
                        tml.safe_year = vm.insurance.pay_year
                    } else {
                        tml.safe_year = vm.insurance.safe_year
                    }
                    tml.money = vm.insurance.period_money
                } else if (i == ylnj) {
                    tml.safe_year = 85
                    tml.pay_year = vm.insurance.pay_year
                    tml.money = vm.insurance.money
                } else {
                    if (vm.Addons[i].ratio.length === 1) {
                        tml.safe_year = vm.Addons[i].ratio[0].year
                        tml.pay_year = vm.Addons[i].ratio[0].pay_year
                    }
                    tml.money = ''
                }
                vm.addonIns[i] = tml
                console.log(JSON.stringify(tml))
                if (init) {
                    console.log('设置附加险,ID:' + i +'init:'+init)
                    var kitem = {}
                    for (var k in vm.insurances) {
                        kitem = vm.insurances[k]
                        if (k > 0 && kitem.code === i) {
                            vm.addonsSelected[kitem.code] = true
                            console.log('act')

                            vm.addonIns[kitem.code] = {
                                safe_id: kitem.safe_id,
                                code: kitem.code,
                                safe_year: kitem.safe_year,
                                pay_year: kitem.pay_year,
                                money: parseInt(kitem.money),
                                period_money: kitem.period_money
                            }
                            vm.calMoney(i)
                        }
                    }
                }
            },
            chAddonState: function (index) {
                console.log('chAddonState')
                var vm = this
                if (!vm.addonIns[index]) return
                this.$nextTick(function () {
                    console.log('-------------')
                    if (!vm.addonsSelected[index]) {
                        console.log('ddddd')
                        vm.setAddons(index)
                    }
                    var toast_text = null
                    var name = vm.Addons[index].name
                    var safe_id = vm.insurance.code
                    switch (index) {
                        case tbrhmds:
                        case tbrhmzj:
                            if (!this.noSamePerson && vm.addonsSelected[index]) {
                                toast_text = '投保人和被保人是同一人时，不能附加' + name
                                vm.addonsSelected[index] = false
                            }
                            vm.isExempted = vm.addonsSelected[index]
                            vm.healthinfoOk = false
                            break
                        default:
                            break
                    }
                    if (toast_text) {
                        mui.toast(toast_text, {duration: 'short', type: 'div'});
                        vm.addonsSelected[index] = false
                        return false
                    } else {
                        console.log('2')
                        if (vm.addonsSelected[index] && !vm.addonIns[index].period_money) {
                            vm.calMoney(index)
                        }
                    }
                    vm.countFee()
                    vm.$forceUpdate()
                })
            },
            countFee: function () {
                var sum = 0
                if (this.insurance.period_money) {
                    sum += Number(this.insurance.period_money)
                }
                for (var i in this.addonsSelected) {
                    if (this.addonsSelected[i]) {
                        sum += Number(this.addonIns[i].period_money)
                    }
                }
                this.count = sum
            },
            resetMoney: function (i) {
                i = (i || this.insurance.code).toString()
//                console.log('重置【' + i + '】附加险')
                this.insurance.period_money = ''
                // 附加险重置
                this.hasAddons = false
                this.addonsSelected = {}
                this.addonIns = {}
                this.$forceUpdate()
            },
            checkAge: function (index) {
                var toast_text = null
                var pay_year = this.insurance.pay_year
                var age = this.assu_age
                var assutoage = Number(this.insurance.pay_year) + Number(age)
                var applAge = this.appl_age
                var appltoage = Number(this.insurance.pay_year) + Number(applAge)
                var id = index === 0 ? this.insurance.code : index
                var name = this.Addons[id] ? this.Addons[id].name : this.insurance.name

                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    return false
                }

                if (!id) return false
                switch (id) {
                    case abh: // 爱倍护
                    case ylnj: //附加爱倍护养老年金
                        if ([3, 5, 10, 15, 20].indexOf(pay_year) > -1 && assutoage > 60) {
                            toast_text = '交费期满年龄不能大于60周岁'
                        }
                        break
                    case hmzj: // 附加豁免保险费重大疾病保险
                    case tbrhmzj: // 附加投保人豁免保险费重大疾病保险
                        if (applAge > 60) {
                            toast_text = '投保人年龄大于60周岁不能附加【' + name + '】'
                        } else if (appltoage - 1 > 60) {
                            toast_text = '附加【' + name + '】时，投保人交费期满年龄不能大于60周岁'
                        }
                        if (toast_text) {
                            mui.toast(toast_text, {duration: 'short', type: 'div'});
                            return false
                        }
                        break
                    case tbrhmds: //附加投保人豁免保险费定期寿险
                        if (applAge > 65) {
                            toast_text = '投保人年龄大于65周岁不能附加【' + name + '】'
                        } else if (appltoage - 1 > 70) {
                            toast_text = '附加【' + name + '】时，投保人交费期满年龄不能大于70周岁'
                        }
                        break
                    default:
                        break
                }
                if (toast_text) {
                    mui.toast('【' + name + '】的' + toast_text, {duration: 'short', type: 'div'});
                    return false
                }
                return true
            },
            checkForm: function () {
//                console.log('checkform');
                const vm = this
                var toast_text = null
                var id = vm.insurance.code
                if (!id) {
                    toast_text = '请选择险种'
                } else if (!vm.insurance.pay_year) {
                    toast_text = '请选择交费期间'
                } else if (!vm.insurance.safe_year) {
                    toast_text = '请选择保险期间'
                } else if (!vm.checkAge(0)) {
                    return false
                } else if (!vm.insurance.money) { //保额
                    toast_text = '请填写基本保险金额'
                }
                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    return false
                }
                return vm.checkMoney()
            },
            checkMoney: function() {
                var money = Number(this.insurance.money)
                var period_money = Number(this.insurance.period_money)
                var name = this.insurance.name
                var toast_text = null
                switch (this.insurance.code) {
                    case abh: // 爱倍护重疾
                        if (money < 10000) {
                            toast_text = '【' + name + '】的最低保额为1万元'
                        } else if (money % 1000 !== 0) {
                            toast_text = '【' + name + '】的保额需为1千元整数倍'
                        }
                        break
                }
                if (toast_text) {
                    mui.toast(toast_text, {duration: 'long', type: 'div'});
                    return false
                }
                return true
            },
            calMoney: function (index) {
                document.activeElement.blur();
                var vm = this
                var safe_code = index ? vm.addonIns[index].code : vm.insurance.code
                var genre = '';
                luckyAjax({
                    data: {
                        server: 'Proposal.getProductInfo',
                        device: 'mobile',
                        view: false,
                        data: JSON.stringify({
                            code: safe_code,
                            id: ''

                        })
                    },
                    timeout: 50000,
                    success: function(res) {
                        if(res.code == 1) {
                            genre = res.data.id
                            vm.toCal(index, genre)
                        } else {
                            mui.toast('加载失败')
                        }
                    }
                });
            },
            //试算
            toCal: function (index, genre) {
                console.log('试算中');
                var vm = this
                if (!vm.checkForm()) {
                    return false
                }
                //
                var safe_year = index ? vm.addonIns[index].safe_year : vm.insurance.safe_year
                var ssid = vm.assured.insured_has_SSID ? '1' : '2'
                console.log(JSON.stringify(vm.applicant))
                var basedata = {}
                basedata.user_id = vm.userinfo.id
                basedata.applicant = vm.applicant.holder_name
                basedata.appl_sex = vm.applicant.holder_gender === MALE ? 1 : 2
                basedata.appl_age = vm.appl_age
                basedata.assured = vm.assured.insured_name
                basedata.assu_sex = vm.assured.insured_gender === MALE ? 1 : 2
                basedata.assu_age = vm.assu_age
                basedata.pay_year = index ? vm.addonIns[index].pay_year : vm.insurance.pay_year
                basedata.safe_year = safe_year == '999' ? 0 : safe_year
                basedata.warranty_year = 1
                basedata.genre = genre
                basedata.fj = index ? true : false
                basedata.derate_money = 0
                basedata.need_packet = 0
                basedata.flag = 0
                basedata.check = 0
                basedata.alias = null
                basedata.base_money = index ?  Number(vm.addonIns[index].money) : Number(vm.insurance.money)
                basedata.is_save = 0
                if (index) {
                    basedata.year_fee = vm.addonIns[index].period_money
                    if (!vm.checkAddonsForm(index)) {
                        return false
                    }
                }
                if (['1003'].indexOf(index) > -1) {
                    basedata.assume_rate = '0';
                    basedata.sa_one = '0';
                    basedata.fa_one = '0';
                    basedata.money_one = '0';
                    basedata.sa_two = '0';
                    basedata.fa_two = '0';
                    basedata.money_two = '0';
                    basedata.sa_three = '0';
                    basedata.fa_three = '0';
                    basedata.money_three = '0';
                    basedata.sa_four = '0';
                    basedata.fa_four = '0';
                    basedata.money_four = '0';
                    basedata.sa_five = '0';
                    basedata.fa_five = '0';
                    basedata.money_five = '0';
                    basedata.sa_six = '0';
                    basedata.fa_six = '0';
                    basedata.money_six = '0';
                    basedata.sa_seven = '0';
                    basedata.fa_seven = '0';
                    basedata.money_seven = '0';
                    basedata.sa_eight = '0';
                    basedata.fa_eight = '0';
                    basedata.money_eight = '0';
                    basedata.sa_night = '0';
                    basedata.fa_night = '0';
                    basedata.money_night = '0';
                    basedata.sa_ten = '0';
                    basedata.fa_ten = '0';
                    basedata.money_ten = '0'

                    //附加爱倍护养老年金保险
                    basedata.safe_year = 8500
                    basedata.njy = this.insurance.period_money * this.insurance.pay_year
                }
                if (index === ywmjz) {
                    basedata.assu_sex = 0
                    basedata.flag = ssid + vm.assured.insured_job_cate
                } else if ([zybc, zybt].indexOf(index) > -1) {
                    basedata.assu_sex = 0
                    basedata.flag = vm.assured.insured_job_cate
                } else if (hmx.indexOf(index) > -1) {
                    if (vm.addonsSelected[ylnj]) {
                        basedata.base_money += vm.addonIns[ylnj].money
                    }
                    if (index === tbrhmds) {
                        basedata.safe_year = this.insurance.pay_year
                    }
                }
                var postData = JSON.stringify({
                    safes: JSON.stringify([basedata])
                })
                console.log(postData)
                //开始试算
                luckyAjax({
                    data: {
                        data: postData,
                        server: 'Proposal.add',
                        device: 'mobile'
                    },
                    timeout: 50000,
                    success: function (ret) {
                        if (index) {//附加险
                            if (ret.data.data &&
                                ret.data.data[-1][genre] &&
                                ret.data.data[-1][genre].main &&
                                ret.data.data[-1][genre].main.list &&
                                ret.data.data[-1][genre].main.list[1]) { // 附加险
                                if (index == ylnj) {
                                    vm.addonsSelected[hmzj] = false
                                }
                                var res = ret.data.data[-1][genre].main
                                var data = {}
                                mui.each(res.describes, function (index, item) {
                                    data[item.title] = res.list[1][index]
                                })
                                console.log(JSON.stringify(data))
                                vm.addonIns[index].period_money = data['年缴保费']
                                vm.countFee()
                            } else {
                                mui.toast('网络出错，请稍后再试', {duration: 'short', type: 'div'});
                                return false;
                            }
                        } else {//主险
                            if (ret.data.data &&
                                ret.data.data[0][genre] &&
                                ret.data.data[0][genre].main &&
                                ret.data.data[0][genre].main.list &&
                                ret.data.data[0][genre].main.list[1]) {
                                var i = 0;
                                var j = 0;
                                var ret = ret.data.data[0][genre].main
                                mui.each(ret.describes, function (index, item) {
                                    if (ret.describes[index].title == '年缴保费') {
                                        i = index
                                    }
                                    if (ret.describes[index].title == '保险金额') {
                                        j = index
                                    }
                                })
                                var data = ret.list[1]
                                vm.insurance.period_money = data[i]
                                // 重置附加险
                                vm.resetAddons();
                                vm.countFee()
                            } else {
                                mui.toast('网络出错，请稍后再试', {duration: 'short', type: 'div'});
                                return false;
                            }
                        }
                    }
                });
            },
            checkAddonsForm: function (index) {
                console.log('附加险表单校验' + index)
                var addon = this.addonIns[index]
                var name = this.Addons[index].name
                var toast_text = null
                if (!addon.safe_year) {
                    toast_text = '请选择【' + name + '】的保险期间'
                } else if (!addon.pay_year) {
                    toast_text = '请选择【' + name + '】的交费期间'
                } else if (!addon.money && hmx.indexOf(index) === -1) {
                    toast_text = '请填写【' + name + '】的基本保险金额'
                } else if (!this.noSamePerson && [tbrhmds, tbrhmzj].indexOf(index) > -1) {
                    toast_text = '投保人和被保人是同一人时，不能附加' + name
                }

                if (toast_text) {
                    mui.toast(toast_text, {duration: 'short', type: 'div'});
                    this.addonsSelected[index] = false
                    return false
                }
                return this.checkAddonMoney(index) && this.checkAge(index)
            },
            checkAddonMoney: function (index) {
                var toast_text = null
                var period_money = Number(this.insurance.period_money)
                var mainMoney = Number(this.insurance.money)

                var name = '【' + this.Addons[index].name + '】'
                var money = +this.addonIns[index].money
//                console.log(index + money + '校验附加险保额')
                switch (index) {
                    case ylnj: // 附加爱倍护养老年金
                        if (money < 10000) {
                            toast_text = '最低保额为1万元'
                        } else if (money % 1000 !== 0) {
                            toast_text = '保额需为1千元整数倍'
                        }
                        break
                    case ywmjz: // //附加意外门急诊
                        if (money < 5000) {
                            toast_text = '最低保额为5千元'
                        }else if (money > 30000) {
                            toast_text = '最高保额为3万元'
                        }
                        break
                    case zybc: // 附加住院补偿
                        if (money < 5000) {
                            toast_text = '最低保额为5千元'
                        } else if (money > 50000) {
                            toast_text = '最高保额为5万元'
                        }
                        break
                    case zybt: // 附加住院每日补贴
                        if (money < 30) {
                            toast_text = '最低保额为30元/天'
                        } else if (money > 500) {
                            toast_text = '最高保额为500元/天'
                        }
                        break
                    default:
                        break
                }
                if (toast_text) {
                    mui.toast(name + toast_text, {duration: 'short', type: 'div'});
                    this.addonsSelected[index] = false
                    return false
                }
                return true
            },
            countFee: function() {
                var sum = 0
                if (this.insurance.period_money) {
                    sum += Number(this.insurance.period_money)
                }
                for (var i in this.addonsSelected) {
                    if (this.addonsSelected[i]) {
                        sum += Number(this.addonIns[i].period_money)
                    }
                }
                this.totalFee = sum.toFixed(2)
            }
        }
    });

    mui.plusReady(function () {
        var popu = new ClosePopu(); // 实例化关闭窗口对象
        var userinfo = JSON.parse(plus.storage.getItem('userinfo'));
        safe.userinfo = userinfo;

        var init = plus.webview.currentWebview().data;
        safe.init = init;
//
        var applicant = plus.storage.getItem('zhaos_applicant') ? JSON.parse(plus.storage.getItem('zhaos_applicant')) : ''
        var assured = plus.storage.getItem('zhaos_assured') ? JSON.parse(plus.storage.getItem('zhaos_assured')) : ''
        var goods = plus.storage.getItem('zhaos_safegoods') ? JSON.parse(plus.storage.getItem('zhaos_safegoods')) : ''
        console.log('+++++++++++++')
        console.log(plus.storage.getItem('zhaos_safegoods'))
        if(goods){
            safe.insurances = goods
            mui.each(goods,function (index,item) {
                if(item.is_main){
                    safe.insurance = deepClone(item)
                }
            })
        }

        safe.assu_age = getAge(assured.insured_birthday)
        safe.appl_age = getAge(applicant.holder_birthday)
        safe.applicant = applicant
        safe.assured = assured
        safe.noSamePerson = assured.rel_insured_holder === ISASSURED ? false : true;
//
        getIns(); //获取险种列表
        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            popu.closepop();
        });
        //保存
        document.querySelector('#saveGoods').addEventListener('tap', function () {
            document.activeElement.blur();
            if (!safe.checkForm()) {
                return false
            }
            if (!safe.insurance.period_money) {
                mui.toast('请先点击计算主险的年交保费', {duration: 'short', type: 'div'});
                return false
            }
            // 附加险
            var addonIns = []
            var countAddon = 0 // 险种个数
            for (var k in safe.addonsSelected) {
                if (safe.addonsSelected[k] === true) {
                    var name = safe.Addons[k].name
                    countAddon += 1
                    if (safe.checkAddonsForm(k)) {
                        if (!safe.addonIns[k].period_money) {
                            mui.toast('请计算【' + name + '】的年缴保费', {duration: 'short', type: 'div'});
                            return false
                        }
                        addonIns.push(safe.addonIns[k])
                    } else {
                        return false
                    }
                }
            }
            if (!safe.addonsSelected[hmzj]) {
                mui.toast('招商仁和【附加豁免保险费重大疾病保险】为必选', {duration: 'long', type: 'div'});
                return false
            }
            //
            var insurances = []
            insurances.push(safe.insurance);
            safe.addonIns && mui.each(safe.addonIns, function (index, item) {
                if (safe.addonsSelected[item.code]) {
                    insurances.push(item)
                }
            })
            plus.storage.setItem('zhaos_safegoods', JSON.stringify(insurances));
//            console.log(JSON.stringify(plus.storage.getItem('zhaos_safegoods')))
            mui.fire(plus.webview.getWebviewById('zs_insurance-index'), 'saveFlag', {
                item: 'zhaos_safegoods',
                data: 'safegoods'
            });
            popu.closepop();
            mui.back();
        })
        //
        mui('body').on('tap', '#close-ins-pop', function () {
            // 关闭遮罩层，弹框
            popu.closepop();
        });
        //获取险种列表
        function getIns() {
            console.log('getInslist')
            luckyAjax({
                data: {
                    data: JSON.stringify({'supplier_id': SCID}),
                    server: 'PolicyIns.getProductList'
                }, //获取险种列表
                success: function (res) {
                    if (res.code == 1) {
                        var data = []
                        safe.safegoods = res.data;
                        console.log(JSON.stringify(safe.safegoods))
                        mui.each(res.data, function (index, item) {
                            if (onlineIns.indexOf(item.code) > -1) {
                                data.push({
                                    value: item.id,
                                    text: item.name,
                                    ratio: item.ratio,
                                    child: item.child,
                                    code: item.code
                                })
                            }
                        });
                        console.log(JSON.stringify(safe.insurances))
                        safegoods.setData(data);
                        //
                        mui.each(data, function (index, item) {
                            for (var k in safe.insurances) {
                                var kitem = safe.insurances[k]
                                if (kitem.is_main && item.code === kitem.code) {
                                    safe.main_insurance = item
                                    console.log('11111')
                                    safe.insChanged(true)
                                }
                            }
                        });
                        //
                    } else {
                        mui.toast('加载失败', {duration: 'short', type: 'div'});
                        return false;
                    }
                }
            });
        }
    });
    //去重
    const unique = function (a, key) {
        var res = [];
        for (var i = 0, len = a.length; i < len; i++) {
            for (var j = 0, jLen = res.length; j < jLen; j++) {
                if (res[j][key] === a[i][key]) {
                    break;
                }
            }
            if (j === jLen) {
                res.push(a[i]);
            }
        }
        return res;
    };
</script>

</html>