<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link href="../css/common.css" rel="stylesheet"/>
    <link href="../css/module.css" rel="stylesheet"/>
    <link href="../css/form.css" rel="stylesheet"/>
    <link href="../css/insurance.css" rel="stylesheet"/>
    <script src="../js/config.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css"/>
</head>

<body>

<div id="Js-content" class="mui-content BL-rel">
    <!--弹窗 begin-->
    <div class="ins-dialog md">
        <div class="dialog-header">
            <div class="mui-icon mui-icon-closeempty" id="close-ins-pop"></div>
            <p class="ins-font-md box-f-1">上传证件</p>
            <div class="header-btn-save">
                <button class="ins-btn sm-btn blue" id="saveUpload">保存</button>
            </div>
        </div>
        <div class="form-content margin-t-6_125 BL-pad-b-1">
            <div class="form-wrap">
                <div class="mui-row form-row">
                    <template v-if="applicant.holder_ID_type===IDcard">
                        <div class="mui-col-sm-6 BL-mar-b-1" >
                            <div class="BL-txt-c">
                                <div class="form-upload BL-mar-r-1" model="appl_front_img" :style="previewImg[0]"
                                     data-id="0">
                                    <div class="form-upload-img"></div>
                                </div>
                                <span class="form-p BL-col-999">投保人身份证正面</span>
                            </div>
                        </div>
                        <div class="mui-col-sm-6 BL-mar-b-1">
                            <div class="BL-txt-c">
                                <div class="form-upload BL-mar-l-1" model="appl_negative_img" :style="previewImg[1]"
                                     data-id="1">
                                    <div class="form-upload-img"></div>
                                </div>
                                <span class="form-p BL-col-999">投保人身份证反面</span>
                            </div>
                        </div>
                    </template>
                    <div class="mui-col-sm-6 BL-mar-b-1" v-else>
                        <div class="BL-txt-c">
                            <div class="form-upload BL-mar-l-1" model="appl_front_img" :style="previewImg[0]"
                                 data-id="0">
                                <div class="form-upload-img"></div>
                            </div>
                            <span class="form-p BL-col-999">投保人证件</span>
                        </div>
                    </div>
                    <template v-if="assured.rel_holder_insured!==ISASSURED">
                        <template v-if="assured.insured_ID_type===IDcard">
                            <div class="mui-col-sm-6 BL-mar-b-1" >
                                <div class="BL-txt-c">
                                    <div class="form-upload BL-mar-r-1" model="assu_front_img" :style="previewImg[2]"
                                         data-id="2">
                                        <div class="form-upload-img"></div>
                                    </div>
                                    <span class="form-p BL-col-999">被保人身份证正面</span>
                                </div>
                            </div>
                            <div class="mui-col-sm-6 BL-mar-b-1">
                                <div class="BL-txt-c">
                                    <div class="form-upload BL-mar-l-1" model="assu_negative_img" :style="previewImg[3]"
                                         data-id="3">
                                        <div class="form-upload-img"></div>
                                    </div>
                                    <span class="form-p BL-col-999">被保人身份证反面</span>
                                </div>
                            </div>
                        </template>
                        <div class="mui-col-sm-6 BL-mar-b-1" v-else>
                            <div class="BL-txt-c">
                                <div class="form-upload BL-mar-l-1" model="assu_front_img" :style="previewImg[2]"
                                     data-id="2">
                                    <div class="form-upload-img"></div>
                                </div>
                                <span class="form-p BL-col-999">被保人证件</span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
<!--弹窗 end-->
</div>
</body>
<script src="../js/mui.min.js" type="text/javascript"></script>
<script src="../js/vue.min.js" type="text/javascript"></script>
<script src="method.js" type="text/javascript"></script>
<script type="text/javascript">
    mui.init();
    var popu;

    var img = new Vue({
        el: '#Js-content',
        data: {
            applicant: {},
            assured: {},
            previewImg: [], //上传图片
            appl_front_img: '',   // 投保人身份证正面
            assu_front_img: '',   // 被保人身份证正面
            appl_negative_img: '', // 投保人身份证反面
            assu_negative_img: '' // 被保人身份证反面
        },
        methods: {
            sure: function () {
                var toastText = null
                if (this.applicant.holder_ID_type === IDcard) {
                    if (!this.appl_front_img) {
                        toastText = '请上传投保人身份证正面照片'
                    } else if (!this.appl_negative_img) {
                        toastText = '请上传投保人身份证反面照片'
                    }
                } else if (!img.appl_front_img) {
                    toastText = '请上传投保人证件'
                }
                if (this.assured.rel_holder_insured !== ISASSURED) {
                    if (this.assured.insured_ID_type === IDcard && !img.assu_front_img) {
                        toastText = '请上传被保人身份证正面照片'
                    } else if (this.assured.insured_ID_type === IDcard && !img.assu_negative_img) {
                        toastText = '请上传被保人身份证反面照片'
                    } else if (!img.assu_front_img) {
                        toastText = '请上传被保人证件'
                    }
                }
                if (toastText) {
                    mui.toast(toastText, {duration: 'short', type: 'div'})
                    return false;
                }
                return true
            }
        }
    })
    // 图片字段名
    const fileName = [
        'appl_front_img',
        'appl_negative_img',
        'assu_front_img',
        'assu_negative_img'
    ]
    mui.plusReady(function () {
        popu = new ClosePopu(); // 实例化关闭窗口对象
        var upload = plus.storage.getItem('zhaos_upload') ? JSON.parse(plus.storage.getItem('zhaos_upload')) : ''
        console.log(JSON.stringify(upload))
        var assured = plus.storage.getItem('zhaos_assured') ? JSON.parse(plus.storage.getItem('zhaos_assured')) : ''
        console.log(JSON.stringify(assured))
        img.assured = assured
        var applicant = plus.storage.getItem('zhaos_applicant') ? JSON.parse(plus.storage.getItem('zhaos_applicant')) : ''
        img.applicant = applicant
        //赋值
        var tempName = {
            '11800': 'appl_front_img',
            '11801': 'appl_negative_img',
            '11810': 'assu_front_img',
            '11811': 'assu_negative_img'
        }
        var index = {
            '11800': 0,
            '11801': 1,
            '11810': 2,
            '11811': 3
        }
        for (var i in tempName) {
            if (upload && upload[i]) {
                img[tempName[i]] = upload[i]
                console.log(img[tempName[i]])
                img.$set(img.previewImg, index[i], {
                    'backgroundImage': 'url(' + upload[i] + ')'
                })
            }
        }

        //安卓监听返回事件
        plus.key.addEventListener("backbutton",function(){
            popu.closepop();
        });
        //保存
        document.querySelector('#saveUpload').addEventListener('tap', function () {
            if (!img.sure()) {
                return false
            }
            var img_json = {}
            img_json['11800'] = img.appl_front_img
            img_json['11801'] = img.appl_negative_img
            img_json['11810'] = img.assu_front_img
            img_json['11811'] = img.assu_negative_img
            plus.storage.setItem('zhaos_upload', JSON.stringify(img_json));
            mui.fire(plus.webview.getWebviewById('zs_insurance-index'), 'saveFlag', {
                item:'zhaos_upload',
                data: 'upload'
            });
            popu.closepop();
            mui.back();
        })
        //
        mui('body').on('tap', '#close-ins-pop', function () {
            // 关闭遮罩层，弹框
            popu.closepop();
        });

        mui('body').on('tap', '.form-upload', function (e) {
            var id = this.getAttribute('data-id')
            // 打开遮罩层，弹框
            showPopu("upload-img.html", "upload_img", "bottom", {id: id});
        });
    });

    //获取要上传的头像
    window.addEventListener('uploadimg', function (event) {
        console.log(event.detail.id)
        img[fileName[event.detail.id]] = event.detail.img
        img.$set(img.previewImg, event.detail.id, {
            'backgroundImage': 'url(' + event.detail.img + ')'
        })
    })
</script>

</html>